import { array } from "../pipes.class";
import { ElementRef, ContentChildren, TemplateRef, Component, Input, Output, EventEmitter } from "@angular/core";
import { TemplateReader } from "../TemplateReader.class";
import { string as ackOptions } from "./templates/ack-options.pug";
export class AckOptions {
    constructor(ElementRef) {
        this.ElementRef = ElementRef;
        this.array = [];
        this.stylize = true;
        this.TemplateReader = new TemplateReader({
            lastTemplateName: "templateRef",
            types: {
                option: "templateRef",
                selected: "selected"
            }
        });
        this.modelChange = new EventEmitter();
    }
    ngAfterViewInit() {
        Promise.resolve().then(() => {
            if (this.inputTemplateRefs) {
                this.TemplateReader.readTemplates(this.inputTemplateRefs);
            }
            if (this.templateRefs) {
                this.TemplateReader.readTemplates(this.templateRefs);
            }
        });
    }
    selectItem(item) {
        const value = this.getArrayItemValue(item);
        const isArrayMode = this.multiple || this.modelAsArray;
        if (isArrayMode) {
            const modelIndex = this.modelIndex(item);
            if (modelIndex >= 0) {
                this.model.splice(modelIndex, 1);
            }
            else {
                this.model.push(this.getArrayItemModel(item));
            }
            if (this.max) {
                while (this.model.length > this.max) {
                    this.model.shift();
                }
            }
        }
        else {
            if (this.toggleable && this.model == value) {
                delete this.model;
            }
            else {
                this.model = this.getArrayItemModel(item);
            }
        }
        this.emitChange();
    }
    emitChange() {
        this.modelChange.emit(this.model);
        const form = getParentByTagName(this.ElementRef.nativeElement, 'form');
        if (form)
            this.fireFormEvents(form);
    }
    fireFormEvents(form) {
        let event = document.createEvent("HTMLEvents");
        event.initEvent("input", true, true);
        form.dispatchEvent(event);
        event = document.createEvent("HTMLEvents");
        event.initEvent("change", true, true);
        form.dispatchEvent(event);
    }
    getArrayItemModel(item) {
        if (this.arrayToModelKey != null) {
            if (this.arrayToModelKey == '') {
                return item;
            }
            const split = this.arrayToModelKey.split('.');
            var scope = item;
            while (split.length) {
                if (scope == null)
                    return null;
                let key = split.shift();
                scope = scope[key];
            }
            return scope;
        }
        return this.getArrayItemValue(item);
    }
    getArrayItemValue(item) {
        if (!this.arrayKey)
            return item;
        let items = this.arrayKey.split('.');
        var scope = item;
        while (items.length) {
            if (scope == null)
                return null;
            let firstItem = items.shift();
            scope = scope[firstItem];
        }
        return scope;
    }
    getModelValueToArrayItem(modelValue) {
        if (!this.modelKey)
            return modelValue;
        let items = this.modelKey.split('.');
        var scope = modelValue;
        while (items.length) {
            if (scope == null)
                return null;
            let firstItem = items.shift();
            scope = scope[firstItem];
        }
        return scope;
    }
    modelIndex(item) {
        this.model = array(this.model);
        for (let i = this.model.length - 1; i >= 0; --i) {
            let value = this.getArrayItemValue(item);
            let modelValue = this.getModelValueToArrayItem(this.model[i]);
            if (value == modelValue)
                return i;
        }
        return -1;
    }
    isItemSelected(item) {
        return this.modelIndex(item) >= 0;
    }
    getItemClass(item) {
        const selected = this.isItemSelected(item);
        let string = '';
        if (this.stylize) {
            string += 'cursor-pointer pad-h pad-v-sm border-grey-6x border-bottom ';
        }
        if (this.stylize && selected) {
            string += 'bg-warning ';
        }
        if (this.stylize && !selected) {
            string += 'hover-bg-grey-5x ';
        }
        return string;
    }
}
AckOptions.decorators = [
    { type: Component, args: [{
                selector: "ack-options",
                template: ackOptions
                //,exportAs:"AckOptions"
            },] }
];
AckOptions.ctorParameters = () => [
    { type: ElementRef }
];
AckOptions.propDecorators = {
    array: [{ type: Input }],
    stylize: [{ type: Input }],
    multiple: [{ type: Input }],
    modelAsArray: [{ type: Input }],
    max: [{ type: Input }],
    toggleable: [{ type: Input }],
    templateRefs: [{ type: ContentChildren, args: [TemplateRef,] }],
    inputTemplateRefs: [{ type: Input }],
    model: [{ type: Input }],
    modelChange: [{ type: Output }],
    arrayKey: [{ type: Input }],
    modelKey: [{ type: Input }],
    arrayToModelKey: [{ type: Input }]
};
export function getParentByTagName(node, tagname) {
    let parent;
    if (node === null || tagname === '')
        return;
    parent = node.parentNode;
    tagname = tagname.toUpperCase();
    while (parent && parent.tagName !== "HTML") {
        if (parent.tagName === tagname) {
            return parent;
        }
        parent = parent.parentNode;
    }
    return;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQWNrT3B0aW9ucy5jb21wb25lbnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvY29tcG9uZW50cy9BY2tPcHRpb25zLmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsS0FBSyxFQUFFLE1BQU0sZ0JBQWdCLENBQUE7QUFDdEMsT0FBTyxFQUNMLFVBQVUsRUFDVixlQUFlLEVBQ2YsV0FBVyxFQUNYLFNBQVMsRUFDVCxLQUFLLEVBQ0wsTUFBTSxFQUNOLFlBQVksRUFDYixNQUFNLGVBQWUsQ0FBQTtBQUN0QixPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0seUJBQXlCLENBQUE7QUFDeEQsT0FBTyxFQUFFLE1BQU0sSUFBSSxVQUFVLEVBQUUsTUFBTSw2QkFBNkIsQ0FBQTtBQU0vRCxNQUFNLE9BQU8sVUFBVTtJQTBCeEIsWUFBbUIsVUFBcUI7UUFBckIsZUFBVSxHQUFWLFVBQVUsQ0FBVztRQXpCL0IsVUFBSyxHQUFHLEVBQUUsQ0FBQTtRQUNWLFlBQU8sR0FBVyxJQUFJLENBQUE7UUFNL0IsbUJBQWMsR0FBa0IsSUFBSSxjQUFjLENBQUM7WUFDakQsZ0JBQWdCLEVBQUMsYUFBYTtZQUM5QixLQUFLLEVBQUM7Z0JBQ0osTUFBTSxFQUFDLGFBQWE7Z0JBQ3BCLFFBQVEsRUFBQyxVQUFVO2FBQ3BCO1NBQ0YsQ0FBQyxDQUFBO1FBTVEsZ0JBQVcsR0FBcUIsSUFBSSxZQUFZLEVBQUUsQ0FBQTtJQU1sQixDQUFDO0lBRTNDLGVBQWU7UUFDYixPQUFPLENBQUMsT0FBTyxFQUFFLENBQUMsSUFBSSxDQUFDLEdBQUUsRUFBRTtZQUN6QixJQUFJLElBQUksQ0FBQyxpQkFBaUIsRUFBRTtnQkFDMUIsSUFBSSxDQUFDLGNBQWMsQ0FBQyxhQUFhLENBQUMsSUFBSSxDQUFDLGlCQUFpQixDQUFDLENBQUE7YUFDMUQ7WUFDRCxJQUFJLElBQUksQ0FBQyxZQUFZLEVBQUU7Z0JBQ3JCLElBQUksQ0FBQyxjQUFjLENBQUMsYUFBYSxDQUFDLElBQUksQ0FBQyxZQUFZLENBQUMsQ0FBQTthQUNyRDtRQUNILENBQUMsQ0FBQyxDQUFBO0lBQ0osQ0FBQztJQUVELFVBQVUsQ0FBQyxJQUFTO1FBQ2xCLE1BQU0sS0FBSyxHQUFHLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxJQUFJLENBQUMsQ0FBQTtRQUMxQyxNQUFNLFdBQVcsR0FBRyxJQUFJLENBQUMsUUFBUSxJQUFJLElBQUksQ0FBQyxZQUFZLENBQUE7UUFFdEQsSUFBSSxXQUFXLEVBQUU7WUFDZixNQUFNLFVBQVUsR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFFLElBQUksQ0FBRSxDQUFBO1lBQzFDLElBQUcsVUFBVSxJQUFFLENBQUMsRUFBQztnQkFDZixJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxVQUFVLEVBQUUsQ0FBQyxDQUFDLENBQUE7YUFDakM7aUJBQUk7Z0JBQ0gsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUUsSUFBSSxDQUFDLGlCQUFpQixDQUFDLElBQUksQ0FBQyxDQUFFLENBQUE7YUFDaEQ7WUFFRCxJQUFHLElBQUksQ0FBQyxHQUFHLEVBQUM7Z0JBQ1YsT0FBTSxJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sR0FBRyxJQUFJLENBQUMsR0FBRyxFQUFDO29CQUNqQyxJQUFJLENBQUMsS0FBSyxDQUFDLEtBQUssRUFBRSxDQUFBO2lCQUNuQjthQUNGO1NBQ0Y7YUFBSTtZQUNILElBQUcsSUFBSSxDQUFDLFVBQVUsSUFBSSxJQUFJLENBQUMsS0FBSyxJQUFFLEtBQUssRUFBQztnQkFDdEMsT0FBTyxJQUFJLENBQUMsS0FBSyxDQUFBO2FBQ2xCO2lCQUFJO2dCQUNILElBQUksQ0FBQyxLQUFLLEdBQUcsSUFBSSxDQUFDLGlCQUFpQixDQUFDLElBQUksQ0FBQyxDQUFBO2FBQzFDO1NBQ0Y7UUFFRCxJQUFJLENBQUMsVUFBVSxFQUFFLENBQUE7SUFDbkIsQ0FBQztJQUVELFVBQVU7UUFDUixJQUFJLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBRSxJQUFJLENBQUMsS0FBSyxDQUFFLENBQUE7UUFFbkMsTUFBTSxJQUFJLEdBQUcsa0JBQWtCLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxhQUFhLEVBQUMsTUFBTSxDQUFDLENBQUE7UUFDckUsSUFBRyxJQUFJO1lBQUMsSUFBSSxDQUFDLGNBQWMsQ0FBQyxJQUFJLENBQUMsQ0FBQTtJQUNuQyxDQUFDO0lBRUQsY0FBYyxDQUFDLElBQVM7UUFDdEIsSUFBSSxLQUFLLEdBQUcsUUFBUSxDQUFDLFdBQVcsQ0FBQyxZQUFZLENBQUMsQ0FBQztRQUMvQyxLQUFLLENBQUMsU0FBUyxDQUFDLE9BQU8sRUFBRSxJQUFJLEVBQUUsSUFBSSxDQUFDLENBQUM7UUFDckMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxLQUFLLENBQUMsQ0FBQTtRQUV6QixLQUFLLEdBQUcsUUFBUSxDQUFDLFdBQVcsQ0FBQyxZQUFZLENBQUMsQ0FBQztRQUMzQyxLQUFLLENBQUMsU0FBUyxDQUFDLFFBQVEsRUFBRSxJQUFJLEVBQUUsSUFBSSxDQUFDLENBQUM7UUFDdEMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxLQUFLLENBQUMsQ0FBQTtJQUMzQixDQUFDO0lBRUQsaUJBQWlCLENBQUMsSUFBUztRQUN6QixJQUFHLElBQUksQ0FBQyxlQUFlLElBQUUsSUFBSSxFQUFDO1lBQzVCLElBQUcsSUFBSSxDQUFDLGVBQWUsSUFBRSxFQUFFLEVBQUM7Z0JBQzFCLE9BQU8sSUFBSSxDQUFBO2FBQ1o7WUFFRCxNQUFNLEtBQUssR0FBRyxJQUFJLENBQUMsZUFBZSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQTtZQUM3QyxJQUFJLEtBQUssR0FBRyxJQUFJLENBQUE7WUFDaEIsT0FBTSxLQUFLLENBQUMsTUFBTSxFQUFDO2dCQUNqQixJQUFHLEtBQUssSUFBRSxJQUFJO29CQUFDLE9BQU8sSUFBSSxDQUFBO2dCQUMxQixJQUFJLEdBQUcsR0FBVyxLQUFLLENBQUMsS0FBSyxFQUFFLENBQUE7Z0JBQy9CLEtBQUssR0FBRyxLQUFLLENBQUUsR0FBRyxDQUFFLENBQUE7YUFDckI7WUFDRCxPQUFPLEtBQUssQ0FBQTtTQUNiO1FBQ0QsT0FBTyxJQUFJLENBQUMsaUJBQWlCLENBQUUsSUFBSSxDQUFFLENBQUE7SUFDdkMsQ0FBQztJQUVELGlCQUFpQixDQUFDLElBQVM7UUFDekIsSUFBRyxDQUFDLElBQUksQ0FBQyxRQUFRO1lBQUMsT0FBTyxJQUFJLENBQUE7UUFFN0IsSUFBSSxLQUFLLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUE7UUFDcEMsSUFBSSxLQUFLLEdBQUcsSUFBSSxDQUFBO1FBQ2hCLE9BQU0sS0FBSyxDQUFDLE1BQU0sRUFBQztZQUNqQixJQUFJLEtBQUssSUFBRSxJQUFJO2dCQUFFLE9BQU8sSUFBSSxDQUFBO1lBQzVCLElBQUksU0FBUyxHQUFXLEtBQUssQ0FBQyxLQUFLLEVBQUUsQ0FBQTtZQUNyQyxLQUFLLEdBQUcsS0FBSyxDQUFFLFNBQVMsQ0FBRSxDQUFBO1NBQzNCO1FBRUQsT0FBTyxLQUFLLENBQUE7SUFDZCxDQUFDO0lBRUQsd0JBQXdCLENBQUUsVUFBYztRQUN0QyxJQUFHLENBQUMsSUFBSSxDQUFDLFFBQVE7WUFBQyxPQUFPLFVBQVUsQ0FBQTtRQUVuQyxJQUFJLEtBQUssR0FBWSxJQUFJLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQTtRQUM3QyxJQUFJLEtBQUssR0FBRyxVQUFVLENBQUE7UUFDdEIsT0FBTyxLQUFLLENBQUMsTUFBTSxFQUFFO1lBQ25CLElBQUksS0FBSyxJQUFFLElBQUk7Z0JBQUUsT0FBTyxJQUFJLENBQUE7WUFDNUIsSUFBSSxTQUFTLEdBQVcsS0FBSyxDQUFDLEtBQUssRUFBRSxDQUFBO1lBQ3JDLEtBQUssR0FBRyxLQUFLLENBQUUsU0FBUyxDQUFFLENBQUE7U0FDM0I7UUFFRCxPQUFPLEtBQUssQ0FBQTtJQUNkLENBQUM7SUFFRCxVQUFVLENBQUMsSUFBUztRQUNsQixJQUFJLENBQUMsS0FBSyxHQUFHLEtBQUssQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUE7UUFDOUIsS0FBSSxJQUFJLENBQUMsR0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sR0FBQyxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsRUFBRSxFQUFFLENBQUMsRUFBQztZQUN6QyxJQUFJLEtBQUssR0FBRyxJQUFJLENBQUMsaUJBQWlCLENBQUUsSUFBSSxDQUFFLENBQUE7WUFDMUMsSUFBSSxVQUFVLEdBQUcsSUFBSSxDQUFDLHdCQUF3QixDQUFFLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUUsQ0FBQTtZQUMvRCxJQUFJLEtBQUssSUFBSSxVQUFVO2dCQUFFLE9BQU8sQ0FBQyxDQUFBO1NBQ2xDO1FBQ0QsT0FBTyxDQUFDLENBQUMsQ0FBQTtJQUNYLENBQUM7SUFFRCxjQUFjLENBQUMsSUFBUztRQUN0QixPQUFPLElBQUksQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLElBQUUsQ0FBQyxDQUFBO0lBQ2pDLENBQUM7SUFFRCxZQUFZLENBQUMsSUFBUztRQUNwQixNQUFNLFFBQVEsR0FBRyxJQUFJLENBQUMsY0FBYyxDQUFDLElBQUksQ0FBQyxDQUFBO1FBQzFDLElBQUksTUFBTSxHQUFHLEVBQUUsQ0FBQTtRQUVmLElBQUcsSUFBSSxDQUFDLE9BQU8sRUFBQztZQUNkLE1BQU0sSUFBSSw2REFBNkQsQ0FBQTtTQUN4RTtRQUVELElBQUcsSUFBSSxDQUFDLE9BQU8sSUFBSSxRQUFRLEVBQUM7WUFDMUIsTUFBTSxJQUFJLGFBQWEsQ0FBQTtTQUN4QjtRQUVELElBQUcsSUFBSSxDQUFDLE9BQU8sSUFBSSxDQUFDLFFBQVEsRUFBQztZQUMzQixNQUFNLElBQUksbUJBQW1CLENBQUE7U0FDOUI7UUFFRCxPQUFPLE1BQU0sQ0FBQTtJQUVmLENBQUM7OztZQXRLRixTQUFTLFNBQUM7Z0JBQ1QsUUFBUSxFQUFDLGFBQWE7Z0JBQ3RCLFFBQVEsRUFBQyxVQUFVO2dCQUNuQix3QkFBd0I7YUFDekI7OztZQWZDLFVBQVU7OztvQkFnQlQsS0FBSztzQkFDTCxLQUFLO3VCQUNMLEtBQUs7MkJBQ0wsS0FBSztrQkFDTCxLQUFLO3lCQUNMLEtBQUs7MkJBVUwsZUFBZSxTQUFDLFdBQVc7Z0NBQzNCLEtBQUs7b0JBRUwsS0FBSzswQkFDTCxNQUFNO3VCQUVOLEtBQUs7dUJBQ0wsS0FBSzs4QkFDTCxLQUFLOztBQTZJUixNQUFNLFVBQVUsa0JBQWtCLENBQUMsSUFBUyxFQUFFLE9BQVk7SUFDeEQsSUFBSSxNQUFNLENBQUM7SUFDWCxJQUFJLElBQUksS0FBSyxJQUFJLElBQUksT0FBTyxLQUFLLEVBQUU7UUFBRSxPQUFPO0lBQzVDLE1BQU0sR0FBSSxJQUFJLENBQUMsVUFBVSxDQUFDO0lBQzFCLE9BQU8sR0FBRyxPQUFPLENBQUMsV0FBVyxFQUFFLENBQUM7SUFFaEMsT0FBTyxNQUFNLElBQUksTUFBTSxDQUFDLE9BQU8sS0FBSyxNQUFNLEVBQUU7UUFDMUMsSUFBSSxNQUFNLENBQUMsT0FBTyxLQUFLLE9BQU8sRUFBRTtZQUM5QixPQUFPLE1BQU0sQ0FBQztTQUNmO1FBQ0QsTUFBTSxHQUFHLE1BQU0sQ0FBQyxVQUFVLENBQUM7S0FDNUI7SUFFRCxPQUFPO0FBQ1QsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGFycmF5IH0gZnJvbSBcIi4uL3BpcGVzLmNsYXNzXCJcbmltcG9ydCB7XG4gIEVsZW1lbnRSZWYsXG4gIENvbnRlbnRDaGlsZHJlbixcbiAgVGVtcGxhdGVSZWYsXG4gIENvbXBvbmVudCxcbiAgSW5wdXQsXG4gIE91dHB1dCxcbiAgRXZlbnRFbWl0dGVyXG59IGZyb20gXCJAYW5ndWxhci9jb3JlXCJcbmltcG9ydCB7IFRlbXBsYXRlUmVhZGVyIH0gZnJvbSBcIi4uL1RlbXBsYXRlUmVhZGVyLmNsYXNzXCJcbmltcG9ydCB7IHN0cmluZyBhcyBhY2tPcHRpb25zIH0gZnJvbSBcIi4vdGVtcGxhdGVzL2Fjay1vcHRpb25zLnB1Z1wiXG5cbkBDb21wb25lbnQoe1xuICBzZWxlY3RvcjpcImFjay1vcHRpb25zXCIsXG4gIHRlbXBsYXRlOmFja09wdGlvbnNcbiAgLy8sZXhwb3J0QXM6XCJBY2tPcHRpb25zXCJcbn0pIGV4cG9ydCBjbGFzcyBBY2tPcHRpb25ze1xuICBASW5wdXQoKSBhcnJheSA9IFtdXG4gIEBJbnB1dCgpIHN0eWxpemU6Ym9vbGVhbiA9IHRydWVcbiAgQElucHV0KCkgbXVsdGlwbGUhOiBib29sZWFuXG4gIEBJbnB1dCgpIG1vZGVsQXNBcnJheSE6IGJvb2xlYW5cbiAgQElucHV0KCkgbWF4ITogbnVtYmVyXG4gIEBJbnB1dCgpIHRvZ2dsZWFibGUhOiBib29sZWFuXG5cbiAgVGVtcGxhdGVSZWFkZXI6VGVtcGxhdGVSZWFkZXIgPSBuZXcgVGVtcGxhdGVSZWFkZXIoe1xuICAgIGxhc3RUZW1wbGF0ZU5hbWU6XCJ0ZW1wbGF0ZVJlZlwiLFxuICAgIHR5cGVzOntcbiAgICAgIG9wdGlvbjpcInRlbXBsYXRlUmVmXCIsXG4gICAgICBzZWxlY3RlZDpcInNlbGVjdGVkXCJcbiAgICB9XG4gIH0pXG5cbiAgQENvbnRlbnRDaGlsZHJlbihUZW1wbGF0ZVJlZikgdGVtcGxhdGVSZWZzOmFueS8vVGVtcGxhdGVSZWY8YW55PltdXG4gIEBJbnB1dCgpIGlucHV0VGVtcGxhdGVSZWZzOmFueS8vVGVtcGxhdGVSZWY8YW55PltdXG5cbiAgQElucHV0KCkgbW9kZWw6YW55XG4gIEBPdXRwdXQoKSBtb2RlbENoYW5nZTpFdmVudEVtaXR0ZXI8YW55PiA9IG5ldyBFdmVudEVtaXR0ZXIoKVxuXG4gIEBJbnB1dCgpIGFycmF5S2V5ITogc3RyaW5nXG4gIEBJbnB1dCgpIG1vZGVsS2V5ITogc3RyaW5nXG4gIEBJbnB1dCgpIGFycmF5VG9Nb2RlbEtleSE6IHN0cmluZ1xuXG4gIGNvbnN0cnVjdG9yKHB1YmxpYyBFbGVtZW50UmVmOkVsZW1lbnRSZWYpe31cblxuICBuZ0FmdGVyVmlld0luaXQoKXtcbiAgICBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpPT57XG4gICAgICBpZiggdGhpcy5pbnB1dFRlbXBsYXRlUmVmcyApe1xuICAgICAgICB0aGlzLlRlbXBsYXRlUmVhZGVyLnJlYWRUZW1wbGF0ZXModGhpcy5pbnB1dFRlbXBsYXRlUmVmcylcbiAgICAgIH1cbiAgICAgIGlmKCB0aGlzLnRlbXBsYXRlUmVmcyApe1xuICAgICAgICB0aGlzLlRlbXBsYXRlUmVhZGVyLnJlYWRUZW1wbGF0ZXModGhpcy50ZW1wbGF0ZVJlZnMpXG4gICAgICB9XG4gICAgfSlcbiAgfVxuXG4gIHNlbGVjdEl0ZW0oaXRlbTogYW55KSB7XG4gICAgY29uc3QgdmFsdWUgPSB0aGlzLmdldEFycmF5SXRlbVZhbHVlKGl0ZW0pXG4gICAgY29uc3QgaXNBcnJheU1vZGUgPSB0aGlzLm11bHRpcGxlIHx8IHRoaXMubW9kZWxBc0FycmF5XG5cbiAgICBpZiggaXNBcnJheU1vZGUgKXtcbiAgICAgIGNvbnN0IG1vZGVsSW5kZXggPSB0aGlzLm1vZGVsSW5kZXgoIGl0ZW0gKVxuICAgICAgaWYobW9kZWxJbmRleD49MCl7XG4gICAgICAgIHRoaXMubW9kZWwuc3BsaWNlKG1vZGVsSW5kZXgsIDEpXG4gICAgICB9ZWxzZXtcbiAgICAgICAgdGhpcy5tb2RlbC5wdXNoKCB0aGlzLmdldEFycmF5SXRlbU1vZGVsKGl0ZW0pIClcbiAgICAgIH1cblxuICAgICAgaWYodGhpcy5tYXgpe1xuICAgICAgICB3aGlsZSh0aGlzLm1vZGVsLmxlbmd0aCA+IHRoaXMubWF4KXtcbiAgICAgICAgICB0aGlzLm1vZGVsLnNoaWZ0KClcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1lbHNle1xuICAgICAgaWYodGhpcy50b2dnbGVhYmxlICYmIHRoaXMubW9kZWw9PXZhbHVlKXtcbiAgICAgICAgZGVsZXRlIHRoaXMubW9kZWxcbiAgICAgIH1lbHNle1xuICAgICAgICB0aGlzLm1vZGVsID0gdGhpcy5nZXRBcnJheUl0ZW1Nb2RlbChpdGVtKVxuICAgICAgfVxuICAgIH1cblxuICAgIHRoaXMuZW1pdENoYW5nZSgpXG4gIH1cblxuICBlbWl0Q2hhbmdlKCl7XG4gICAgdGhpcy5tb2RlbENoYW5nZS5lbWl0KCB0aGlzLm1vZGVsIClcblxuICAgIGNvbnN0IGZvcm0gPSBnZXRQYXJlbnRCeVRhZ05hbWUodGhpcy5FbGVtZW50UmVmLm5hdGl2ZUVsZW1lbnQsJ2Zvcm0nKVxuICAgIGlmKGZvcm0pdGhpcy5maXJlRm9ybUV2ZW50cyhmb3JtKVxuICB9XG5cbiAgZmlyZUZvcm1FdmVudHMoZm9ybTogYW55KSB7XG4gICAgbGV0IGV2ZW50ID0gZG9jdW1lbnQuY3JlYXRlRXZlbnQoXCJIVE1MRXZlbnRzXCIpO1xuICAgIGV2ZW50LmluaXRFdmVudChcImlucHV0XCIsIHRydWUsIHRydWUpO1xuICAgIGZvcm0uZGlzcGF0Y2hFdmVudChldmVudClcblxuICAgIGV2ZW50ID0gZG9jdW1lbnQuY3JlYXRlRXZlbnQoXCJIVE1MRXZlbnRzXCIpO1xuICAgIGV2ZW50LmluaXRFdmVudChcImNoYW5nZVwiLCB0cnVlLCB0cnVlKTtcbiAgICBmb3JtLmRpc3BhdGNoRXZlbnQoZXZlbnQpXG4gIH1cblxuICBnZXRBcnJheUl0ZW1Nb2RlbChpdGVtOiBhbnkpIHtcbiAgICBpZih0aGlzLmFycmF5VG9Nb2RlbEtleSE9bnVsbCl7XG4gICAgICBpZih0aGlzLmFycmF5VG9Nb2RlbEtleT09Jycpe1xuICAgICAgICByZXR1cm4gaXRlbVxuICAgICAgfVxuXG4gICAgICBjb25zdCBzcGxpdCA9IHRoaXMuYXJyYXlUb01vZGVsS2V5LnNwbGl0KCcuJylcbiAgICAgIHZhciBzY29wZSA9IGl0ZW1cbiAgICAgIHdoaWxlKHNwbGl0Lmxlbmd0aCl7XG4gICAgICAgIGlmKHNjb3BlPT1udWxsKXJldHVybiBudWxsXG4gICAgICAgIGxldCBrZXkgPSA8c3RyaW5nPnNwbGl0LnNoaWZ0KClcbiAgICAgICAgc2NvcGUgPSBzY29wZVsga2V5IF1cbiAgICAgIH1cbiAgICAgIHJldHVybiBzY29wZVxuICAgIH1cbiAgICByZXR1cm4gdGhpcy5nZXRBcnJheUl0ZW1WYWx1ZSggaXRlbSApXG4gIH1cblxuICBnZXRBcnJheUl0ZW1WYWx1ZShpdGVtOiBhbnkpe1xuICAgIGlmKCF0aGlzLmFycmF5S2V5KXJldHVybiBpdGVtXG5cbiAgICBsZXQgaXRlbXMgPSB0aGlzLmFycmF5S2V5LnNwbGl0KCcuJylcbiAgICB2YXIgc2NvcGUgPSBpdGVtXG4gICAgd2hpbGUoaXRlbXMubGVuZ3RoKXtcbiAgICAgIGlmKCBzY29wZT09bnVsbCApcmV0dXJuIG51bGxcbiAgICAgIGxldCBmaXJzdEl0ZW0gPSA8c3RyaW5nPml0ZW1zLnNoaWZ0KClcbiAgICAgIHNjb3BlID0gc2NvcGVbIGZpcnN0SXRlbSBdXG4gICAgfVxuXG4gICAgcmV0dXJuIHNjb3BlXG4gIH1cblxuICBnZXRNb2RlbFZhbHVlVG9BcnJheUl0ZW0oIG1vZGVsVmFsdWU6YW55ICk6YW55e1xuICAgIGlmKCF0aGlzLm1vZGVsS2V5KXJldHVybiBtb2RlbFZhbHVlXG5cbiAgICBsZXQgaXRlbXM6c3RyaW5nW10gPSB0aGlzLm1vZGVsS2V5LnNwbGl0KCcuJylcbiAgICB2YXIgc2NvcGUgPSBtb2RlbFZhbHVlXG4gICAgd2hpbGUoIGl0ZW1zLmxlbmd0aCApe1xuICAgICAgaWYoIHNjb3BlPT1udWxsIClyZXR1cm4gbnVsbFxuICAgICAgbGV0IGZpcnN0SXRlbSA9IDxzdHJpbmc+aXRlbXMuc2hpZnQoKVxuICAgICAgc2NvcGUgPSBzY29wZVsgZmlyc3RJdGVtIF1cbiAgICB9XG5cbiAgICByZXR1cm4gc2NvcGVcbiAgfVxuXG4gIG1vZGVsSW5kZXgoaXRlbTogYW55KSB7XG4gICAgdGhpcy5tb2RlbCA9IGFycmF5KHRoaXMubW9kZWwpXG4gICAgZm9yKGxldCBpPXRoaXMubW9kZWwubGVuZ3RoLTE7IGkgPj0gMDsgLS1pKXtcbiAgICAgIGxldCB2YWx1ZSA9IHRoaXMuZ2V0QXJyYXlJdGVtVmFsdWUoIGl0ZW0gKVxuICAgICAgbGV0IG1vZGVsVmFsdWUgPSB0aGlzLmdldE1vZGVsVmFsdWVUb0FycmF5SXRlbSggdGhpcy5tb2RlbFtpXSApXG4gICAgICBpZiggdmFsdWUgPT0gbW9kZWxWYWx1ZSApcmV0dXJuIGlcbiAgICB9XG4gICAgcmV0dXJuIC0xXG4gIH1cblxuICBpc0l0ZW1TZWxlY3RlZChpdGVtOiBhbnkpIHtcbiAgICByZXR1cm4gdGhpcy5tb2RlbEluZGV4KGl0ZW0pPj0wXG4gIH1cblxuICBnZXRJdGVtQ2xhc3MoaXRlbTogYW55KTogc3RyaW5ne1xuICAgIGNvbnN0IHNlbGVjdGVkID0gdGhpcy5pc0l0ZW1TZWxlY3RlZChpdGVtKVxuICAgIGxldCBzdHJpbmcgPSAnJ1xuXG4gICAgaWYodGhpcy5zdHlsaXplKXtcbiAgICAgIHN0cmluZyArPSAnY3Vyc29yLXBvaW50ZXIgcGFkLWggcGFkLXYtc20gYm9yZGVyLWdyZXktNnggYm9yZGVyLWJvdHRvbSAnXG4gICAgfVxuXG4gICAgaWYodGhpcy5zdHlsaXplICYmIHNlbGVjdGVkKXtcbiAgICAgIHN0cmluZyArPSAnYmctd2FybmluZyAnXG4gICAgfVxuXG4gICAgaWYodGhpcy5zdHlsaXplICYmICFzZWxlY3RlZCl7XG4gICAgICBzdHJpbmcgKz0gJ2hvdmVyLWJnLWdyZXktNXggJ1xuICAgIH1cblxuICAgIHJldHVybiBzdHJpbmdcblxuICB9XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXRQYXJlbnRCeVRhZ05hbWUobm9kZTogYW55LCB0YWduYW1lOiBhbnkpIHtcbiAgbGV0IHBhcmVudDtcbiAgaWYgKG5vZGUgPT09IG51bGwgfHwgdGFnbmFtZSA9PT0gJycpIHJldHVybjtcbiAgcGFyZW50ICA9IG5vZGUucGFyZW50Tm9kZTtcbiAgdGFnbmFtZSA9IHRhZ25hbWUudG9VcHBlckNhc2UoKTtcblxuICB3aGlsZSAocGFyZW50ICYmIHBhcmVudC50YWdOYW1lICE9PSBcIkhUTUxcIikge1xuICAgIGlmIChwYXJlbnQudGFnTmFtZSA9PT0gdGFnbmFtZSkge1xuICAgICAgcmV0dXJuIHBhcmVudDtcbiAgICB9XG4gICAgcGFyZW50ID0gcGFyZW50LnBhcmVudE5vZGU7XG4gIH1cblxuICByZXR1cm47XG59XG4iXX0=