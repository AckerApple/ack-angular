import { BehaviorSubject } from "rxjs/internal/BehaviorSubject";
import { EventEmitter, Output, Input, ContentChildren, Directive, IterableDiffers } from "@angular/core";
import { AckAggregate } from "./AckAggregate.directive";
export class AckArray {
    constructor(_iterableDiffers) {
        this._iterableDiffers = _iterableDiffers;
        this.pushed = {};
        this.inSort = false;
        this.sortArray = [];
        this.pageAt = 0; //when to page aka maxrows
        this.pagesChange = new BehaviorSubject(null);
        //@Output() pagesChange:EventEmitter<any[][]> = new EventEmitter()
        //a chance to know when current viewed page should be zero
        this.page = 0;
        this.pageChange = new EventEmitter();
        this.keyMapChange = new EventEmitter();
        this.loopStart = new EventEmitter();
        this.loopEach = new EventEmitter();
        this.loopEnd = new EventEmitter();
        this.arrayChange = new EventEmitter();
        //super()
        //watch deep changes
        const f = this._iterableDiffers.find([]);
        this.iterableDiffer = f.create();
    }
    ngOnDestroy() {
        if (this.array$sub) {
            this.array$sub.unsubscribe();
        }
    }
    ngOnInit() {
        if (this.keyMapChange.observers.length) {
            if (!this.keyMap) {
                Promise.resolve().then(() => {
                    this.keyMap = {};
                    this.keyMapChange.emit(this.keyMap);
                });
            }
            this.pushCreateMap();
        }
    }
    ngAfterViewInit() {
        if (this.AckAggregates) {
            this.pushAggregates(this.AckAggregates);
        }
        this.inited = true;
        Promise.resolve().then(() => this.loop(true));
    }
    //watch array deep changes
    ngDoCheck() {
        if (!this.inited)
            return;
        let changes = this.iterableDiffer.diff(this.array);
        if (changes) {
            Promise.resolve().then(() => this.loop(false));
        }
    }
    ngOnChanges(changes) {
        if (changes.array$) {
            if (this.array$sub) {
                this.array$sub.unsubscribe();
                delete this.array$sub;
            }
            if (this.array$) {
                this.array$sub = this.array$.subscribe(array => {
                    if (this.merge) {
                        mergeArrays(this.array, array, this.idKeys);
                    }
                    else {
                        const reset = this.array != array;
                        this.array = array;
                        this.loop(reset);
                    }
                });
            }
        }
        let loop = changes.array ? true : false;
        if (changes.pageAt) {
            this.pushCreatePages();
            loop = true;
        }
        if (this.inited && loop) {
            Promise.resolve().then(() => this.loop(true));
        }
    }
    /*
      performJoins(){
        this.AckArrayJoins.forEach(join=>
          join.joinTo( this.array )
        )
      }
    */
    pushAggregates(aggs) {
        aggs.forEach(agg => {
            let memory;
            switch (agg.type) {
                //default is to sum
                default: {
                    this.loopStart.subscribe(() => memory = 0);
                    this.loopEach.subscribe(loop => {
                        const value = this.getItemValueByKeys(loop.item, agg.keys);
                        if (value) {
                            memory = memory + value;
                        }
                    });
                    this.loopEnd.subscribe(() => {
                        agg.output = memory;
                        agg.outputChange.emit(memory);
                    });
                }
            }
        });
    }
    getItemValueByKeys(item, keys) {
        for (let x = 0; x < keys.length; ++x) {
            let keyName = keys[x];
            item = item[keyName];
            if (item == null)
                return null;
        }
        return item;
    }
    loop(reset) {
        //super.loop( reset )
        if (!this.array) {
            this.array = [];
        }
        this.loopStart.emit(reset);
        const last = this.array.length;
        for (let x = 0; x < last; ++x) {
            this.loopEach.emit({ index: x, item: this.array[x] });
        }
        //this.performJoins()
        this.loopEnd.emit();
    }
    pushCreateMap() {
        if (this.pushed.createMap)
            return;
        this.pushed.createMap = true;
        this.loopStart.subscribe(() => this.keyMap = {});
        this.loopEach.subscribe(ob => {
            let key = this.getItemId(ob.item);
            this.keyMap[key] = ob.item;
        });
        this.loopEnd.subscribe(() => this.keyMapChange.emit(this.keyMap));
    }
    /** adds to loop functionality how to create pages */
    pushCreatePages() {
        if (this.pushed.createPages)
            return;
        this.pushed.createPages = true;
        let pos = 0;
        let last = 0;
        this.loopStart.subscribe(reset => {
            pos = 0;
            last = this.array.length;
            if (reset) {
                this.pageChange.emit(this.page = 0);
            }
            this.pages = this.pages || [];
            this.pages.length = 0; //dont break binding if pages remembered
            this.pages.push([]);
        });
        this.loopEach.subscribe(ob => {
            this.pages[pos].push(ob.item);
            if (this.pages[pos].length == this.pageAt && ob.index < last - 1) {
                this.pages.push([]);
                ++pos;
            }
        });
        this.loopEnd.subscribe(() => {
            if (this.page && this.page >= this.pages.length) {
                this.pageChange.emit(this.page = 0);
            }
            //this.pagesChange.emit( this.pages )
            this.pagesChange.next(this.pages);
        });
    }
    //reduce array down to one item
    only(item) {
        this.array.length = 0;
        this.array.push(item);
        this.arrayChange.emit(this.array);
        this.loop(true);
    }
    //looks up id or the item itself is an ID
    getItemId(item) {
        return this.idKeys && this.idKeys[0] && item[this.idKeys[0]];
    }
    getCompareArray() {
        if (this.array && this.idKeys && this.idKeys.length) {
            const idKey = this.idKeys[0];
            return this.array.map(item => item[idKey]);
        }
        return this.array || [];
    }
    /*
      selected(item){
        return this.itemIndex(item) >= 0 ? true : false
      }
    */
    itemIndex(item) {
        const array = this.getCompareArray();
        for (let x = array.length - 1; x >= 0; --x) {
            if (dataKeysMatch(array[x], item, this.idKeys)) {
                return x;
            }
        }
        return -1;
    }
    toggle(item) {
        const index = this.itemIndex(item);
        if (index >= 0) {
            return this.splice(index);
        }
        return this.push(item);
    }
    push(item) {
        this.param().push(item);
        this.loop(false);
        return this;
    }
    unshift(item) {
        this.param().unshift(item);
        return this;
    }
    splice(x, y = 1) {
        this.param().splice(x, y);
        this.loop(false);
        return this;
    }
    param() {
        if (!this.array)
            this.arrayChange.emit(this.array = []);
        return this.array;
    }
    toggleSort(arrayKey, sortType) {
        if (this.inSort)
            return false;
        this.inSort = true;
        let asc = false; //most lists come pre sorted asc, our default should be desc
        if (this.sortArray.length && this.sortArray[0].arrayKey) {
            asc = !this.sortArray[0].asc;
            this.sortArray[0] = {
                arrayKey: arrayKey,
                asc: !this.sortArray[0].asc
            };
        }
        else {
            this.sortArray.unshift({
                arrayKey: arrayKey,
                asc: asc
            });
        }
        const toKey = function (a, index = 0) {
            const value = a[arrayKey[index]];
            if (value == null || index == arrayKey.length - 1) {
                return value;
            }
            return toKey(value, index + 1);
        };
        if (arrayKey.constructor != Array) {
            arrayKey = [arrayKey];
        }
        const numberSort = !isNaN(sortType) || ["int", "number"].indexOf(sortType) >= 0;
        if (numberSort) {
            if (asc) {
                this.array.sort((a, b) => Number(toKey(a)) - Number(toKey(b)));
            }
            else {
                this.array.sort((b, a) => Number(toKey(a)) - Number(toKey(b)));
            }
        }
        else {
            switch (sortType) {
                case "date":
                case "time":
                case "datetime":
                    if (asc) {
                        this.array.sort((a, b) => {
                            a = new Date(toKey(a, 0));
                            b = new Date(toKey(b, 0));
                            return a == "Invalid Date" || a > b ? -1 : b == "Invalid Date" || a < b ? 1 : 0;
                        });
                    }
                    else {
                        this.array.sort((b, a) => {
                            a = new Date(toKey(a, 0));
                            b = new Date(toKey(b, 0));
                            return a == "Invalid Date" || a > b ? -1 : b == "Invalid Date" || a < b ? 1 : 0;
                        });
                    }
                    break;
                default: //STRING BASED SORT
                    if (asc) {
                        this.array.sort((a, b) => String(toKey(a) || "").toLowerCase() > String(toKey(b) || "").toLowerCase() ? 1 : -1);
                    }
                    else {
                        this.array.sort((b, a) => String(toKey(a) || "").toLowerCase() > String(toKey(b) || "").toLowerCase() ? 1 : -1);
                    }
            }
        }
        //cleanup
        if (this.sortArray.length > 3) {
            this.sortArray.pop();
        }
        this.inSort = false;
        this.loop(true); //cause pages to be updated
    }
}
AckArray.decorators = [
    { type: Directive, args: [{
                selector: "ack-array",
                exportAs: "AckArray"
            },] }
];
AckArray.ctorParameters = () => [
    { type: IterableDiffers }
];
AckArray.propDecorators = {
    pageAt: [{ type: Input }],
    pages: [{ type: Input }],
    pagesChange: [{ type: Output }],
    page: [{ type: Input }],
    pageChange: [{ type: Output }],
    keyMap: [{ type: Input }],
    keyMapChange: [{ type: Output }],
    AckAggregates: [{ type: ContentChildren, args: [AckAggregate,] }],
    idKeys: [{ type: Input }],
    merge: [{ type: Input }],
    array: [{ type: Input }],
    arrayChange: [{ type: Output }],
    array$: [{ type: Input }]
};
export function dataKeysMatch(ao, an, idKeys) {
    for (let x = idKeys.length - 1; x >= 0; --x) {
        let idKey = idKeys[x];
        if (ao[idKey] != null && ao[idKey] !== an[idKey]) {
            return false;
        }
    }
    return true;
}
export function mergeArrays(arrayOriginal, arrayNew, idKeys) {
    //removals
    for (let x = arrayOriginal.length - 1; x >= 0; --x) {
        let ao = arrayOriginal[x];
        let an = arrayNew[x];
        //quick match
        if (an && dataKeysMatch(ao, an, idKeys)) {
            continue;
        }
        let found = false;
        for (let xx = arrayNew.length - 1; xx >= 0; --xx) {
            if (dataKeysMatch(ao, arrayNew[xx], idKeys)) {
                found = true;
                break;
            }
        }
        if (found)
            continue;
        arrayOriginal.splice(x, 1);
    }
    //merge and add
    for (let x = 0; x < arrayNew.length; ++x) {
        let ao = arrayOriginal[x];
        let an = arrayNew[x];
        let found = false;
        //try by index match first, may to near identical arrays
        if (ao && dataKeysMatch(ao, an, idKeys)) {
            mergeObjects(ao, an);
            continue;
        }
        //try to match by loop against loop
        for (let xx = arrayOriginal.length - 1; xx >= 0; --xx) {
            ao = arrayOriginal[xx];
            if (dataKeysMatch(ao, an, idKeys)) {
                mergeObjects(ao, an);
                found = true;
                continue;
            }
        }
        if (found) {
            continue;
        }
        //not found, add to array
        //arrayOriginal.unshift(an)
        arrayOriginal.splice(x, 0, an);
    }
}
function mergeObjects(ao, an) {
    for (let x in ao) {
        delete ao[x];
    }
    Object.assign(ao, an);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQWNrQXJyYXkuZGlyZWN0aXZlLmpzIiwic291cmNlUm9vdCI6Ii4uLy4uL3NyYy8iLCJzb3VyY2VzIjpbImRpcmVjdGl2ZXMvQWNrQXJyYXkuZGlyZWN0aXZlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUNBLE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSwrQkFBK0IsQ0FBQTtBQUMvRCxPQUFPLEVBQ0wsWUFBWSxFQUFFLE1BQU0sRUFBRSxLQUFLLEVBQzNCLGVBQWUsRUFBRSxTQUFTLEVBQzFCLGVBQWUsRUFFaEIsTUFBTSxlQUFlLENBQUE7QUFDdEIsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLDBCQUEwQixDQUFBO0FBZ0JwRCxNQUFNLE9BQU8sUUFBUTtJQXNDdEIsWUFDVSxnQkFBaUM7UUFBakMscUJBQWdCLEdBQWhCLGdCQUFnQixDQUFpQjtRQW5DM0MsV0FBTSxHQUFPLEVBQUUsQ0FBQTtRQUVmLFdBQU0sR0FBVyxLQUFLLENBQUE7UUFDdEIsY0FBUyxHQUFhLEVBQUUsQ0FBQTtRQUdmLFdBQU0sR0FBVSxDQUFDLENBQUEsQ0FBQSwwQkFBMEI7UUFFMUMsZ0JBQVcsR0FBNEIsSUFBSSxlQUFlLENBQUMsSUFBSSxDQUFDLENBQUE7UUFDMUUsa0VBQWtFO1FBRWxFLDBEQUEwRDtRQUNqRCxTQUFJLEdBQVUsQ0FBQyxDQUFBO1FBQ2QsZUFBVSxHQUF3QixJQUFJLFlBQVksRUFBRSxDQUFBO1FBSXBELGlCQUFZLEdBQUcsSUFBSSxZQUFZLEVBQUUsQ0FBQTtRQUUzQyxjQUFTLEdBQXlCLElBQUksWUFBWSxFQUFFLENBQUE7UUFDcEQsYUFBUSxHQUFzQixJQUFJLFlBQVksRUFBRSxDQUFBO1FBQ2hELFlBQU8sR0FBc0IsSUFBSSxZQUFZLEVBQUUsQ0FBQTtRQVNyQyxnQkFBVyxHQUFHLElBQUksWUFBWSxFQUFFLENBQUE7UUFPeEMsU0FBUztRQUNULG9CQUFvQjtRQUNwQixNQUFNLENBQUMsR0FBRyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFBO1FBQ3hDLElBQUksQ0FBQyxjQUFjLEdBQUcsQ0FBQyxDQUFDLE1BQU0sRUFBRSxDQUFDO0lBQ25DLENBQUM7SUFFRCxXQUFXO1FBQ1QsSUFBSSxJQUFJLENBQUMsU0FBUyxFQUFFO1lBQ2xCLElBQUksQ0FBQyxTQUFTLENBQUMsV0FBVyxFQUFFLENBQUE7U0FDN0I7SUFDSCxDQUFDO0lBRUQsUUFBUTtRQUNOLElBQUksSUFBSSxDQUFDLFlBQVksQ0FBQyxTQUFTLENBQUMsTUFBTSxFQUFFO1lBQ3RDLElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxFQUFFO2dCQUNoQixPQUFPLENBQUMsT0FBTyxFQUFFLENBQUMsSUFBSSxDQUFDLEdBQUUsRUFBRTtvQkFDekIsSUFBSSxDQUFDLE1BQU0sR0FBRyxFQUFFLENBQUE7b0JBQ2hCLElBQUksQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQTtnQkFDckMsQ0FBQyxDQUFDLENBQUE7YUFDSDtZQUVELElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQTtTQUNyQjtJQUNILENBQUM7SUFFRCxlQUFlO1FBQ2IsSUFBSSxJQUFJLENBQUMsYUFBYSxFQUFFO1lBQ3RCLElBQUksQ0FBQyxjQUFjLENBQUUsSUFBSSxDQUFDLGFBQWEsQ0FBRSxDQUFBO1NBQzFDO1FBRUQsSUFBSSxDQUFDLE1BQU0sR0FBRyxJQUFJLENBQUE7UUFDbEIsT0FBTyxDQUFDLE9BQU8sRUFBRSxDQUFDLElBQUksQ0FBQyxHQUFFLEVBQUUsQ0FDekIsSUFBSSxDQUFDLElBQUksQ0FBRSxJQUFJLENBQUUsQ0FDbEIsQ0FBQTtJQUNILENBQUM7SUFFRCwwQkFBMEI7SUFDMUIsU0FBUztRQUNQLElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTTtZQUFFLE9BQU07UUFFeEIsSUFBSSxPQUFPLEdBQUcsSUFBSSxDQUFDLGNBQWMsQ0FBQyxJQUFJLENBQUUsSUFBSSxDQUFDLEtBQUssQ0FBRSxDQUFDO1FBQ3JELElBQUksT0FBTyxFQUFFO1lBQ1gsT0FBTyxDQUFDLE9BQU8sRUFBRSxDQUFDLElBQUksQ0FBQyxHQUFFLEVBQUUsQ0FDekIsSUFBSSxDQUFDLElBQUksQ0FBRSxLQUFLLENBQUUsQ0FDbkIsQ0FBQTtTQUNGO0lBQ0gsQ0FBQztJQUVELFdBQVcsQ0FBQyxPQUFPO1FBQ2pCLElBQUksT0FBTyxDQUFDLE1BQU0sRUFBRTtZQUNsQixJQUFJLElBQUksQ0FBQyxTQUFTLEVBQUU7Z0JBQ2xCLElBQUksQ0FBQyxTQUFTLENBQUMsV0FBVyxFQUFFLENBQUE7Z0JBQzVCLE9BQU8sSUFBSSxDQUFDLFNBQVMsQ0FBQTthQUN0QjtZQUVELElBQUksSUFBSSxDQUFDLE1BQU0sRUFBRTtnQkFDZixJQUFJLENBQUMsU0FBUyxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsU0FBUyxDQUFDLEtBQUssQ0FBQSxFQUFFO29CQUM1QyxJQUFJLElBQUksQ0FBQyxLQUFLLEVBQUU7d0JBQ2QsV0FBVyxDQUFDLElBQUksQ0FBQyxLQUFLLEVBQUMsS0FBSyxFQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQTtxQkFDMUM7eUJBQUk7d0JBQ0gsTUFBTSxLQUFLLEdBQUcsSUFBSSxDQUFDLEtBQUssSUFBSSxLQUFLLENBQUE7d0JBQ2pDLElBQUksQ0FBQyxLQUFLLEdBQUcsS0FBSyxDQUFBO3dCQUNsQixJQUFJLENBQUMsSUFBSSxDQUFFLEtBQUssQ0FBRSxDQUFBO3FCQUNuQjtnQkFDSCxDQUFDLENBQUMsQ0FBQTthQUNIO1NBQ0Y7UUFFRCxJQUFJLElBQUksR0FBRyxPQUFPLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQTtRQUV2QyxJQUFJLE9BQU8sQ0FBQyxNQUFNLEVBQUU7WUFDbEIsSUFBSSxDQUFDLGVBQWUsRUFBRSxDQUFBO1lBQ3RCLElBQUksR0FBRyxJQUFJLENBQUE7U0FDWjtRQUVELElBQUksSUFBSSxDQUFDLE1BQU0sSUFBSSxJQUFJLEVBQUU7WUFDdkIsT0FBTyxDQUFDLE9BQU8sRUFBRSxDQUFDLElBQUksQ0FBQyxHQUFFLEVBQUUsQ0FDekIsSUFBSSxDQUFDLElBQUksQ0FBRSxJQUFJLENBQUUsQ0FDbEIsQ0FBQTtTQUNGO0lBQ0gsQ0FBQztJQUNIOzs7Ozs7TUFNRTtJQUNBLGNBQWMsQ0FBRSxJQUFtQjtRQUNqQyxJQUFJLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQSxFQUFFO1lBQ2hCLElBQUksTUFBTSxDQUFBO1lBQ1YsUUFBUSxHQUFHLENBQUMsSUFBSSxFQUFFO2dCQUNoQixtQkFBbUI7Z0JBQ25CLE9BQU8sQ0FBQyxDQUFBO29CQUNOLElBQUksQ0FBQyxTQUFTLENBQUMsU0FBUyxDQUFFLEdBQUUsRUFBRSxDQUFBLE1BQU0sR0FBQyxDQUFDLENBQUUsQ0FBQTtvQkFFeEMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFBLEVBQUU7d0JBQzVCLE1BQU0sS0FBSyxHQUFHLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQTt3QkFDMUQsSUFBSSxLQUFLLEVBQUU7NEJBQ1QsTUFBTSxHQUFHLE1BQU0sR0FBRyxLQUFLLENBQUE7eUJBQ3hCO29CQUNILENBQUMsQ0FBQyxDQUFBO29CQUVGLElBQUksQ0FBQyxPQUFPLENBQUMsU0FBUyxDQUFDLEdBQUUsRUFBRTt3QkFDekIsR0FBRyxDQUFDLE1BQU0sR0FBRyxNQUFNLENBQUE7d0JBQ25CLEdBQUcsQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFFLE1BQU0sQ0FBRSxDQUFBO29CQUNqQyxDQUFDLENBQUMsQ0FBQTtpQkFDSDthQUNGO1FBQ0gsQ0FBQyxDQUFDLENBQUE7SUFDSixDQUFDO0lBRUQsa0JBQWtCLENBQUMsSUFBSSxFQUFFLElBQWE7UUFDcEMsS0FBSSxJQUFLLENBQUMsR0FBQyxDQUFDLEVBQUcsQ0FBQyxHQUFHLElBQUksQ0FBQyxNQUFNLEVBQUUsRUFBRyxDQUFDLEVBQUM7WUFDbkMsSUFBSSxPQUFPLEdBQUcsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFBO1lBQ3JCLElBQUksR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUE7WUFDcEIsSUFBSSxJQUFJLElBQUUsSUFBSTtnQkFBRSxPQUFPLElBQUksQ0FBQTtTQUM1QjtRQUNELE9BQU8sSUFBSSxDQUFBO0lBQ2IsQ0FBQztJQUVELElBQUksQ0FBRSxLQUFhO1FBQ2pCLHFCQUFxQjtRQUVyQixJQUFHLENBQUMsSUFBSSxDQUFDLEtBQUssRUFBQztZQUNiLElBQUksQ0FBQyxLQUFLLEdBQUcsRUFBRSxDQUFBO1NBQ2hCO1FBRUQsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUUsS0FBSyxDQUFFLENBQUE7UUFFNUIsTUFBTSxJQUFJLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUE7UUFDOUIsS0FBSSxJQUFJLENBQUMsR0FBQyxDQUFDLEVBQUUsQ0FBQyxHQUFHLElBQUksRUFBRSxFQUFFLENBQUMsRUFBQztZQUN6QixJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxFQUFDLEtBQUssRUFBQyxDQUFDLEVBQUUsSUFBSSxFQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLEVBQUMsQ0FBQyxDQUFBO1NBQ2xEO1FBRUQscUJBQXFCO1FBRXJCLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxFQUFFLENBQUE7SUFDckIsQ0FBQztJQUVELGFBQWE7UUFDWCxJQUFJLElBQUksQ0FBQyxNQUFNLENBQUMsU0FBUztZQUFFLE9BQU07UUFFakMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxTQUFTLEdBQUcsSUFBSSxDQUFBO1FBQzVCLElBQUksQ0FBQyxTQUFTLENBQUMsU0FBUyxDQUFDLEdBQUUsRUFBRSxDQUFBLElBQUksQ0FBQyxNQUFNLEdBQUMsRUFBRSxDQUFDLENBQUE7UUFFNUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxTQUFTLENBQUMsRUFBRSxDQUFBLEVBQUU7WUFDMUIsSUFBSSxHQUFHLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBRSxFQUFFLENBQUMsSUFBSSxDQUFFLENBQUE7WUFDbkMsSUFBSSxDQUFDLE1BQU0sQ0FBRSxHQUFHLENBQUUsR0FBRyxFQUFFLENBQUMsSUFBSSxDQUFBO1FBQzlCLENBQUMsQ0FBQyxDQUFBO1FBRUYsSUFBSSxDQUFDLE9BQU8sQ0FBQyxTQUFTLENBQUMsR0FBRSxFQUFFLENBQUEsSUFBSSxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUE7SUFDakUsQ0FBQztJQUVELHFEQUFxRDtJQUNyRCxlQUFlO1FBQ2IsSUFBSSxJQUFJLENBQUMsTUFBTSxDQUFDLFdBQVc7WUFBRSxPQUFNO1FBRW5DLElBQUksQ0FBQyxNQUFNLENBQUMsV0FBVyxHQUFHLElBQUksQ0FBQTtRQUU5QixJQUFJLEdBQUcsR0FBRyxDQUFDLENBQUE7UUFDWCxJQUFJLElBQUksR0FBRyxDQUFDLENBQUE7UUFFWixJQUFJLENBQUMsU0FBUyxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUEsRUFBRTtZQUM5QixHQUFHLEdBQUcsQ0FBQyxDQUFBO1lBQ1AsSUFBSSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFBO1lBRXhCLElBQUksS0FBSyxFQUFFO2dCQUNULElBQUksQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFFLElBQUksQ0FBQyxJQUFJLEdBQUMsQ0FBQyxDQUFFLENBQUE7YUFDcEM7WUFFRCxJQUFJLENBQUMsS0FBSyxHQUFHLElBQUksQ0FBQyxLQUFLLElBQUksRUFBRSxDQUFBO1lBQzdCLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQSxDQUFBLHdDQUF3QztZQUM3RCxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQTtRQUNyQixDQUFDLENBQUMsQ0FBQTtRQUVGLElBQUksQ0FBQyxRQUFRLENBQUMsU0FBUyxDQUFDLEVBQUUsQ0FBQSxFQUFFO1lBQzFCLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFFLEVBQUUsQ0FBQyxJQUFJLENBQUUsQ0FBQTtZQUUvQixJQUFJLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsTUFBTSxJQUFFLElBQUksQ0FBQyxNQUFNLElBQUksRUFBRSxDQUFDLEtBQUssR0FBQyxJQUFJLEdBQUMsQ0FBQyxFQUFFO2dCQUMxRCxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQTtnQkFDbkIsRUFBRSxHQUFHLENBQUE7YUFDTjtRQUNILENBQUMsQ0FBQyxDQUFBO1FBRUYsSUFBSSxDQUFDLE9BQU8sQ0FBQyxTQUFTLENBQUMsR0FBRSxFQUFFO1lBQ3pCLElBQUcsSUFBSSxDQUFDLElBQUksSUFBSSxJQUFJLENBQUMsSUFBSSxJQUFJLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxFQUFFO2dCQUM5QyxJQUFJLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxHQUFHLENBQUMsQ0FBQyxDQUFBO2FBQ3BDO1lBRUQscUNBQXFDO1lBQ3JDLElBQUksQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFFLElBQUksQ0FBQyxLQUFLLENBQUUsQ0FBQTtRQUNyQyxDQUFDLENBQUMsQ0FBQTtJQUNKLENBQUM7SUFFRCwrQkFBK0I7SUFDL0IsSUFBSSxDQUFDLElBQUk7UUFDUCxJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUE7UUFDckIsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUE7UUFDckIsSUFBSSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFBO1FBQ2pDLElBQUksQ0FBQyxJQUFJLENBQUUsSUFBSSxDQUFFLENBQUE7SUFDbkIsQ0FBQztJQUVELHlDQUF5QztJQUN6QyxTQUFTLENBQUMsSUFBSTtRQUNaLE9BQU8sSUFBSSxDQUFDLE1BQU0sSUFBSSxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxJQUFJLElBQUksQ0FBRSxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFFLENBQUE7SUFDaEUsQ0FBQztJQUVELGVBQWU7UUFDYixJQUFHLElBQUksQ0FBQyxLQUFLLElBQUksSUFBSSxDQUFDLE1BQU0sSUFBSSxJQUFJLENBQUMsTUFBTSxDQUFDLE1BQU0sRUFBQztZQUNqRCxNQUFNLEtBQUssR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFBO1lBQzVCLE9BQU8sSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFBLEVBQUUsQ0FBQSxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQTtTQUN6QztRQUVELE9BQU8sSUFBSSxDQUFDLEtBQUssSUFBSSxFQUFFLENBQUE7SUFDekIsQ0FBQztJQUNIOzs7O01BSUU7SUFDQSxTQUFTLENBQUUsSUFBSTtRQUNiLE1BQU0sS0FBSyxHQUFHLElBQUksQ0FBQyxlQUFlLEVBQUUsQ0FBQTtRQUVwQyxLQUFJLElBQUksQ0FBQyxHQUFDLEtBQUssQ0FBQyxNQUFNLEdBQUMsQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLEVBQUUsRUFBRSxDQUFDLEVBQUM7WUFDcEMsSUFBSSxhQUFhLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxFQUFFLElBQUksRUFBRSxJQUFJLENBQUMsTUFBTSxDQUFDLEVBQUU7Z0JBQzlDLE9BQU8sQ0FBQyxDQUFBO2FBQ1Q7U0FDRjtRQUVELE9BQU8sQ0FBQyxDQUFDLENBQUE7SUFDWCxDQUFDO0lBRUQsTUFBTSxDQUFDLElBQUk7UUFDVCxNQUFNLEtBQUssR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxDQUFBO1FBRWxDLElBQUcsS0FBSyxJQUFFLENBQUMsRUFBQztZQUNWLE9BQU8sSUFBSSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQTtTQUMxQjtRQUVELE9BQU8sSUFBSSxDQUFDLElBQUksQ0FBRSxJQUFJLENBQUUsQ0FBQTtJQUMxQixDQUFDO0lBRUQsSUFBSSxDQUFDLElBQUk7UUFDUCxJQUFJLENBQUMsS0FBSyxFQUFFLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFBO1FBQ3ZCLElBQUksQ0FBQyxJQUFJLENBQUUsS0FBSyxDQUFFLENBQUE7UUFDbEIsT0FBTyxJQUFJLENBQUE7SUFDYixDQUFDO0lBRUQsT0FBTyxDQUFDLElBQUk7UUFDVixJQUFJLENBQUMsS0FBSyxFQUFFLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFBO1FBQzFCLE9BQU8sSUFBSSxDQUFBO0lBQ2IsQ0FBQztJQUVELE1BQU0sQ0FBQyxDQUFRLEVBQUUsQ0FBQyxHQUFDLENBQUM7UUFDbEIsSUFBSSxDQUFDLEtBQUssRUFBRSxDQUFDLE1BQU0sQ0FBQyxDQUFDLEVBQUMsQ0FBQyxDQUFDLENBQUE7UUFDeEIsSUFBSSxDQUFDLElBQUksQ0FBRSxLQUFLLENBQUUsQ0FBQTtRQUNsQixPQUFPLElBQUksQ0FBQTtJQUNiLENBQUM7SUFFRCxLQUFLO1FBQ0gsSUFBRyxDQUFDLElBQUksQ0FBQyxLQUFLO1lBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUUsSUFBSSxDQUFDLEtBQUssR0FBQyxFQUFFLENBQUUsQ0FBQTtRQUNyRCxPQUFPLElBQUksQ0FBQyxLQUFLLENBQUE7SUFDbkIsQ0FBQztJQUVELFVBQVUsQ0FDUixRQUF3QixFQUN4QixRQUE4RDtRQUU5RCxJQUFHLElBQUksQ0FBQyxNQUFNO1lBQUMsT0FBTyxLQUFLLENBQUE7UUFFM0IsSUFBSSxDQUFDLE1BQU0sR0FBRyxJQUFJLENBQUE7UUFDbEIsSUFBSSxHQUFHLEdBQUcsS0FBSyxDQUFBLENBQUEsNERBQTREO1FBRTNFLElBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxNQUFNLElBQUksSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxRQUFRLEVBQUM7WUFDckQsR0FBRyxHQUFHLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUE7WUFDNUIsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsR0FBRztnQkFDbEIsUUFBUSxFQUFDLFFBQVE7Z0JBQ2pCLEdBQUcsRUFBQyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLENBQUMsR0FBRzthQUMxQixDQUFBO1NBQ0g7YUFBSTtZQUNILElBQUksQ0FBQyxTQUFTLENBQUMsT0FBTyxDQUFDO2dCQUNyQixRQUFRLEVBQUMsUUFBUTtnQkFDakIsR0FBRyxFQUFDLEdBQUc7YUFDVCxDQUFDLENBQUE7U0FDRjtRQUVELE1BQU0sS0FBSyxHQUFHLFVBQVMsQ0FBSyxFQUFFLFFBQWEsQ0FBQztZQUMxQyxNQUFNLEtBQUssR0FBRyxDQUFDLENBQUUsUUFBUSxDQUFDLEtBQUssQ0FBQyxDQUFFLENBQUE7WUFDbEMsSUFBSSxLQUFLLElBQUUsSUFBSSxJQUFJLEtBQUssSUFBSSxRQUFRLENBQUMsTUFBTSxHQUFDLENBQUMsRUFBRTtnQkFDN0MsT0FBTyxLQUFLLENBQUE7YUFDYjtZQUNELE9BQU8sS0FBSyxDQUFDLEtBQUssRUFBRSxLQUFLLEdBQUMsQ0FBQyxDQUFDLENBQUE7UUFDOUIsQ0FBQyxDQUFBO1FBRUQsSUFBSSxRQUFRLENBQUMsV0FBVyxJQUFFLEtBQUssRUFBRTtZQUMvQixRQUFRLEdBQUcsQ0FBVSxRQUFRLENBQUUsQ0FBQTtTQUNoQztRQUVELE1BQU0sVUFBVSxHQUFHLENBQUMsS0FBSyxDQUFTLFFBQVEsQ0FBQyxJQUFJLENBQUMsS0FBSyxFQUFDLFFBQVEsQ0FBQyxDQUFDLE9BQU8sQ0FBUyxRQUFRLENBQUMsSUFBRSxDQUFDLENBQUE7UUFFNUYsSUFBSSxVQUFVLEVBQUU7WUFDZCxJQUFHLEdBQUcsRUFBQztnQkFDTCxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBRSxDQUFDLENBQUMsRUFBQyxDQUFDLEVBQUMsRUFBRSxDQUFBLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsR0FBRyxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUUsQ0FBQTthQUM5RDtpQkFBSTtnQkFDSCxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBRSxDQUFDLENBQUMsRUFBQyxDQUFDLEVBQUMsRUFBRSxDQUFBLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsR0FBRyxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUUsQ0FBQTthQUM5RDtTQUNGO2FBQUk7WUFDSCxRQUFPLFFBQVEsRUFBQztnQkFDZCxLQUFLLE1BQU0sQ0FBQztnQkFDWixLQUFLLE1BQU0sQ0FBQztnQkFDWixLQUFLLFVBQVU7b0JBQ2IsSUFBRyxHQUFHLEVBQUM7d0JBQ0wsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUUsQ0FBQyxDQUFDLEVBQUMsQ0FBQyxFQUFDLEVBQUU7NEJBQ3RCLENBQUMsR0FBRyxJQUFJLElBQUksQ0FBRSxLQUFLLENBQUMsQ0FBQyxFQUFDLENBQUMsQ0FBQyxDQUFFLENBQUE7NEJBQzFCLENBQUMsR0FBRyxJQUFJLElBQUksQ0FBRSxLQUFLLENBQUMsQ0FBQyxFQUFDLENBQUMsQ0FBQyxDQUFFLENBQUE7NEJBQzFCLE9BQU8sQ0FBQyxJQUFFLGNBQWMsSUFBSSxDQUFDLEdBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFFLGNBQWMsSUFBSSxDQUFDLEdBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQTt3QkFDekUsQ0FBQyxDQUFDLENBQUE7cUJBQ0g7eUJBQUk7d0JBQ0gsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUUsQ0FBQyxDQUFDLEVBQUMsQ0FBQyxFQUFDLEVBQUU7NEJBQ3RCLENBQUMsR0FBRyxJQUFJLElBQUksQ0FBRSxLQUFLLENBQUMsQ0FBQyxFQUFDLENBQUMsQ0FBQyxDQUFFLENBQUE7NEJBQzFCLENBQUMsR0FBRyxJQUFJLElBQUksQ0FBRSxLQUFLLENBQUMsQ0FBQyxFQUFDLENBQUMsQ0FBQyxDQUFFLENBQUE7NEJBQzFCLE9BQU8sQ0FBQyxJQUFFLGNBQWMsSUFBSSxDQUFDLEdBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFFLGNBQWMsSUFBSSxDQUFDLEdBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQTt3QkFDekUsQ0FBQyxDQUFDLENBQUE7cUJBQ0g7b0JBQ0QsTUFBTTtnQkFFUixTQUFRLG1CQUFtQjtvQkFDekIsSUFBRyxHQUFHLEVBQUM7d0JBQ0wsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUUsQ0FBQyxDQUFDLEVBQUMsQ0FBQyxFQUFDLEVBQUUsQ0FBQSxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxJQUFFLEVBQUUsQ0FBQyxDQUFDLFdBQVcsRUFBRSxHQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLElBQUUsRUFBRSxDQUFDLENBQUMsV0FBVyxFQUFFLENBQUEsQ0FBQyxDQUFBLENBQUMsQ0FBQSxDQUFDLENBQUEsQ0FBQyxDQUFDLENBQUUsQ0FBQTtxQkFDckc7eUJBQUk7d0JBQ0gsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUUsQ0FBQyxDQUFDLEVBQUMsQ0FBQyxFQUFDLEVBQUUsQ0FBQSxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxJQUFFLEVBQUUsQ0FBQyxDQUFDLFdBQVcsRUFBRSxHQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLElBQUUsRUFBRSxDQUFDLENBQUMsV0FBVyxFQUFFLENBQUEsQ0FBQyxDQUFBLENBQUMsQ0FBQSxDQUFDLENBQUEsQ0FBQyxDQUFDLENBQUUsQ0FBQTtxQkFDckc7YUFDSjtTQUNGO1FBRUQsU0FBUztRQUNULElBQUksSUFBSSxDQUFDLFNBQVMsQ0FBQyxNQUFNLEdBQUMsQ0FBQyxFQUFFO1lBQzNCLElBQUksQ0FBQyxTQUFTLENBQUMsR0FBRyxFQUFFLENBQUE7U0FDckI7UUFFRCxJQUFJLENBQUMsTUFBTSxHQUFHLEtBQUssQ0FBQTtRQUNuQixJQUFJLENBQUMsSUFBSSxDQUFFLElBQUksQ0FBRSxDQUFBLENBQUEsMkJBQTJCO0lBQzlDLENBQUM7OztZQW5ZRixTQUFTLFNBQUM7Z0JBQ1QsUUFBUSxFQUFDLFdBQVc7Z0JBQ3BCLFFBQVEsRUFBQyxVQUFVO2FBQ3BCOzs7WUFuQkMsZUFBZTs7O3FCQTZCZCxLQUFLO29CQUNMLEtBQUs7MEJBQ0wsTUFBTTttQkFJTixLQUFLO3lCQUNMLE1BQU07cUJBR04sS0FBSzsyQkFDTCxNQUFNOzRCQU1OLGVBQWUsU0FBQyxZQUFZO3FCQUc1QixLQUFLO29CQUNMLEtBQUs7b0JBRUwsS0FBSzswQkFDTCxNQUFNO3FCQUVOLEtBQUs7O0FBZ1dSLE1BQU0sVUFBVSxhQUFhLENBQUMsRUFBRSxFQUFDLEVBQUUsRUFBQyxNQUFlO0lBQ2pELEtBQUksSUFBSSxDQUFDLEdBQUMsTUFBTSxDQUFDLE1BQU0sR0FBQyxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsRUFBRSxFQUFFLENBQUMsRUFBQztRQUNyQyxJQUFJLEtBQUssR0FBRyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUE7UUFDckIsSUFBRyxFQUFFLENBQUMsS0FBSyxDQUFDLElBQUUsSUFBSSxJQUFJLEVBQUUsQ0FBQyxLQUFLLENBQUMsS0FBSyxFQUFFLENBQUMsS0FBSyxDQUFDLEVBQUU7WUFDN0MsT0FBTyxLQUFLLENBQUE7U0FDYjtLQUNGO0lBQ0QsT0FBTyxJQUFJLENBQUE7QUFDYixDQUFDO0FBRUQsTUFBTSxVQUFVLFdBQVcsQ0FDekIsYUFBbUIsRUFDbkIsUUFBYyxFQUNkLE1BQWU7SUFHZixVQUFVO0lBQ1YsS0FBSSxJQUFJLENBQUMsR0FBQyxhQUFhLENBQUMsTUFBTSxHQUFDLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxFQUFFLEVBQUUsQ0FBQyxFQUFDO1FBQzVDLElBQUksRUFBRSxHQUFHLGFBQWEsQ0FBQyxDQUFDLENBQUMsQ0FBQTtRQUN6QixJQUFJLEVBQUUsR0FBRyxRQUFRLENBQUMsQ0FBQyxDQUFDLENBQUE7UUFFcEIsYUFBYTtRQUNiLElBQUcsRUFBRSxJQUFJLGFBQWEsQ0FBQyxFQUFFLEVBQUMsRUFBRSxFQUFDLE1BQU0sQ0FBQyxFQUFFO1lBQ3BDLFNBQVE7U0FDVDtRQUVELElBQUksS0FBSyxHQUFHLEtBQUssQ0FBQTtRQUNqQixLQUFJLElBQUksRUFBRSxHQUFDLFFBQVEsQ0FBQyxNQUFNLEdBQUMsQ0FBQyxFQUFFLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRSxFQUFFLEVBQUM7WUFDMUMsSUFBSSxhQUFhLENBQUMsRUFBRSxFQUFFLFFBQVEsQ0FBQyxFQUFFLENBQUMsRUFBRSxNQUFNLENBQUMsRUFBQztnQkFDMUMsS0FBSyxHQUFHLElBQUksQ0FBQTtnQkFDWixNQUFLO2FBQ047U0FDRjtRQUVELElBQUcsS0FBSztZQUFDLFNBQVE7UUFFakIsYUFBYSxDQUFDLE1BQU0sQ0FBQyxDQUFDLEVBQUMsQ0FBQyxDQUFDLENBQUE7S0FDMUI7SUFFRCxlQUFlO0lBQ2YsS0FBSSxJQUFJLENBQUMsR0FBQyxDQUFDLEVBQUUsQ0FBQyxHQUFHLFFBQVEsQ0FBQyxNQUFNLEVBQUUsRUFBRSxDQUFDLEVBQUM7UUFDcEMsSUFBSSxFQUFFLEdBQUcsYUFBYSxDQUFDLENBQUMsQ0FBQyxDQUFBO1FBQ3pCLElBQUksRUFBRSxHQUFHLFFBQVEsQ0FBQyxDQUFDLENBQUMsQ0FBQTtRQUNwQixJQUFJLEtBQUssR0FBRyxLQUFLLENBQUE7UUFFakIsd0RBQXdEO1FBQ3hELElBQUcsRUFBRSxJQUFJLGFBQWEsQ0FBQyxFQUFFLEVBQUMsRUFBRSxFQUFDLE1BQU0sQ0FBQyxFQUFDO1lBQ25DLFlBQVksQ0FBQyxFQUFFLEVBQUUsRUFBRSxDQUFDLENBQUE7WUFDcEIsU0FBUTtTQUNUO1FBRUQsbUNBQW1DO1FBQ25DLEtBQUksSUFBSSxFQUFFLEdBQUMsYUFBYSxDQUFDLE1BQU0sR0FBQyxDQUFDLEVBQUUsRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFLEVBQUUsRUFBQztZQUMvQyxFQUFFLEdBQUcsYUFBYSxDQUFDLEVBQUUsQ0FBQyxDQUFBO1lBQ3RCLElBQUksYUFBYSxDQUFDLEVBQUUsRUFBQyxFQUFFLEVBQUMsTUFBTSxDQUFDLEVBQUU7Z0JBQy9CLFlBQVksQ0FBQyxFQUFFLEVBQUUsRUFBRSxDQUFDLENBQUE7Z0JBQ3BCLEtBQUssR0FBRyxJQUFJLENBQUE7Z0JBQ1osU0FBUTthQUNUO1NBQ0Y7UUFFRCxJQUFJLEtBQUssRUFBRTtZQUNULFNBQVE7U0FDVDtRQUVELHlCQUF5QjtRQUN6QiwyQkFBMkI7UUFDM0IsYUFBYSxDQUFDLE1BQU0sQ0FBQyxDQUFDLEVBQUMsQ0FBQyxFQUFDLEVBQUUsQ0FBQyxDQUFBO0tBQzdCO0FBQ0gsQ0FBQztBQUdELFNBQVMsWUFBWSxDQUFDLEVBQVMsRUFBRSxFQUFTO0lBQ3hDLEtBQUksSUFBSSxDQUFDLElBQUksRUFBRSxFQUFDO1FBQ2QsT0FBTyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUE7S0FDYjtJQUNELE1BQU0sQ0FBQyxNQUFNLENBQUMsRUFBRSxFQUFFLEVBQUUsQ0FBQyxDQUFBO0FBQ3ZCLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBTdWJzY3JpcHRpb24gfSBmcm9tIFwicnhqcy9pbnRlcm5hbC9TdWJzY3JpcHRpb25cIlxuaW1wb3J0IHsgQmVoYXZpb3JTdWJqZWN0IH0gZnJvbSBcInJ4anMvaW50ZXJuYWwvQmVoYXZpb3JTdWJqZWN0XCJcbmltcG9ydCB7XG4gIEV2ZW50RW1pdHRlciwgT3V0cHV0LCBJbnB1dCxcbiAgQ29udGVudENoaWxkcmVuLCBEaXJlY3RpdmUsXG4gIEl0ZXJhYmxlRGlmZmVycywgXG4gIEl0ZXJhYmxlRGlmZmVyXG59IGZyb20gXCJAYW5ndWxhci9jb3JlXCJcbmltcG9ydCB7IEFja0FnZ3JlZ2F0ZSB9IGZyb20gXCIuL0Fja0FnZ3JlZ2F0ZS5kaXJlY3RpdmVcIlxuLy9pbXBvcnQgeyBBY2tBcnJheUpvaW4gfSBmcm9tIFwiLi9BY2tBcnJheUpvaW4uZGlyZWN0aXZlXCJcblxuZXhwb3J0IGludGVyZmFjZSBzb3J0RGVme1xuICBhcnJheUtleSA6IHN0cmluZyB8IHN0cmluZ1tdXG4gIGFzYyAgICAgIDogYm9vbGVhblxufVxuXG5leHBvcnQgaW50ZXJmYWNlIGxvb3B7XG4gIGluZGV4Om51bWJlclxuICBpdGVtOmFueVxufVxuXG5ARGlyZWN0aXZlKHtcbiAgc2VsZWN0b3I6XCJhY2stYXJyYXlcIixcbiAgZXhwb3J0QXM6XCJBY2tBcnJheVwiXG59KSBleHBvcnQgY2xhc3MgQWNrQXJyYXl7XG4gIGFycmF5JHN1YjpTdWJzY3JpcHRpb25cbiAgaXRlcmFibGVEaWZmZXI6IEl0ZXJhYmxlRGlmZmVyPGFueVtdPi8vY2hhbmdlIGRldGVjdGlvblxuICBpbml0ZWQ6Ym9vbGVhblxuICBwdXNoZWQ6YW55ID0ge31cblxuICBpblNvcnQ6Ym9vbGVhbiA9IGZhbHNlXG4gIHNvcnRBcnJheTpzb3J0RGVmW10gPSBbXVxuICAgXG5cbiAgQElucHV0KCkgcGFnZUF0Om51bWJlciA9IDAvL3doZW4gdG8gcGFnZSBha2EgbWF4cm93c1xuICBASW5wdXQoKSBwYWdlczphbnlbXVtdLy8oYW55W10pW11cbiAgQE91dHB1dCgpIHBhZ2VzQ2hhbmdlOkJlaGF2aW9yU3ViamVjdDxhbnlbXVtdPiA9IG5ldyBCZWhhdmlvclN1YmplY3QobnVsbClcbiAgLy9AT3V0cHV0KCkgcGFnZXNDaGFuZ2U6RXZlbnRFbWl0dGVyPGFueVtdW10+ID0gbmV3IEV2ZW50RW1pdHRlcigpXG4gIFxuICAvL2EgY2hhbmNlIHRvIGtub3cgd2hlbiBjdXJyZW50IHZpZXdlZCBwYWdlIHNob3VsZCBiZSB6ZXJvXG4gIEBJbnB1dCgpIHBhZ2U6bnVtYmVyID0gMFxuICBAT3V0cHV0KCkgcGFnZUNoYW5nZTpFdmVudEVtaXR0ZXI8bnVtYmVyPiA9IG5ldyBFdmVudEVtaXR0ZXIoKVxuXG4gIC8vZGVzY3JpYmVzIHVuaXF1ZSBmaWVsZHMgb2YgYW4gb2JqZWN0XG4gIEBJbnB1dCgpIGtleU1hcDphbnlcbiAgQE91dHB1dCgpIGtleU1hcENoYW5nZSA9IG5ldyBFdmVudEVtaXR0ZXIoKVxuXG4gIGxvb3BTdGFydDpFdmVudEVtaXR0ZXI8Ym9vbGVhbj4gPSBuZXcgRXZlbnRFbWl0dGVyKClcbiAgbG9vcEVhY2g6RXZlbnRFbWl0dGVyPGxvb3A+ID0gbmV3IEV2ZW50RW1pdHRlcigpXG4gIGxvb3BFbmQ6RXZlbnRFbWl0dGVyPHZvaWQ+ID0gbmV3IEV2ZW50RW1pdHRlcigpXG5cbiAgQENvbnRlbnRDaGlsZHJlbihBY2tBZ2dyZWdhdGUpIEFja0FnZ3JlZ2F0ZXM6QWNrQWdncmVnYXRlW11cbiAgLy9AQ29udGVudENoaWxkcmVuKEFja0FycmF5Sm9pbikgQWNrQXJyYXlKb2luczpBY2tBcnJheUpvaW5bXVxuXG4gIEBJbnB1dCgpIGlkS2V5czpzdHJpbmdbXVxuICBASW5wdXQoKSBtZXJnZTpib29sZWFuLy9uZXcgYXJyYXlzIHdpbGwgbWVyZ2Ugd2l0aCBvcmlnaW5hbFxuXG4gIEBJbnB1dCgpIGFycmF5OmFueVtdLy8tZGVwcmVjYXRlZCB1c2UgYXJyYXkkXG4gIEBPdXRwdXQoKSBhcnJheUNoYW5nZSA9IG5ldyBFdmVudEVtaXR0ZXIoKVxuXG4gIEBJbnB1dCgpIGFycmF5JDpFdmVudEVtaXR0ZXI8YW55W10+XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSBfaXRlcmFibGVEaWZmZXJzOiBJdGVyYWJsZURpZmZlcnNcbiAgKXtcbiAgICAvL3N1cGVyKClcbiAgICAvL3dhdGNoIGRlZXAgY2hhbmdlc1xuICAgIGNvbnN0IGYgPSB0aGlzLl9pdGVyYWJsZURpZmZlcnMuZmluZChbXSlcbiAgICB0aGlzLml0ZXJhYmxlRGlmZmVyID0gZi5jcmVhdGUoKTtcbiAgfVxuXG4gIG5nT25EZXN0cm95KCl7XG4gICAgaWYoIHRoaXMuYXJyYXkkc3ViICl7XG4gICAgICB0aGlzLmFycmF5JHN1Yi51bnN1YnNjcmliZSgpXG4gICAgfVxuICB9XG5cbiAgbmdPbkluaXQoKXtcbiAgICBpZiggdGhpcy5rZXlNYXBDaGFuZ2Uub2JzZXJ2ZXJzLmxlbmd0aCApe1xuICAgICAgaWYoICF0aGlzLmtleU1hcCApe1xuICAgICAgICBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpPT57XG4gICAgICAgICAgdGhpcy5rZXlNYXAgPSB7fVxuICAgICAgICAgIHRoaXMua2V5TWFwQ2hhbmdlLmVtaXQodGhpcy5rZXlNYXApXG4gICAgICAgIH0pXG4gICAgICB9XG5cbiAgICAgIHRoaXMucHVzaENyZWF0ZU1hcCgpXG4gICAgfVxuICB9XG5cbiAgbmdBZnRlclZpZXdJbml0KCl7ICAgXG4gICAgaWYoIHRoaXMuQWNrQWdncmVnYXRlcyApe1xuICAgICAgdGhpcy5wdXNoQWdncmVnYXRlcyggdGhpcy5BY2tBZ2dyZWdhdGVzIClcbiAgICB9XG5cbiAgICB0aGlzLmluaXRlZCA9IHRydWVcbiAgICBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpPT5cbiAgICAgIHRoaXMubG9vcCggdHJ1ZSApXG4gICAgKVxuICB9XG5cbiAgLy93YXRjaCBhcnJheSBkZWVwIGNoYW5nZXNcbiAgbmdEb0NoZWNrKCkge1xuICAgIGlmKCAhdGhpcy5pbml0ZWQgKXJldHVybiBcbiAgICBcbiAgICBsZXQgY2hhbmdlcyA9IHRoaXMuaXRlcmFibGVEaWZmZXIuZGlmZiggdGhpcy5hcnJheSApO1xuICAgIGlmIChjaGFuZ2VzKSB7XG4gICAgICBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpPT5cbiAgICAgICAgdGhpcy5sb29wKCBmYWxzZSApXG4gICAgICApXG4gICAgfVxuICB9XG5cbiAgbmdPbkNoYW5nZXMoY2hhbmdlcyl7XG4gICAgaWYoIGNoYW5nZXMuYXJyYXkkICl7XG4gICAgICBpZiggdGhpcy5hcnJheSRzdWIgKXtcbiAgICAgICAgdGhpcy5hcnJheSRzdWIudW5zdWJzY3JpYmUoKVxuICAgICAgICBkZWxldGUgdGhpcy5hcnJheSRzdWJcbiAgICAgIH1cblxuICAgICAgaWYoIHRoaXMuYXJyYXkkICl7XG4gICAgICAgIHRoaXMuYXJyYXkkc3ViID0gdGhpcy5hcnJheSQuc3Vic2NyaWJlKGFycmF5PT57XG4gICAgICAgICAgaWYoIHRoaXMubWVyZ2UgKXtcbiAgICAgICAgICAgIG1lcmdlQXJyYXlzKHRoaXMuYXJyYXksYXJyYXksdGhpcy5pZEtleXMpXG4gICAgICAgICAgfWVsc2V7ICAgICAgICAgIFxuICAgICAgICAgICAgY29uc3QgcmVzZXQgPSB0aGlzLmFycmF5ICE9IGFycmF5XG4gICAgICAgICAgICB0aGlzLmFycmF5ID0gYXJyYXlcbiAgICAgICAgICAgIHRoaXMubG9vcCggcmVzZXQgKVxuICAgICAgICAgIH1cbiAgICAgICAgfSlcbiAgICAgIH1cbiAgICB9XG5cbiAgICBsZXQgbG9vcCA9IGNoYW5nZXMuYXJyYXkgPyB0cnVlIDogZmFsc2VcblxuICAgIGlmKCBjaGFuZ2VzLnBhZ2VBdCApe1xuICAgICAgdGhpcy5wdXNoQ3JlYXRlUGFnZXMoKVxuICAgICAgbG9vcCA9IHRydWVcbiAgICB9XG4gICAgXG4gICAgaWYoIHRoaXMuaW5pdGVkICYmIGxvb3AgKXtcbiAgICAgIFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCk9PlxuICAgICAgICB0aGlzLmxvb3AoIHRydWUgKVxuICAgICAgKVxuICAgIH1cbiAgfVxuLypcbiAgcGVyZm9ybUpvaW5zKCl7XG4gICAgdGhpcy5BY2tBcnJheUpvaW5zLmZvckVhY2goam9pbj0+XG4gICAgICBqb2luLmpvaW5UbyggdGhpcy5hcnJheSApXG4gICAgKVxuICB9XG4qL1xuICBwdXNoQWdncmVnYXRlcyggYWdnczpBY2tBZ2dyZWdhdGVbXSApe1xuICAgIGFnZ3MuZm9yRWFjaChhZ2c9PntcbiAgICAgIGxldCBtZW1vcnlcbiAgICAgIHN3aXRjaCggYWdnLnR5cGUgKXtcbiAgICAgICAgLy9kZWZhdWx0IGlzIHRvIHN1bVxuICAgICAgICBkZWZhdWx0OntcbiAgICAgICAgICB0aGlzLmxvb3BTdGFydC5zdWJzY3JpYmUoICgpPT5tZW1vcnk9MCApXG5cbiAgICAgICAgICB0aGlzLmxvb3BFYWNoLnN1YnNjcmliZShsb29wPT57XG4gICAgICAgICAgICBjb25zdCB2YWx1ZSA9IHRoaXMuZ2V0SXRlbVZhbHVlQnlLZXlzKGxvb3AuaXRlbSwgYWdnLmtleXMpXG4gICAgICAgICAgICBpZiggdmFsdWUgKXtcbiAgICAgICAgICAgICAgbWVtb3J5ID0gbWVtb3J5ICsgdmFsdWVcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9KVxuXG4gICAgICAgICAgdGhpcy5sb29wRW5kLnN1YnNjcmliZSgoKT0+e1xuICAgICAgICAgICAgYWdnLm91dHB1dCA9IG1lbW9yeVxuICAgICAgICAgICAgYWdnLm91dHB1dENoYW5nZS5lbWl0KCBtZW1vcnkgKVxuICAgICAgICAgIH0pXG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9KVxuICB9XG5cbiAgZ2V0SXRlbVZhbHVlQnlLZXlzKGl0ZW0sIGtleXM6c3RyaW5nW10pe1xuICAgIGZvcihsZXQgIHg9MDsgIHggPCBrZXlzLmxlbmd0aDsgKysgeCl7XG4gICAgICBsZXQga2V5TmFtZSA9IGtleXNbeF1cbiAgICAgIGl0ZW0gPSBpdGVtW2tleU5hbWVdXG4gICAgICBpZiggaXRlbT09bnVsbCApcmV0dXJuIG51bGxcbiAgICB9XG4gICAgcmV0dXJuIGl0ZW1cbiAgfVxuXG4gIGxvb3AoIHJlc2V0OmJvb2xlYW4gKSA6IHZvaWR7XG4gICAgLy9zdXBlci5sb29wKCByZXNldCApXG5cbiAgICBpZighdGhpcy5hcnJheSl7XG4gICAgICB0aGlzLmFycmF5ID0gW11cbiAgICB9XG5cbiAgICB0aGlzLmxvb3BTdGFydC5lbWl0KCByZXNldCApXG5cbiAgICBjb25zdCBsYXN0ID0gdGhpcy5hcnJheS5sZW5ndGhcbiAgICBmb3IobGV0IHg9MDsgeCA8IGxhc3Q7ICsreCl7XG4gICAgICB0aGlzLmxvb3BFYWNoLmVtaXQoe2luZGV4OngsIGl0ZW06dGhpcy5hcnJheVt4XX0pXG4gICAgfVxuXG4gICAgLy90aGlzLnBlcmZvcm1Kb2lucygpXG4gICAgXG4gICAgdGhpcy5sb29wRW5kLmVtaXQoKVxuICB9XG5cbiAgcHVzaENyZWF0ZU1hcCgpe1xuICAgIGlmKCB0aGlzLnB1c2hlZC5jcmVhdGVNYXAgKXJldHVyblxuXG4gICAgdGhpcy5wdXNoZWQuY3JlYXRlTWFwID0gdHJ1ZVxuICAgIHRoaXMubG9vcFN0YXJ0LnN1YnNjcmliZSgoKT0+dGhpcy5rZXlNYXA9e30pXG4gICAgXG4gICAgdGhpcy5sb29wRWFjaC5zdWJzY3JpYmUob2I9PntcbiAgICAgIGxldCBrZXkgPSB0aGlzLmdldEl0ZW1JZCggb2IuaXRlbSApXG4gICAgICB0aGlzLmtleU1hcFsga2V5IF0gPSBvYi5pdGVtXG4gICAgfSlcbiAgICBcbiAgICB0aGlzLmxvb3BFbmQuc3Vic2NyaWJlKCgpPT50aGlzLmtleU1hcENoYW5nZS5lbWl0KHRoaXMua2V5TWFwKSlcbiAgfVxuXG4gIC8qKiBhZGRzIHRvIGxvb3AgZnVuY3Rpb25hbGl0eSBob3cgdG8gY3JlYXRlIHBhZ2VzICovXG4gIHB1c2hDcmVhdGVQYWdlcygpe1xuICAgIGlmKCB0aGlzLnB1c2hlZC5jcmVhdGVQYWdlcyApcmV0dXJuXG5cbiAgICB0aGlzLnB1c2hlZC5jcmVhdGVQYWdlcyA9IHRydWVcblxuICAgIGxldCBwb3MgPSAwXG4gICAgbGV0IGxhc3QgPSAwXG4gICAgXG4gICAgdGhpcy5sb29wU3RhcnQuc3Vic2NyaWJlKHJlc2V0PT57XG4gICAgICBwb3MgPSAwXG4gICAgICBsYXN0ID0gdGhpcy5hcnJheS5sZW5ndGhcblxuICAgICAgaWYoIHJlc2V0ICl7XG4gICAgICAgIHRoaXMucGFnZUNoYW5nZS5lbWl0KCB0aGlzLnBhZ2U9MCApXG4gICAgICB9XG5cbiAgICAgIHRoaXMucGFnZXMgPSB0aGlzLnBhZ2VzIHx8IFtdXG4gICAgICB0aGlzLnBhZ2VzLmxlbmd0aCA9IDAvL2RvbnQgYnJlYWsgYmluZGluZyBpZiBwYWdlcyByZW1lbWJlcmVkXG4gICAgICB0aGlzLnBhZ2VzLnB1c2goW10pXG4gICAgfSlcbiAgICBcbiAgICB0aGlzLmxvb3BFYWNoLnN1YnNjcmliZShvYj0+e1xuICAgICAgdGhpcy5wYWdlc1twb3NdLnB1c2goIG9iLml0ZW0gKVxuXG4gICAgICBpZiggdGhpcy5wYWdlc1twb3NdLmxlbmd0aD09dGhpcy5wYWdlQXQgJiYgb2IuaW5kZXg8bGFzdC0xICl7XG4gICAgICAgIHRoaXMucGFnZXMucHVzaChbXSlcbiAgICAgICAgKytwb3NcbiAgICAgIH1cbiAgICB9KVxuXG4gICAgdGhpcy5sb29wRW5kLnN1YnNjcmliZSgoKT0+e1xuICAgICAgaWYodGhpcy5wYWdlICYmIHRoaXMucGFnZSA+PSB0aGlzLnBhZ2VzLmxlbmd0aCkge1xuICAgICAgICB0aGlzLnBhZ2VDaGFuZ2UuZW1pdCh0aGlzLnBhZ2UgPSAwKVxuICAgICAgfVxuXG4gICAgICAvL3RoaXMucGFnZXNDaGFuZ2UuZW1pdCggdGhpcy5wYWdlcyApXG4gICAgICB0aGlzLnBhZ2VzQ2hhbmdlLm5leHQoIHRoaXMucGFnZXMgKVxuICAgIH0pXG4gIH1cblxuICAvL3JlZHVjZSBhcnJheSBkb3duIHRvIG9uZSBpdGVtXG4gIG9ubHkoaXRlbSl7XG4gICAgdGhpcy5hcnJheS5sZW5ndGggPSAwXG4gICAgdGhpcy5hcnJheS5wdXNoKGl0ZW0pXG4gICAgdGhpcy5hcnJheUNoYW5nZS5lbWl0KHRoaXMuYXJyYXkpXG4gICAgdGhpcy5sb29wKCB0cnVlIClcbiAgfVxuXG4gIC8vbG9va3MgdXAgaWQgb3IgdGhlIGl0ZW0gaXRzZWxmIGlzIGFuIElEXG4gIGdldEl0ZW1JZChpdGVtKTphbnl7XG4gICAgcmV0dXJuIHRoaXMuaWRLZXlzICYmIHRoaXMuaWRLZXlzWzBdICYmIGl0ZW1bIHRoaXMuaWRLZXlzWzBdIF1cbiAgfVxuXG4gIGdldENvbXBhcmVBcnJheSgpOihzdHJpbmd8bnVtYmVyKVtde1xuICAgIGlmKHRoaXMuYXJyYXkgJiYgdGhpcy5pZEtleXMgJiYgdGhpcy5pZEtleXMubGVuZ3RoKXtcbiAgICAgIGNvbnN0IGlkS2V5ID0gdGhpcy5pZEtleXNbMF1cbiAgICAgIHJldHVybiB0aGlzLmFycmF5Lm1hcChpdGVtPT5pdGVtW2lkS2V5XSlcbiAgICB9XG5cbiAgICByZXR1cm4gdGhpcy5hcnJheSB8fCBbXVxuICB9XG4vKlxuICBzZWxlY3RlZChpdGVtKXtcbiAgICByZXR1cm4gdGhpcy5pdGVtSW5kZXgoaXRlbSkgPj0gMCA/IHRydWUgOiBmYWxzZVxuICB9XG4qL1xuICBpdGVtSW5kZXgoIGl0ZW0gKTpudW1iZXJ7XG4gICAgY29uc3QgYXJyYXkgPSB0aGlzLmdldENvbXBhcmVBcnJheSgpXG4gICAgXG4gICAgZm9yKGxldCB4PWFycmF5Lmxlbmd0aC0xOyB4ID49IDA7IC0teCl7XG4gICAgICBpZiggZGF0YUtleXNNYXRjaChhcnJheVt4XSwgaXRlbSwgdGhpcy5pZEtleXMpICl7XG4gICAgICAgIHJldHVybiB4XG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIC0xXG4gIH1cblxuICB0b2dnbGUoaXRlbSl7XG4gICAgY29uc3QgaW5kZXggPSB0aGlzLml0ZW1JbmRleChpdGVtKVxuXG4gICAgaWYoaW5kZXg+PTApe1xuICAgICAgcmV0dXJuIHRoaXMuc3BsaWNlKGluZGV4KVxuICAgIH1cbiAgICBcbiAgICByZXR1cm4gdGhpcy5wdXNoKCBpdGVtIClcbiAgfVxuXG4gIHB1c2goaXRlbSl7XG4gICAgdGhpcy5wYXJhbSgpLnB1c2goaXRlbSlcbiAgICB0aGlzLmxvb3AoIGZhbHNlIClcbiAgICByZXR1cm4gdGhpc1xuICB9XG5cbiAgdW5zaGlmdChpdGVtKXtcbiAgICB0aGlzLnBhcmFtKCkudW5zaGlmdChpdGVtKVxuICAgIHJldHVybiB0aGlzXG4gIH1cblxuICBzcGxpY2UoeDpudW1iZXIsIHk9MSl7XG4gICAgdGhpcy5wYXJhbSgpLnNwbGljZSh4LHkpXG4gICAgdGhpcy5sb29wKCBmYWxzZSApXG4gICAgcmV0dXJuIHRoaXNcbiAgfVxuXG4gIHBhcmFtKCl7XG4gICAgaWYoIXRoaXMuYXJyYXkpdGhpcy5hcnJheUNoYW5nZS5lbWl0KCB0aGlzLmFycmF5PVtdIClcbiAgICByZXR1cm4gdGhpcy5hcnJheVxuICB9XG5cbiAgdG9nZ2xlU29ydChcbiAgICBhcnJheUtleTpzdHJpbmd8c3RyaW5nW10sXG4gICAgc29ydFR5cGU6XCJkYXRlXCJ8XCJ0aW1lXCJ8XCJkYXRldGltZVwifFwiaW50XCJ8XCJudW1iZXJcInxzdHJpbmd8bnVtYmVyXG4gICl7XG4gICAgaWYodGhpcy5pblNvcnQpcmV0dXJuIGZhbHNlXG4gICAgXG4gICAgdGhpcy5pblNvcnQgPSB0cnVlXG4gICAgbGV0IGFzYyA9IGZhbHNlLy9tb3N0IGxpc3RzIGNvbWUgcHJlIHNvcnRlZCBhc2MsIG91ciBkZWZhdWx0IHNob3VsZCBiZSBkZXNjXG4gICAgXG4gICAgaWYodGhpcy5zb3J0QXJyYXkubGVuZ3RoICYmIHRoaXMuc29ydEFycmF5WzBdLmFycmF5S2V5KXtcbiAgICAgIGFzYyA9ICF0aGlzLnNvcnRBcnJheVswXS5hc2NcbiAgICAgIHRoaXMuc29ydEFycmF5WzBdID0ge1xuICAgICAgICBhcnJheUtleTphcnJheUtleSxcbiAgICAgICAgYXNjOiF0aGlzLnNvcnRBcnJheVswXS5hc2NcbiAgICAgICB9XG4gICAgfWVsc2V7XG4gICAgICB0aGlzLnNvcnRBcnJheS51bnNoaWZ0KHtcbiAgICAgICAgYXJyYXlLZXk6YXJyYXlLZXksXG4gICAgICAgIGFzYzphc2NcbiAgICAgfSlcbiAgICB9XG5cbiAgICBjb25zdCB0b0tleSA9IGZ1bmN0aW9uKGE6YW55LCBpbmRleDpudW1iZXI9MCl7XG4gICAgICBjb25zdCB2YWx1ZSA9IGFbIGFycmF5S2V5W2luZGV4XSBdXG4gICAgICBpZiggdmFsdWU9PW51bGwgfHwgaW5kZXggPT0gYXJyYXlLZXkubGVuZ3RoLTEgKXtcbiAgICAgICAgcmV0dXJuIHZhbHVlXG4gICAgICB9XG4gICAgICByZXR1cm4gdG9LZXkodmFsdWUsIGluZGV4KzEpXG4gICAgfVxuXG4gICAgaWYoIGFycmF5S2V5LmNvbnN0cnVjdG9yIT1BcnJheSApe1xuICAgICAgYXJyYXlLZXkgPSBbIDxzdHJpbmc+YXJyYXlLZXkgXVxuICAgIH1cblxuICAgIGNvbnN0IG51bWJlclNvcnQgPSAhaXNOYU4oPG51bWJlcj5zb3J0VHlwZSkgfHwgW1wiaW50XCIsXCJudW1iZXJcIl0uaW5kZXhPZig8c3RyaW5nPnNvcnRUeXBlKT49MFxuXG4gICAgaWYoIG51bWJlclNvcnQgKXtcbiAgICAgIGlmKGFzYyl7XG4gICAgICAgIHRoaXMuYXJyYXkuc29ydCggKGEsYik9Pk51bWJlcih0b0tleShhKSkgLSBOdW1iZXIodG9LZXkoYikpIClcbiAgICAgIH1lbHNle1xuICAgICAgICB0aGlzLmFycmF5LnNvcnQoIChiLGEpPT5OdW1iZXIodG9LZXkoYSkpIC0gTnVtYmVyKHRvS2V5KGIpKSApXG4gICAgICB9XG4gICAgfWVsc2V7XG4gICAgICBzd2l0Y2goc29ydFR5cGUpe1xuICAgICAgICBjYXNlIFwiZGF0ZVwiOlxuICAgICAgICBjYXNlIFwidGltZVwiOlxuICAgICAgICBjYXNlIFwiZGF0ZXRpbWVcIjpcbiAgICAgICAgICBpZihhc2Mpe1xuICAgICAgICAgICAgdGhpcy5hcnJheS5zb3J0KCAoYSxiKT0+e1xuICAgICAgICAgICAgICBhID0gbmV3IERhdGUoIHRvS2V5KGEsMCkgKVxuICAgICAgICAgICAgICBiID0gbmV3IERhdGUoIHRvS2V5KGIsMCkgKVxuICAgICAgICAgICAgICByZXR1cm4gYT09XCJJbnZhbGlkIERhdGVcIiB8fCBhPmIgPyAtMSA6IGI9PVwiSW52YWxpZCBEYXRlXCIgfHwgYTxiID8gMSA6IDBcbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgfWVsc2V7XG4gICAgICAgICAgICB0aGlzLmFycmF5LnNvcnQoIChiLGEpPT57XG4gICAgICAgICAgICAgIGEgPSBuZXcgRGF0ZSggdG9LZXkoYSwwKSApXG4gICAgICAgICAgICAgIGIgPSBuZXcgRGF0ZSggdG9LZXkoYiwwKSApXG4gICAgICAgICAgICAgIHJldHVybiBhPT1cIkludmFsaWQgRGF0ZVwiIHx8IGE+YiA/IC0xIDogYj09XCJJbnZhbGlkIERhdGVcIiB8fCBhPGIgPyAxIDogMFxuICAgICAgICAgICAgfSlcbiAgICAgICAgICB9XG4gICAgICAgICAgYnJlYWs7XG5cbiAgICAgICAgZGVmYXVsdDovL1NUUklORyBCQVNFRCBTT1JUXG4gICAgICAgICAgaWYoYXNjKXtcbiAgICAgICAgICAgIHRoaXMuYXJyYXkuc29ydCggKGEsYik9PlN0cmluZyh0b0tleShhKXx8XCJcIikudG9Mb3dlckNhc2UoKT5TdHJpbmcodG9LZXkoYil8fFwiXCIpLnRvTG93ZXJDYXNlKCk/MTotMSApXG4gICAgICAgICAgfWVsc2V7XG4gICAgICAgICAgICB0aGlzLmFycmF5LnNvcnQoIChiLGEpPT5TdHJpbmcodG9LZXkoYSl8fFwiXCIpLnRvTG93ZXJDYXNlKCk+U3RyaW5nKHRvS2V5KGIpfHxcIlwiKS50b0xvd2VyQ2FzZSgpPzE6LTEgKVxuICAgICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG5cbiAgICAvL2NsZWFudXBcbiAgICBpZiggdGhpcy5zb3J0QXJyYXkubGVuZ3RoPjMgKXtcbiAgICAgIHRoaXMuc29ydEFycmF5LnBvcCgpXG4gICAgfVxuXG4gICAgdGhpcy5pblNvcnQgPSBmYWxzZVxuICAgIHRoaXMubG9vcCggdHJ1ZSApLy9jYXVzZSBwYWdlcyB0byBiZSB1cGRhdGVkXG4gIH1cbn1cblxuXG5leHBvcnQgZnVuY3Rpb24gZGF0YUtleXNNYXRjaChhbyxhbixpZEtleXM6c3RyaW5nW10pOmJvb2xlYW57XG4gIGZvcihsZXQgeD1pZEtleXMubGVuZ3RoLTE7IHggPj0gMDsgLS14KXtcbiAgICBsZXQgaWRLZXkgPSBpZEtleXNbeF1cbiAgICBpZihhb1tpZEtleV0hPW51bGwgJiYgYW9baWRLZXldICE9PSBhbltpZEtleV0gKXtcbiAgICAgIHJldHVybiBmYWxzZVxuICAgIH1cbiAgfVxuICByZXR1cm4gdHJ1ZVxufVxuXG5leHBvcnQgZnVuY3Rpb24gbWVyZ2VBcnJheXMoXG4gIGFycmF5T3JpZ2luYWw6YW55W10sXG4gIGFycmF5TmV3OmFueVtdLFxuICBpZEtleXM6c3RyaW5nW11cbil7XG5cbiAgLy9yZW1vdmFsc1xuICBmb3IobGV0IHg9YXJyYXlPcmlnaW5hbC5sZW5ndGgtMTsgeCA+PSAwOyAtLXgpe1xuICAgIGxldCBhbyA9IGFycmF5T3JpZ2luYWxbeF1cbiAgICBsZXQgYW4gPSBhcnJheU5ld1t4XVxuICAgIFxuICAgIC8vcXVpY2sgbWF0Y2hcbiAgICBpZihhbiAmJiBkYXRhS2V5c01hdGNoKGFvLGFuLGlkS2V5cykgKXtcbiAgICAgIGNvbnRpbnVlXG4gICAgfVxuXG4gICAgbGV0IGZvdW5kID0gZmFsc2VcbiAgICBmb3IobGV0IHh4PWFycmF5TmV3Lmxlbmd0aC0xOyB4eCA+PSAwOyAtLXh4KXtcbiAgICAgIGlmKCBkYXRhS2V5c01hdGNoKGFvLCBhcnJheU5ld1t4eF0sIGlkS2V5cykpe1xuICAgICAgICBmb3VuZCA9IHRydWVcbiAgICAgICAgYnJlYWtcbiAgICAgIH1cbiAgICB9XG5cbiAgICBpZihmb3VuZCljb250aW51ZSAgICAgICAgXG5cbiAgICBhcnJheU9yaWdpbmFsLnNwbGljZSh4LDEpXG4gIH1cblxuICAvL21lcmdlIGFuZCBhZGRcbiAgZm9yKGxldCB4PTA7IHggPCBhcnJheU5ldy5sZW5ndGg7ICsreCl7XG4gICAgbGV0IGFvID0gYXJyYXlPcmlnaW5hbFt4XVxuICAgIGxldCBhbiA9IGFycmF5TmV3W3hdXG4gICAgbGV0IGZvdW5kID0gZmFsc2VcblxuICAgIC8vdHJ5IGJ5IGluZGV4IG1hdGNoIGZpcnN0LCBtYXkgdG8gbmVhciBpZGVudGljYWwgYXJyYXlzXG4gICAgaWYoYW8gJiYgZGF0YUtleXNNYXRjaChhbyxhbixpZEtleXMpKXtcbiAgICAgIG1lcmdlT2JqZWN0cyhhbywgYW4pXG4gICAgICBjb250aW51ZVxuICAgIH1cblxuICAgIC8vdHJ5IHRvIG1hdGNoIGJ5IGxvb3AgYWdhaW5zdCBsb29wXG4gICAgZm9yKGxldCB4eD1hcnJheU9yaWdpbmFsLmxlbmd0aC0xOyB4eCA+PSAwOyAtLXh4KXtcbiAgICAgIGFvID0gYXJyYXlPcmlnaW5hbFt4eF1cbiAgICAgIGlmKCBkYXRhS2V5c01hdGNoKGFvLGFuLGlkS2V5cykgKXtcbiAgICAgICAgbWVyZ2VPYmplY3RzKGFvLCBhbilcbiAgICAgICAgZm91bmQgPSB0cnVlXG4gICAgICAgIGNvbnRpbnVlXG4gICAgICB9XG4gICAgfVxuXG4gICAgaWYoIGZvdW5kICl7XG4gICAgICBjb250aW51ZVxuICAgIH1cblxuICAgIC8vbm90IGZvdW5kLCBhZGQgdG8gYXJyYXlcbiAgICAvL2FycmF5T3JpZ2luYWwudW5zaGlmdChhbilcbiAgICBhcnJheU9yaWdpbmFsLnNwbGljZSh4LDAsYW4pXG4gIH1cbn1cblxuXG5mdW5jdGlvbiBtZXJnZU9iamVjdHMoYW86b2JqZWN0LCBhbjpvYmplY3Qpe1xuICBmb3IobGV0IHggaW4gYW8pe1xuICAgIGRlbGV0ZSBhb1t4XVxuICB9XG4gIE9iamVjdC5hc3NpZ24oYW8sIGFuKVxufSJdfQ==