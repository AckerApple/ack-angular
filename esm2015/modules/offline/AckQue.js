import { Injectable } from '@angular/core';
import { AckOffline } from './AckOffline';
/** Que data based processes by associating name based handlers */
export class AckQue extends AckOffline {
    constructor() {
        super(...arguments);
        this.prefix = "offline-que";
        this.handlers = [];
    }
    /** processes with associated that are typically awaiting internet access to complete processing */
    get(name) {
        return super.get(name)
            .then(data => data && data['que'] ? data['que'] : []);
    }
    /** aka get */
    getQue(name) {
        return this.get(name);
    }
    /** aka set */
    setQue(name, que) {
        return this.set(name, que);
    }
    /* deprecated : clearQue(name)... Call clear(name) */
    /** add to qued data. Typically when offline, add post/put requests here and process them when back online */
    que(name, queData) {
        return super.get(name)
            .then(data => {
            data = data || {};
            data['que'] = data['que'] || [];
            if (queData.forEach) {
                queData.forEach(x => {
                    data['que'].push(x);
                });
            }
            else {
                data['que'].push(queData);
            }
            return super.set(name, data);
        });
    }
    /** merge new que data overtop of existing que
      @name:string
      @que
    */
    set(name, queData) {
        return this.que(name, queData);
    }
    dequeByIndex(name, index) {
        return this.getQue(name)
            .then(array => {
            array.splice(index, 1);
            return array;
        })
            .then(array => this.setQue(name, array));
    }
    processQuedByIndex(name, index) {
        const handler = this.getQueHandlerByName(name);
        const mem = { item: null, array: null, result: null };
        return this.getQue(name)
            .then(array => {
            mem.item = array.splice(index, 1);
            mem.array = array;
        })
            .then(() => this.handleQued(mem.item, handler))
            .then(result => mem.result = result)
            .then(() => this.setQue(name, mem.array))
            .then(() => mem.result);
    }
    /** Most important. When a que of data-tasks is being processed, the approperiate handler must be registered here */
    registerHandler(name, handler) {
        this.handlers.push({ name, handler });
        return this;
    }
    /** aka registerHandler */
    registerQueHandler(name, handler) {
        return this.registerHandler(name, handler);
    }
    paramHandler(name, handler) {
        for (let x = this.handlers.length - 1; x >= 0; --x) {
            if (this.handlers[x].name == name) {
                return this;
            }
        }
        this.handlers.push({ name, handler });
        return this;
    }
    getQueHandDefByName(name) {
        for (let i = this.handlers.length - 1; i >= 0; --i) {
            if (this.handlers[i].name == name)
                return this.handlers[i];
        }
    }
    /** return functions */
    getQueHandlerByName(name) {
        const hand = this.getQueHandDefByName(name);
        if (hand)
            return hand.handler;
    }
    handleQued(qued, handler) {
        return Promise.resolve(handler(qued));
    }
    /** gets array of qued data and processes all and then clears que */
    processQuedHandler(hand) {
        const results = [];
        const mem = { que: [] };
        const eachHandle = this.eachHandler(hand.handler);
        return this.get(hand.name)
            .then(que => mem.que = que)
            .then(() => this.clear(hand.name))
            .then(() => {
            var promise = Promise.resolve();
            mem.que.forEach(v => {
                promise = promise
                    .then(() => eachHandle(v))
                    .catch(e => e)
                    .then(r => results.push(r));
            });
            return promise;
        })
            .then(() => results);
    }
    eachHandler(handler) {
        return data => this.handleQued(data, handler);
    }
    /** call manually in app when back online */
    processQue(name) {
        const handler = this.getQueHandDefByName(name);
        return handler ? this.processQuedHandler(handler) : Promise.resolve();
    }
    /** call manually in app when back online and sure you want to process all ques */
    processAllQues() {
        const promises = [];
        this.handlers.forEach(hand => promises.push(this.processQuedHandler(hand)));
        return Promise.all(promises)
            .then(proms => {
            const results = [];
            proms.forEach(subArray => results.push.apply(results, subArray));
            return Promise.all(results); //array of arrays is now one array
        });
    }
}
AckQue.decorators = [
    { type: Injectable }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQWNrUXVlLmpzIiwic291cmNlUm9vdCI6Ii4uLy4uL3NyYy8iLCJzb3VyY2VzIjpbIm1vZHVsZXMvb2ZmbGluZS9BY2tRdWUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzQyxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sY0FBYyxDQUFDO0FBTzFDLGtFQUFrRTtBQUNwRCxNQUFNLE9BQU8sTUFBTyxTQUFRLFVBQVU7SUFBcEQ7O1FBQ0UsV0FBTSxHQUFRLGFBQWEsQ0FBQTtRQUMzQixhQUFRLEdBQUcsRUFBRSxDQUFBO0lBaUtmLENBQUM7SUEvSkMsbUdBQW1HO0lBQ25HLEdBQUcsQ0FBQyxJQUFJO1FBQ04sT0FBTyxLQUFLLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQzthQUNyQixJQUFJLENBQUUsSUFBSSxDQUFDLEVBQUUsQ0FBQyxJQUFJLElBQUksSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFBO0lBQ3hELENBQUM7SUFFRCxjQUFjO0lBQ2QsTUFBTSxDQUFDLElBQVc7UUFDaEIsT0FBTyxJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxDQUFBO0lBQ3ZCLENBQUM7SUFFRCxjQUFjO0lBQ2QsTUFBTSxDQUFDLElBQVcsRUFBRSxHQUFHO1FBQ3JCLE9BQU8sSUFBSSxDQUFDLEdBQUcsQ0FBQyxJQUFJLEVBQUUsR0FBRyxDQUFDLENBQUE7SUFDNUIsQ0FBQztJQUVELHFEQUFxRDtJQUVyRCw2R0FBNkc7SUFDN0csR0FBRyxDQUFDLElBQVcsRUFBRSxPQUFPO1FBQ3RCLE9BQU8sS0FBSyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUM7YUFDckIsSUFBSSxDQUFDLElBQUksQ0FBQyxFQUFFO1lBQ1gsSUFBSSxHQUFHLElBQUksSUFBSSxFQUFFLENBQUE7WUFDakIsSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxFQUFFLENBQUE7WUFFL0IsSUFBRyxPQUFPLENBQUMsT0FBTyxFQUFDO2dCQUNqQixPQUFPLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQSxFQUFFO29CQUNqQixJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsSUFBSSxDQUFFLENBQUMsQ0FBRSxDQUFBO2dCQUN2QixDQUFDLENBQUMsQ0FBQTthQUNIO2lCQUFJO2dCQUNILElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxJQUFJLENBQUUsT0FBTyxDQUFFLENBQUE7YUFDNUI7WUFFRCxPQUFPLEtBQUssQ0FBQyxHQUFHLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxDQUFBO1FBQzlCLENBQUMsQ0FBQyxDQUFBO0lBQ0osQ0FBQztJQUVEOzs7TUFHRTtJQUNGLEdBQUcsQ0FBQyxJQUFXLEVBQUUsT0FBTztRQUN0QixPQUFPLElBQUksQ0FBQyxHQUFHLENBQUMsSUFBSSxFQUFFLE9BQU8sQ0FBQyxDQUFBO0lBQ2hDLENBQUM7SUFFRCxZQUFZLENBQUMsSUFBVyxFQUFFLEtBQVk7UUFDcEMsT0FBTyxJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQzthQUN2QixJQUFJLENBQUMsS0FBSyxDQUFBLEVBQUU7WUFDWCxLQUFLLENBQUMsTUFBTSxDQUFDLEtBQUssRUFBRSxDQUFDLENBQUMsQ0FBQTtZQUN0QixPQUFPLEtBQUssQ0FBQTtRQUNkLENBQUMsQ0FBQzthQUNELElBQUksQ0FBRSxLQUFLLENBQUEsRUFBRSxDQUFBLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxFQUFFLEtBQUssQ0FBQyxDQUFFLENBQUE7SUFDMUMsQ0FBQztJQUVELGtCQUFrQixDQUFDLElBQVcsRUFBRSxLQUFZO1FBQzFDLE1BQU0sT0FBTyxHQUFHLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxJQUFJLENBQUMsQ0FBQTtRQUM5QyxNQUFNLEdBQUcsR0FBRyxFQUFDLElBQUksRUFBQyxJQUFJLEVBQUUsS0FBSyxFQUFDLElBQUksRUFBRSxNQUFNLEVBQUMsSUFBSSxFQUFDLENBQUE7UUFFaEQsT0FBTyxJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQzthQUN2QixJQUFJLENBQUMsS0FBSyxDQUFBLEVBQUU7WUFDWCxHQUFHLENBQUMsSUFBSSxHQUFHLEtBQUssQ0FBQyxNQUFNLENBQUMsS0FBSyxFQUFFLENBQUMsQ0FBQyxDQUFBO1lBQ2pDLEdBQUcsQ0FBQyxLQUFLLEdBQUcsS0FBSyxDQUFBO1FBQ25CLENBQUMsQ0FBQzthQUNELElBQUksQ0FBRSxHQUFFLEVBQUUsQ0FBQSxJQUFJLENBQUMsVUFBVSxDQUFDLEdBQUcsQ0FBQyxJQUFJLEVBQUUsT0FBTyxDQUFDLENBQUM7YUFDN0MsSUFBSSxDQUFFLE1BQU0sQ0FBQSxFQUFFLENBQUEsR0FBRyxDQUFDLE1BQU0sR0FBQyxNQUFNLENBQUU7YUFDakMsSUFBSSxDQUFFLEdBQUUsRUFBRSxDQUFBLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxFQUFFLEdBQUcsQ0FBQyxLQUFLLENBQUMsQ0FBRTthQUN4QyxJQUFJLENBQUUsR0FBRSxFQUFFLENBQUEsR0FBRyxDQUFDLE1BQU0sQ0FBRSxDQUFBO0lBQ3pCLENBQUM7SUFFRCxvSEFBb0g7SUFDcEgsZUFBZSxDQUFDLElBQVcsRUFBRSxPQUF1QjtRQUNsRCxJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxFQUFDLElBQUksRUFBRSxPQUFPLEVBQUMsQ0FBQyxDQUFBO1FBQ25DLE9BQU8sSUFBSSxDQUFBO0lBQ2IsQ0FBQztJQUVELDBCQUEwQjtJQUMxQixrQkFBa0IsQ0FBQyxJQUFXLEVBQUUsT0FBdUI7UUFDckQsT0FBTyxJQUFJLENBQUMsZUFBZSxDQUFDLElBQUksRUFBRSxPQUFPLENBQUMsQ0FBQTtJQUM1QyxDQUFDO0lBRUQsWUFBWSxDQUFDLElBQVcsRUFBRSxPQUF1QjtRQUMvQyxLQUFJLElBQUksQ0FBQyxHQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsTUFBTSxHQUFDLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxFQUFFLEVBQUUsQ0FBQyxFQUFDO1lBQzVDLElBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLElBQUUsSUFBSSxFQUFDO2dCQUM3QixPQUFPLElBQUksQ0FBQTthQUNaO1NBQ0Y7UUFDRCxJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxFQUFDLElBQUksRUFBRSxPQUFPLEVBQUMsQ0FBQyxDQUFBO1FBQ25DLE9BQU8sSUFBSSxDQUFBO0lBQ2IsQ0FBQztJQUVELG1CQUFtQixDQUFDLElBQVc7UUFDN0IsS0FBSSxJQUFJLENBQUMsR0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLE1BQU0sR0FBQyxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsRUFBRSxFQUFFLENBQUMsRUFBQztZQUM1QyxJQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxJQUFFLElBQUk7Z0JBQUMsT0FBTyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxDQUFBO1NBQ3ZEO0lBQ0gsQ0FBQztJQUVELHVCQUF1QjtJQUN2QixtQkFBbUIsQ0FBQyxJQUFJO1FBQ3RCLE1BQU0sSUFBSSxHQUFHLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxJQUFJLENBQUMsQ0FBQTtRQUMzQyxJQUFHLElBQUk7WUFBQyxPQUFPLElBQUksQ0FBQyxPQUFPLENBQUE7SUFDN0IsQ0FBQztJQUVELFVBQVUsQ0FDUixJQUFRLEVBQ1IsT0FBdUI7UUFFdkIsT0FBTyxPQUFPLENBQUMsT0FBTyxDQUFFLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBRSxDQUFBO0lBQ3pDLENBQUM7SUFFRCxvRUFBb0U7SUFDcEUsa0JBQWtCLENBQUUsSUFBa0I7UUFDcEMsTUFBTSxPQUFPLEdBQUcsRUFBRSxDQUFBO1FBQ2xCLE1BQU0sR0FBRyxHQUFHLEVBQUMsR0FBRyxFQUFDLEVBQUUsRUFBQyxDQUFBO1FBQ3BCLE1BQU0sVUFBVSxHQUFHLElBQUksQ0FBQyxXQUFXLENBQUUsSUFBSSxDQUFDLE9BQU8sQ0FBRSxDQUFBO1FBRW5ELE9BQU8sSUFBSSxDQUFDLEdBQUcsQ0FBRSxJQUFJLENBQUMsSUFBSSxDQUFFO2FBQzNCLElBQUksQ0FBRSxHQUFHLENBQUEsRUFBRSxDQUFBLEdBQUcsQ0FBQyxHQUFHLEdBQUMsR0FBRyxDQUFFO2FBQ3hCLElBQUksQ0FBRSxHQUFFLEVBQUUsQ0FBQSxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBRTthQUNqQyxJQUFJLENBQUMsR0FBRSxFQUFFO1lBQ1IsSUFBSSxPQUFPLEdBQWdCLE9BQU8sQ0FBQyxPQUFPLEVBQUUsQ0FBQTtZQUU1QyxHQUFHLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUEsRUFBRTtnQkFDakIsT0FBTyxHQUFHLE9BQU87cUJBQ2hCLElBQUksQ0FBRSxHQUFFLEVBQUUsQ0FBQSxVQUFVLENBQUMsQ0FBQyxDQUFDLENBQUU7cUJBQ3pCLEtBQUssQ0FBRSxDQUFDLENBQUEsRUFBRSxDQUFBLENBQUMsQ0FBRTtxQkFDYixJQUFJLENBQUUsQ0FBQyxDQUFBLEVBQUUsQ0FBQSxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFFLENBQUE7WUFDN0IsQ0FBQyxDQUFDLENBQUE7WUFDRixPQUFPLE9BQU8sQ0FBQTtRQUNoQixDQUFDLENBQUM7YUFDRCxJQUFJLENBQUUsR0FBRSxFQUFFLENBQUEsT0FBTyxDQUFFLENBQUE7SUFDdEIsQ0FBQztJQUVELFdBQVcsQ0FDVCxPQUF1QjtRQUV2QixPQUFPLElBQUksQ0FBQSxFQUFFLENBQUEsSUFBSSxDQUFDLFVBQVUsQ0FBQyxJQUFJLEVBQUUsT0FBTyxDQUFDLENBQUE7SUFDN0MsQ0FBQztJQUVELDRDQUE0QztJQUM1QyxVQUFVLENBQUMsSUFBVztRQUNwQixNQUFNLE9BQU8sR0FBRyxJQUFJLENBQUMsbUJBQW1CLENBQUMsSUFBSSxDQUFDLENBQUE7UUFDOUMsT0FBTyxPQUFPLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLE9BQU8sRUFBRSxDQUFBO0lBQ3ZFLENBQUM7SUFFRCxrRkFBa0Y7SUFDbEYsY0FBYztRQUNaLE1BQU0sUUFBUSxHQUFHLEVBQUUsQ0FBQTtRQUVuQixJQUFJLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUEsRUFBRSxDQUMxQixRQUFRLENBQUMsSUFBSSxDQUFFLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxJQUFJLENBQUMsQ0FBRSxDQUMvQyxDQUFBO1FBRUQsT0FBTyxPQUFPLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQzthQUMzQixJQUFJLENBQUMsS0FBSyxDQUFBLEVBQUU7WUFDWCxNQUFNLE9BQU8sR0FBRyxFQUFFLENBQUE7WUFDbEIsS0FBSyxDQUFDLE9BQU8sQ0FBRSxRQUFRLENBQUEsRUFBRSxDQUFBLE9BQU8sQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLE9BQU8sRUFBRSxRQUFRLENBQUMsQ0FBRSxDQUFBO1lBQ2hFLE9BQU8sT0FBTyxDQUFDLEdBQUcsQ0FBRSxPQUFPLENBQUUsQ0FBQSxDQUFBLGtDQUFrQztRQUNqRSxDQUFDLENBQUMsQ0FBQTtJQUNKLENBQUM7OztZQWxLRixVQUFVIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgQWNrT2ZmbGluZSB9IGZyb20gJy4vQWNrT2ZmbGluZSc7XG5cbmV4cG9ydCBpbnRlcmZhY2UgaGFuZGxlckNvbmZpZ3tcbiAgbmFtZTpzdHJpbmdcbiAgaGFuZGxlcjoocXVlZDphbnkpPT5hbnlcbn1cblxuLyoqIFF1ZSBkYXRhIGJhc2VkIHByb2Nlc3NlcyBieSBhc3NvY2lhdGluZyBuYW1lIGJhc2VkIGhhbmRsZXJzICovXG5ASW5qZWN0YWJsZSgpIGV4cG9ydCBjbGFzcyBBY2tRdWUgZXh0ZW5kcyBBY2tPZmZsaW5le1xuICBwcmVmaXg6c3RyaW5nPVwib2ZmbGluZS1xdWVcIlxuICBoYW5kbGVycyA9IFtdXG4gIFxuICAvKiogcHJvY2Vzc2VzIHdpdGggYXNzb2NpYXRlZCB0aGF0IGFyZSB0eXBpY2FsbHkgYXdhaXRpbmcgaW50ZXJuZXQgYWNjZXNzIHRvIGNvbXBsZXRlIHByb2Nlc3NpbmcgKi9cbiAgZ2V0KG5hbWUpIHtcbiAgICByZXR1cm4gc3VwZXIuZ2V0KG5hbWUpXG4gICAgLnRoZW4oIGRhdGEgPT4gZGF0YSAmJiBkYXRhWydxdWUnXSA/IGRhdGFbJ3F1ZSddIDogW10pXG4gIH1cblxuICAvKiogYWthIGdldCAqL1xuICBnZXRRdWUobmFtZTpzdHJpbmcpe1xuICAgIHJldHVybiB0aGlzLmdldChuYW1lKVxuICB9XG5cbiAgLyoqIGFrYSBzZXQgKi9cbiAgc2V0UXVlKG5hbWU6c3RyaW5nLCBxdWUpe1xuICAgIHJldHVybiB0aGlzLnNldChuYW1lLCBxdWUpXG4gIH1cblxuICAvKiBkZXByZWNhdGVkIDogY2xlYXJRdWUobmFtZSkuLi4gQ2FsbCBjbGVhcihuYW1lKSAqL1xuXG4gIC8qKiBhZGQgdG8gcXVlZCBkYXRhLiBUeXBpY2FsbHkgd2hlbiBvZmZsaW5lLCBhZGQgcG9zdC9wdXQgcmVxdWVzdHMgaGVyZSBhbmQgcHJvY2VzcyB0aGVtIHdoZW4gYmFjayBvbmxpbmUgKi9cbiAgcXVlKG5hbWU6c3RyaW5nLCBxdWVEYXRhKSB7XG4gICAgcmV0dXJuIHN1cGVyLmdldChuYW1lKVxuICAgIC50aGVuKGRhdGEgPT4ge1xuICAgICAgZGF0YSA9IGRhdGEgfHwge31cbiAgICAgIGRhdGFbJ3F1ZSddID0gZGF0YVsncXVlJ10gfHwgW11cblxuICAgICAgaWYocXVlRGF0YS5mb3JFYWNoKXtcbiAgICAgICAgcXVlRGF0YS5mb3JFYWNoKHg9PntcbiAgICAgICAgICBkYXRhWydxdWUnXS5wdXNoKCB4IClcbiAgICAgICAgfSlcbiAgICAgIH1lbHNle1xuICAgICAgICBkYXRhWydxdWUnXS5wdXNoKCBxdWVEYXRhIClcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIHN1cGVyLnNldChuYW1lLCBkYXRhKVxuICAgIH0pXG4gIH1cblxuICAvKiogbWVyZ2UgbmV3IHF1ZSBkYXRhIG92ZXJ0b3Agb2YgZXhpc3RpbmcgcXVlXG4gICAgQG5hbWU6c3RyaW5nXG4gICAgQHF1ZVxuICAqL1xuICBzZXQobmFtZTpzdHJpbmcsIHF1ZURhdGEpIHtcbiAgICByZXR1cm4gdGhpcy5xdWUobmFtZSwgcXVlRGF0YSlcbiAgfVxuXG4gIGRlcXVlQnlJbmRleChuYW1lOnN0cmluZywgaW5kZXg6bnVtYmVyKXtcbiAgICByZXR1cm4gdGhpcy5nZXRRdWUobmFtZSlcbiAgICAudGhlbihhcnJheT0+e1xuICAgICAgYXJyYXkuc3BsaWNlKGluZGV4LCAxKVxuICAgICAgcmV0dXJuIGFycmF5XG4gICAgfSlcbiAgICAudGhlbiggYXJyYXk9PnRoaXMuc2V0UXVlKG5hbWUsIGFycmF5KSApXG4gIH1cblxuICBwcm9jZXNzUXVlZEJ5SW5kZXgobmFtZTpzdHJpbmcsIGluZGV4Om51bWJlcil7XG4gICAgY29uc3QgaGFuZGxlciA9IHRoaXMuZ2V0UXVlSGFuZGxlckJ5TmFtZShuYW1lKVxuICAgIGNvbnN0IG1lbSA9IHtpdGVtOm51bGwsIGFycmF5Om51bGwsIHJlc3VsdDpudWxsfVxuXG4gICAgcmV0dXJuIHRoaXMuZ2V0UXVlKG5hbWUpXG4gICAgLnRoZW4oYXJyYXk9PntcbiAgICAgIG1lbS5pdGVtID0gYXJyYXkuc3BsaWNlKGluZGV4LCAxKVxuICAgICAgbWVtLmFycmF5ID0gYXJyYXlcbiAgICB9KVxuICAgIC50aGVuKCAoKT0+dGhpcy5oYW5kbGVRdWVkKG1lbS5pdGVtLCBoYW5kbGVyKSlcbiAgICAudGhlbiggcmVzdWx0PT5tZW0ucmVzdWx0PXJlc3VsdCApXG4gICAgLnRoZW4oICgpPT50aGlzLnNldFF1ZShuYW1lLCBtZW0uYXJyYXkpIClcbiAgICAudGhlbiggKCk9Pm1lbS5yZXN1bHQgKVxuICB9XG5cbiAgLyoqIE1vc3QgaW1wb3J0YW50LiBXaGVuIGEgcXVlIG9mIGRhdGEtdGFza3MgaXMgYmVpbmcgcHJvY2Vzc2VkLCB0aGUgYXBwcm9wZXJpYXRlIGhhbmRsZXIgbXVzdCBiZSByZWdpc3RlcmVkIGhlcmUgKi9cbiAgcmVnaXN0ZXJIYW5kbGVyKG5hbWU6c3RyaW5nLCBoYW5kbGVyOihxdWVkOmFueSk9PmFueSl7XG4gICAgdGhpcy5oYW5kbGVycy5wdXNoKHtuYW1lLCBoYW5kbGVyfSlcbiAgICByZXR1cm4gdGhpc1xuICB9XG5cbiAgLyoqIGFrYSByZWdpc3RlckhhbmRsZXIgKi9cbiAgcmVnaXN0ZXJRdWVIYW5kbGVyKG5hbWU6c3RyaW5nLCBoYW5kbGVyOihxdWVkOmFueSk9PmFueSl7XG4gICAgcmV0dXJuIHRoaXMucmVnaXN0ZXJIYW5kbGVyKG5hbWUsIGhhbmRsZXIpXG4gIH1cblxuICBwYXJhbUhhbmRsZXIobmFtZTpzdHJpbmcsIGhhbmRsZXI6KHF1ZWQ6YW55KT0+YW55KSB7XG4gICAgZm9yKGxldCB4PXRoaXMuaGFuZGxlcnMubGVuZ3RoLTE7IHggPj0gMDsgLS14KXtcbiAgICAgIGlmKHRoaXMuaGFuZGxlcnNbeF0ubmFtZT09bmFtZSl7XG4gICAgICAgIHJldHVybiB0aGlzXG4gICAgICB9XG4gICAgfVxuICAgIHRoaXMuaGFuZGxlcnMucHVzaCh7bmFtZSwgaGFuZGxlcn0pXG4gICAgcmV0dXJuIHRoaXNcbiAgfVxuXG4gIGdldFF1ZUhhbmREZWZCeU5hbWUobmFtZTpzdHJpbmcpe1xuICAgIGZvcihsZXQgaT10aGlzLmhhbmRsZXJzLmxlbmd0aC0xOyBpID49IDA7IC0taSl7XG4gICAgICBpZih0aGlzLmhhbmRsZXJzW2ldLm5hbWU9PW5hbWUpcmV0dXJuIHRoaXMuaGFuZGxlcnNbaV1cbiAgICB9XG4gIH1cblxuICAvKiogcmV0dXJuIGZ1bmN0aW9ucyAqL1xuICBnZXRRdWVIYW5kbGVyQnlOYW1lKG5hbWUpe1xuICAgIGNvbnN0IGhhbmQgPSB0aGlzLmdldFF1ZUhhbmREZWZCeU5hbWUobmFtZSlcbiAgICBpZihoYW5kKXJldHVybiBoYW5kLmhhbmRsZXJcbiAgfVxuXG4gIGhhbmRsZVF1ZWQoXG4gICAgcXVlZDphbnksXG4gICAgaGFuZGxlcjoocXVlZDphbnkpPT5hbnlcbiAgKXtcbiAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKCBoYW5kbGVyKHF1ZWQpIClcbiAgfVxuXG4gIC8qKiBnZXRzIGFycmF5IG9mIHF1ZWQgZGF0YSBhbmQgcHJvY2Vzc2VzIGFsbCBhbmQgdGhlbiBjbGVhcnMgcXVlICovXG4gIHByb2Nlc3NRdWVkSGFuZGxlciggaGFuZDpoYW5kbGVyQ29uZmlnICkgOiBQcm9taXNlPGFueT57XG4gICAgY29uc3QgcmVzdWx0cyA9IFtdXG4gICAgY29uc3QgbWVtID0ge3F1ZTpbXX1cbiAgICBjb25zdCBlYWNoSGFuZGxlID0gdGhpcy5lYWNoSGFuZGxlciggaGFuZC5oYW5kbGVyIClcblxuICAgIHJldHVybiB0aGlzLmdldCggaGFuZC5uYW1lIClcbiAgICAudGhlbiggcXVlPT5tZW0ucXVlPXF1ZSApXG4gICAgLnRoZW4oICgpPT50aGlzLmNsZWFyKGhhbmQubmFtZSkgKVxuICAgIC50aGVuKCgpPT57XG4gICAgICB2YXIgcHJvbWlzZTpQcm9taXNlPGFueT4gPSBQcm9taXNlLnJlc29sdmUoKVxuICAgICAgXG4gICAgICBtZW0ucXVlLmZvckVhY2godj0+e1xuICAgICAgICBwcm9taXNlID0gcHJvbWlzZVxuICAgICAgICAudGhlbiggKCk9PmVhY2hIYW5kbGUodikgKVxuICAgICAgICAuY2F0Y2goIGU9PmUgKVxuICAgICAgICAudGhlbiggcj0+cmVzdWx0cy5wdXNoKHIpIClcbiAgICAgIH0pXG4gICAgICByZXR1cm4gcHJvbWlzZVxuICAgIH0pXG4gICAgLnRoZW4oICgpPT5yZXN1bHRzIClcbiAgfVxuXG4gIGVhY2hIYW5kbGVyKFxuICAgIGhhbmRsZXI6KHF1ZWQ6YW55KT0+YW55XG4gICl7XG4gICAgcmV0dXJuIGRhdGE9PnRoaXMuaGFuZGxlUXVlZChkYXRhLCBoYW5kbGVyKVxuICB9XG5cbiAgLyoqIGNhbGwgbWFudWFsbHkgaW4gYXBwIHdoZW4gYmFjayBvbmxpbmUgKi9cbiAgcHJvY2Vzc1F1ZShuYW1lOnN0cmluZyl7XG4gICAgY29uc3QgaGFuZGxlciA9IHRoaXMuZ2V0UXVlSGFuZERlZkJ5TmFtZShuYW1lKVxuICAgIHJldHVybiBoYW5kbGVyID8gdGhpcy5wcm9jZXNzUXVlZEhhbmRsZXIoaGFuZGxlcikgOiBQcm9taXNlLnJlc29sdmUoKVxuICB9XG5cbiAgLyoqIGNhbGwgbWFudWFsbHkgaW4gYXBwIHdoZW4gYmFjayBvbmxpbmUgYW5kIHN1cmUgeW91IHdhbnQgdG8gcHJvY2VzcyBhbGwgcXVlcyAqL1xuICBwcm9jZXNzQWxsUXVlcygpe1xuICAgIGNvbnN0IHByb21pc2VzID0gW11cblxuICAgIHRoaXMuaGFuZGxlcnMuZm9yRWFjaChoYW5kPT5cbiAgICAgIHByb21pc2VzLnB1c2goIHRoaXMucHJvY2Vzc1F1ZWRIYW5kbGVyKGhhbmQpIClcbiAgICApXG5cbiAgICByZXR1cm4gUHJvbWlzZS5hbGwocHJvbWlzZXMpXG4gICAgLnRoZW4ocHJvbXM9PntcbiAgICAgIGNvbnN0IHJlc3VsdHMgPSBbXVxuICAgICAgcHJvbXMuZm9yRWFjaCggc3ViQXJyYXk9PnJlc3VsdHMucHVzaC5hcHBseShyZXN1bHRzLCBzdWJBcnJheSkgKVxuICAgICAgcmV0dXJuIFByb21pc2UuYWxsKCByZXN1bHRzICkvL2FycmF5IG9mIGFycmF5cyBpcyBub3cgb25lIGFycmF5XG4gICAgfSlcbiAgfVxufSJdfQ==