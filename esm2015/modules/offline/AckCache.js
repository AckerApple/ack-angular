import { Injectable } from '@angular/core';
import { AckOffline } from './AckOffline';
/** Cache logic that provides timestamping and timingout using AckOffline as storage */
export class AckCache extends AckOffline {
    constructor() {
        super(...arguments);
        this.prefix = "offline-cache";
    }
    validate(data, config) {
        const exists = data !== null && typeof data.cache !== "undefined";
        return exists && !this.hasExpired(data._timestamp, data.expires || config.expires);
    }
    optionsKillCache(options) {
        return options.maxAge == null && options.expires == null ? false : true;
    }
    hasMaxAged(stamp, maxAge) {
        const diff = Date.now() - maxAge;
        const expired = stamp <= diff;
        return maxAge && expired ? true : false;
    }
    hasExpired(_stamp, expires) {
        const expired = Date.now() >= new Date(expires).getTime();
        return expires && expired ? true : false;
    }
    param(name, options = {}) {
        options.param = options.param || []; //good idea? Assumption data returned is an array
        return this.getCache(name, options);
    }
    /** aka param */
    paramCache(name, options) {
        return this.param(name, options);
    }
    paramSave(name, options) {
        return this.paramCache(name, options)
            .then(items => this.setCache(name, items));
    }
    /** aka paramSave */
    paramSaveCache(name, options) {
        return this.paramSave(name, options);
    }
    /**
      @options{
        expires:Date||number - Exact date of expiration
        maxAge:number -
      }
    */
    cacheToReturn(name, data, options) {
        if (data.cache == null && data._timestamp == null) {
            return Promise.resolve(data); //bad data catch
        }
        const expires = data.expires || options.expires;
        const maxAge = data.maxAge || options.maxAge;
        if (options.allowExpired || (!expires && !maxAge)) {
            return Promise.resolve(data.cache);
        }
        const expired = expires && this.hasExpired(data._timestamp, expires);
        const isMaxed = maxAge && this.hasMaxAged(data._timestamp, maxAge);
        if (expired || isMaxed) {
            return this.selfDestructData(name, data)
                .then(() => {
                if (options.param)
                    return Promise.resolve(options.param);
                /*const err = new Error('Cache expired for '+name)
                err['code'] = 401
                return Promise.reject( err )*/
            });
        }
        return Promise.resolve(data['cache']);
    }
    selfDestructData(name, data) {
        if (this.dataDestructReady(data))
            return this.clear(name);
        return Promise.resolve();
    }
    dataDestructReady(data) {
        const isMemMaxed = data['maxAge'] && this.hasMaxAged(data['_timestamp'], data['maxAge']);
        const isMemExpired = data['expires'] && this.hasExpired(data['_timestamp'], data['expires']);
        return isMemMaxed || isMemExpired;
    }
    get(name, options = { expires: null }) {
        return super.get(name)
            .then(data => {
            if (data) {
                return this.cacheToReturn(name, data, options);
            }
            if (options.param)
                return options.param;
            return;
        });
    }
    /** aka get */
    getCache(name, options) {
        return this.get(name, options);
    }
    /** paste cache over cache, leave all else alone */
    dataOptionsCache(allCache, options = {}, cache) {
        const newOptions = {};
        newOptions._timestamp = Date.now();
        if (options.expires)
            newOptions.expires = options.expires;
        if (options.maxAge)
            newOptions.maxAge = options.maxAge;
        allCache = allCache && allCache.constructor != String ? allCache : {};
        Object.assign(allCache, newOptions);
        if (cache && cache.constructor == String) {
            allCache.cache = cache;
        }
        else if (allCache.cache && allCache.cache.constructor != String) {
            Object.assign(allCache.cache, cache);
        }
        else {
            allCache.cache = cache;
        }
        return allCache;
    }
    set(name, cache, options = {}) {
        options.name = options.name || name;
        return super.get(name)
            .then(allCache => this.dataOptionsCache(allCache, options, cache))
            .then(data => super.set(name, data));
    }
    /** aka set */
    setCache(name, cache, options) {
        return this.set(name, cache, options);
    }
}
AckCache.decorators = [
    { type: Injectable }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQWNrQ2FjaGUuanMiLCJzb3VyY2VSb290IjoiLi4vLi4vc3JjLyIsInNvdXJjZXMiOlsibW9kdWxlcy9vZmZsaW5lL0Fja0NhY2hlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDM0MsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGNBQWMsQ0FBQztBQVkxQyx1RkFBdUY7QUFDekUsTUFBTSxPQUFPLFFBQVMsU0FBUSxVQUFVO0lBQXREOztRQUNFLFdBQU0sR0FBUSxlQUFlLENBQUE7SUE2Si9CLENBQUM7SUEzSkMsUUFBUSxDQUFDLElBQUksRUFBRSxNQUFNO1FBQ25CLE1BQU0sTUFBTSxHQUFHLElBQUksS0FBSyxJQUFJLElBQUksT0FBTyxJQUFJLENBQUMsS0FBSyxLQUFLLFdBQVcsQ0FBQTtRQUNqRSxPQUFPLE1BQU0sSUFBSSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLFVBQVUsRUFBRSxJQUFJLENBQUMsT0FBTyxJQUFFLE1BQU0sQ0FBQyxPQUFPLENBQUMsQ0FBQTtJQUNsRixDQUFDO0lBRUQsZ0JBQWdCLENBQUMsT0FBa0I7UUFDakMsT0FBTyxPQUFPLENBQUMsTUFBTSxJQUFFLElBQUksSUFBSSxPQUFPLENBQUMsT0FBTyxJQUFFLElBQUksQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUE7SUFDckUsQ0FBQztJQUVELFVBQVUsQ0FBQyxLQUFZLEVBQUUsTUFBYTtRQUNwQyxNQUFNLElBQUksR0FBRyxJQUFJLENBQUMsR0FBRyxFQUFFLEdBQUcsTUFBTSxDQUFBO1FBQ2hDLE1BQU0sT0FBTyxHQUFHLEtBQUssSUFBRSxJQUFJLENBQUE7UUFDM0IsT0FBTyxNQUFNLElBQUksT0FBTyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQTtJQUN6QyxDQUFDO0lBRUQsVUFBVSxDQUNSLE1BQWEsRUFD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SUFBSSxFQUFFLElBQUksQ0FBQyxDQUFFLENBQUE7SUFDdEMsQ0FBQztJQUVELGNBQWM7SUFDZCxRQUFRLENBQ04sSUFBVyxFQUNYLEtBQVMsRUFDVCxPQUFtQjtRQUVuQixPQUFPLElBQUksQ0FBQyxHQUFHLENBQUMsSUFBSSxFQUFFLEtBQUssRUFBRSxPQUFPLENBQUMsQ0FBQTtJQUN2QyxDQUFDOzs7WUE3SkYsVUFBVSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IEFja09mZmxpbmUgfSBmcm9tICcuL0Fja09mZmxpbmUnO1xuXG5leHBvcnQgaW50ZXJmYWNlIGNhY2hlTW9kZWx7XG4gIG5hbWU/ICAgICAgICAgOiBzdHJpbmdcbiAgbWF4VHJ5PyAgICAgICA6IG51bWJlclxuICBleHBpcmVzPyAgICAgIDogbnVtYmVyLy9leGFjdCBkYXRlIG9mIGV4cGlyYXRpb25cbiAgbWF4QWdlPyAgICAgICA6IG51bWJlci8vaG93IG9sZCB1bnRpbCBleHBpcmF0aW9uXG4gIGFsbG93RXhwaXJlZD8gOiBib29sZWFuXG4gIHBhcmFtPyAgICAgICAgOiBvYmplY3QvL3doZW4gY2FjaGUgbm90IGRlZmluZWQsIHVzZSB0aGlzXG59XG5cblxuLyoqIENhY2hlIGxvZ2ljIHRoYXQgcHJvdmlkZXMgdGltZXN0YW1waW5nIGFuZCB0aW1pbmdvdXQgdXNpbmcgQWNrT2ZmbGluZSBhcyBzdG9yYWdlICovXG5ASW5qZWN0YWJsZSgpIGV4cG9ydCBjbGFzcyBBY2tDYWNoZSBleHRlbmRzIEFja09mZmxpbmV7XG4gIHByZWZpeDpzdHJpbmc9XCJvZmZsaW5lLWNhY2hlXCJcbiAgXG4gIHZhbGlkYXRlKGRhdGEsIGNvbmZpZykge1xuICAgIGNvbnN0IGV4aXN0cyA9IGRhdGEgIT09IG51bGwgJiYgdHlwZW9mIGRhdGEuY2FjaGUgIT09IFwidW5kZWZpbmVkXCJcbiAgICByZXR1cm4gZXhpc3RzICYmICF0aGlzLmhhc0V4cGlyZWQoZGF0YS5fdGltZXN0YW1wLCBkYXRhLmV4cGlyZXN8fGNvbmZpZy5leHBpcmVzKVxuICB9XG5cbiAgb3B0aW9uc0tpbGxDYWNoZShvcHRpb25zOmNhY2hlTW9kZWwpe1xuICAgIHJldHVybiBvcHRpb25zLm1heEFnZT09bnVsbCAmJiBvcHRpb25zLmV4cGlyZXM9PW51bGwgPyBmYWxzZSA6IHRydWVcbiAgfVxuXG4gIGhhc01heEFnZWQoc3RhbXA6bnVtYmVyLCBtYXhBZ2U6bnVtYmVyKXtcbiAgICBjb25zdCBkaWZmID0gRGF0ZS5ub3coKSAtIG1heEFnZVxuICAgIGNvbnN0IGV4cGlyZWQgPSBzdGFtcDw9ZGlmZlxuICAgIHJldHVybiBtYXhBZ2UgJiYgZXhwaXJlZCA/IHRydWUgOiBmYWxzZVxuICB9XG5cbiAgaGFzRXhwaXJlZChcbiAgICBfc3RhbXA6bnVtYmVyLFxuICAgIGV4cGlyZXM6bnVtYmVyXG4gICl7XG4gICAgY29uc3QgZXhwaXJlZCA9IERhdGUubm93KCkgPj0gbmV3IERhdGUoZXhwaXJlcykuZ2V0VGltZSgpXG4gICAgcmV0dXJuIGV4cGlyZXMgJiYgZXhwaXJlZCA/IHRydWUgOiBmYWxzZVxuICB9XG5cbiAgcGFyYW0obmFtZTpzdHJpbmcsIG9wdGlvbnM6Y2FjaGVNb2RlbD08Y2FjaGVNb2RlbD57fSl7XG4gICAgb3B0aW9ucy5wYXJhbSA9IG9wdGlvbnMucGFyYW0gfHwgW10vL2dvb2QgaWRlYT8gQXNzdW1wdGlvbiBkYXRhIHJldHVybmVkIGlzIGFuIGFycmF5XG4gICAgcmV0dXJuIHRoaXMuZ2V0Q2FjaGUobmFtZSwgb3B0aW9ucylcbiAgfVxuXG4gIC8qKiBha2EgcGFyYW0gKi9cbiAgcGFyYW1DYWNoZShuYW1lOnN0cmluZywgb3B0aW9uczpjYWNoZU1vZGVsKXtcbiAgICByZXR1cm4gdGhpcy5wYXJhbShuYW1lLCBvcHRpb25zKSAgICBcbiAgfVxuXG4gIHBhcmFtU2F2ZShuYW1lOnN0cmluZywgb3B0aW9uczpjYWNoZU1vZGVsKXtcbiAgICByZXR1cm4gdGhpcy5wYXJhbUNhY2hlKG5hbWUsIG9wdGlvbnMpXG4gICAgLnRoZW4oaXRlbXM9PnRoaXMuc2V0Q2FjaGUobmFtZSxpdGVtcykpXG4gIH1cblxuICAvKiogYWthIHBhcmFtU2F2ZSAqL1xuICBwYXJhbVNhdmVDYWNoZShuYW1lOnN0cmluZywgb3B0aW9uczpjYWNoZU1vZGVsKXtcbiAgICByZXR1cm4gdGhpcy5wYXJhbVNhdmUobmFtZSwgb3B0aW9ucylcbiAgfVxuXG4gIC8qKlxuICAgIEBvcHRpb25ze1xuICAgICAgZXhwaXJlczpEYXRlfHxudW1iZXIgLSBFeGFjdCBkYXRlIG9mIGV4cGlyYXRpb25cbiAgICAgIG1heEFnZTpudW1iZXIgLSBcbiAgICB9XG4gICovXG4gIGNhY2hlVG9SZXR1cm4oXG4gICAgbmFtZTpzdHJpbmcsXG4gICAgZGF0YTphbnksXG4gICAgb3B0aW9uczpjYWNoZU1vZGVsXG4gICk6YW55e1xuICAgIGlmKGRhdGEuY2FjaGU9PW51bGwgJiYgZGF0YS5fdGltZXN0YW1wPT1udWxsKXtcbiAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoIGRhdGEgKS8vYmFkIGRhdGEgY2F0Y2hcbiAgICB9XG5cbiAgICBjb25zdCBleHBpcmVzID0gZGF0YS5leHBpcmVzIHx8IG9wdGlvbnMuZXhwaXJlc1xuICAgIGNvbnN0IG1heEFnZSA9IGRhdGEubWF4QWdlIHx8IG9wdGlvbnMubWF4QWdlXG4gICAgXG4gICAgaWYob3B0aW9ucy5hbGxvd0V4cGlyZWQgfHwgKCFleHBpcmVzICYmICFtYXhBZ2UpKXtcbiAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoIGRhdGEuY2FjaGUgKVxuICAgIH1cblxuICAgIGNvbnN0IGV4cGlyZWQgPSBleHBpcmVzICYmIHRoaXMuaGFzRXhwaXJlZChkYXRhLl90aW1lc3RhbXAsIGV4cGlyZXMpXG4gICAgY29uc3QgaXNNYXhlZCA9IG1heEFnZSAmJiB0aGlzLmhhc01heEFnZWQoZGF0YS5fdGltZXN0YW1wLCBtYXhBZ2UpXG5cbiAgICBpZihleHBpcmVkIHx8IGlzTWF4ZWQpe1xuICAgICAgcmV0dXJuIHRoaXMuc2VsZkRlc3RydWN0RGF0YShuYW1lLGRhdGEpXG4gICAgICAudGhlbigoKT0+e1xuICAgICAgICBpZihvcHRpb25zLnBhcmFtKXJldHVybiBQcm9taXNlLnJlc29sdmUoIG9wdGlvbnMucGFyYW0gKVxuXG4gICAgICAgIC8qY29uc3QgZXJyID0gbmV3IEVycm9yKCdDYWNoZSBleHBpcmVkIGZvciAnK25hbWUpXG4gICAgICAgIGVyclsnY29kZSddID0gNDAxXG4gICAgICAgIHJldHVybiBQcm9taXNlLnJlamVjdCggZXJyICkqL1xuICAgICAgfSlcbiAgICB9XG5cbiAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKCBkYXRhWydjYWNoZSddIClcbiAgfVxuXG4gIHNlbGZEZXN0cnVjdERhdGEobmFtZSxkYXRhKXtcbiAgICBpZiggdGhpcy5kYXRhRGVzdHJ1Y3RSZWFkeShkYXRhKSApcmV0dXJuIHRoaXMuY2xlYXIobmFtZSlcbiAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKClcbiAgfVxuXG4gIGRhdGFEZXN0cnVjdFJlYWR5KGRhdGEpe1xuICAgIGNvbnN0IGlzTWVtTWF4ZWQgPSBkYXRhWydtYXhBZ2UnXSAmJiB0aGlzLmhhc01heEFnZWQoZGF0YVsnX3RpbWVzdGFtcCddLCBkYXRhWydtYXhBZ2UnXSlcbiAgICBjb25zdCBpc01lbUV4cGlyZWQgPSBkYXRhWydleHBpcmVzJ10gJiYgdGhpcy5oYXNFeHBpcmVkKGRhdGFbJ190aW1lc3RhbXAnXSwgZGF0YVsnZXhwaXJlcyddKVxuICAgIHJldHVybiBpc01lbU1heGVkIHx8IGlzTWVtRXhwaXJlZFxuICB9XG5cbiAgZ2V0KFxuICAgIG5hbWU6c3RyaW5nLFxuICAgIG9wdGlvbnM6Y2FjaGVNb2RlbD08Y2FjaGVNb2RlbD57ZXhwaXJlczpudWxsfVxuICApe1xuICAgIHJldHVybiBzdXBlci5nZXQobmFtZSlcbiAgICAudGhlbihkYXRhPT57XG4gICAgICBpZihkYXRhKXtcbiAgICAgICAgcmV0dXJuIHRoaXMuY2FjaGVUb1JldHVybihuYW1lLCBkYXRhLCBvcHRpb25zKVxuICAgICAgfVxuXG4gICAgICBpZihvcHRpb25zLnBhcmFtKXJldHVybiBvcHRpb25zLnBhcmFtXG5cbiAgICAgIHJldHVyblxuICAgIH0pXG4gIH1cblxuICAvKiogYWthIGdldCAqL1xuICBnZXRDYWNoZShuYW1lOnN0cmluZywgb3B0aW9ucz86Y2FjaGVNb2RlbCl7XG4gICAgcmV0dXJuIHRoaXMuZ2V0KG5hbWUsIG9wdGlvbnMpXG4gIH1cblxuICAvKiogcGFzdGUgY2FjaGUgb3ZlciBjYWNoZSwgbGVhdmUgYWxsIGVsc2UgYWxvbmUgKi9cbiAgZGF0YU9wdGlvbnNDYWNoZShhbGxDYWNoZSwgb3B0aW9uczpjYWNoZU1vZGVsPTxjYWNoZU1vZGVsPnt9LCBjYWNoZTphbnkpe1xuICAgIGNvbnN0IG5ld09wdGlvbnM6YW55ID0ge31cbiAgICBcbiAgICBuZXdPcHRpb25zLl90aW1lc3RhbXAgPSBEYXRlLm5vdygpXG4gICAgaWYob3B0aW9ucy5leHBpcmVzKW5ld09wdGlvbnMuZXhwaXJlcyA9IG9wdGlvbnMuZXhwaXJlc1xuICAgIGlmKG9wdGlvbnMubWF4QWdlKW5ld09wdGlvbnMubWF4QWdlID0gb3B0aW9ucy5tYXhBZ2VcbiAgICBcbiAgICBhbGxDYWNoZSA9IGFsbENhY2hlICYmIGFsbENhY2hlLmNvbnN0cnVjdG9yIT1TdHJpbmcgPyBhbGxDYWNoZSA6IHt9XG5cbiAgICBPYmplY3QuYXNzaWduKGFsbENhY2hlLCBuZXdPcHRpb25zKVxuICAgIGlmKGNhY2hlICYmIGNhY2hlLmNvbnN0cnVjdG9yPT1TdHJpbmcpe1xuICAgICAgYWxsQ2FjaGUuY2FjaGUgPSBjYWNoZVxuICAgIH1lbHNlIGlmKGFsbENhY2hlLmNhY2hlICYmIGFsbENhY2hlLmNhY2hlLmNvbnN0cnVjdG9yIT1TdHJpbmcpe1xuICAgICAgT2JqZWN0LmFzc2lnbihhbGxDYWNoZS5jYWNoZSwgY2FjaGUpICAgICAgXG4gICAgfWVsc2V7XG4gICAgICBhbGxDYWNoZS5jYWNoZSA9IGNhY2hlXG4gICAgfVxuXG4gICAgcmV0dXJuIGFsbENhY2hlXG4gIH1cblxuICBzZXQoXG4gICAgbmFtZTpzdHJpbmcsXG4gICAgY2FjaGU6YW55LFxuICAgIG9wdGlvbnM6Y2FjaGVNb2RlbD08Y2FjaGVNb2RlbD57fVxuICApIHtcbiAgICBvcHRpb25zLm5hbWUgPSBvcHRpb25zLm5hbWUgfHwgbmFtZVxuICAgIHJldHVybiBzdXBlci5nZXQobmFtZSlcbiAgICAudGhlbiggYWxsQ2FjaGU9PnRoaXMuZGF0YU9wdGlvbnNDYWNoZShhbGxDYWNoZSwgb3B0aW9ucywgY2FjaGUpIClcbiAgICAudGhlbiggZGF0YT0+c3VwZXIuc2V0KG5hbWUsIGRhdGEpIClcbiAgfVxuXG4gIC8qKiBha2Egc2V0ICovXG4gIHNldENhY2hlKFxuICAgIG5hbWU6c3RyaW5nLFxuICAgIGNhY2hlOmFueSxcbiAgICBvcHRpb25zPzpjYWNoZU1vZGVsXG4gICl7XG4gICAgcmV0dXJuIHRoaXMuc2V0KG5hbWUsIGNhY2hlLCBvcHRpb25zKVxuICB9XG59Il19