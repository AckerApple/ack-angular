import { Injectable, EventEmitter } from "@angular/core";
import { HttpParams, HttpEventType, HttpHeaders, HttpClient, HttpRequest } from "@angular/common/http";
import { AckCache } from "./AckCache";
import { AckQue } from "./AckQue";
export function TimeOutError(message) {
    Error["captureStackTrace"](this, this.constructor);
    this.name = this.constructor.name;
    this.status = 504;
    this.code = "gateway_timeout";
    this.message = message || "Could not connect to server or server did not respond in a timely manner. Please check internet connection and then try again.";
    ////"Request time expired. Possible internet connection has been interrupted or requested server did not respond in a timely manner."
}
TimeOutError.prototype = Object.create(Error.prototype);
/** Http util with offline config for request failures */
export class AckApi {
    constructor(HttpClient) {
        this.HttpClient = HttpClient;
        //Angular5
        this.response = new EventEmitter();
        //Angular4
        //response:EventEmitter<Response> = new EventEmitter()
        this.Request = new EventEmitter();
        this.AuthError = new EventEmitter();
        this.ApiError = new EventEmitter();
        this.AckCache = new AckCache();
        this.AckQue = new AckQue();
        this.config = {
            baseUrl: "",
            $http: {
                method: "GET",
                headers: {},
                timeout: 6500 //4000//8000
            }
        };
        this.paramConfig();
    }
    /** an empty function for inheritance to hook into */
    paramConfig() { }
    /** START HERE. Handlers must be registered before sending requests
      @options{maxTry:50}
    */
    registerHandler(name, handler, options) {
        options = options || { maxTry: 50 };
        handler = handler || (config => this.request(config));
        this.AckQue.registerHandler(name, handler);
        return this;
    }
    getQue(name) {
        return this.AckQue.get(name);
    }
    getCache(name) {
        return this.AckCache.get(name);
    }
    /** when back online, run this function */
    processQue(name) {
        this.AckQue.paramHandler(name, config => this._fetch(config));
        return this.AckQue.processQue(name);
    }
    /** clears POST/PUT/PATCH/DELETE que */
    clearQue(name) {
        return this.AckQue.clear(name);
        //.then( ()=>this.AckCache.clear(name) )
    }
    /** clears GET cache */
    clearCache(name) {
        return this.AckCache.clear(name);
    }
    /** method all request transactions tunnel thru to instead try for cache first
      HINT: @config.offlineModel, when defined:
        - POST/PUT/PATCH requests goto que if they fail.
        - GET responses are cached with optional expires or maxAge option
    */
    request(config) {
        const defaults = Object.assign({}, this.config.$http);
        defaults.headers = Object.assign({}, this.config.$http.headers); //cause a deeper clone and break memory ref with apiConfig.$http
        const request = Object.assign(defaults, (config || {}));
        request.url = this.config.baseUrl + request.url;
        //removed 11/16/2017
        //Object.assign(request.headers, this.config.$http.headers)//enforced config/defaults . apiConfig act as an overwriter of headers
        //has cache instructions?
        if (request.offlineModel) {
            return this.requestOfflineModel(request);
        }
        return this._fetch(request);
    }
    getCacheByNamedRequest(request) {
        const offlineModel = request.offlineModel;
        return this.AckCache.get(offlineModel.name, offlineModel)
            .then(routes => {
            routes = routes || {};
            const cacheName = this.getStorageNameByRequest(request);
            return routes[cacheName]; //get cache by url
        })
            .then(cache => this.processCacheGet(cache, request));
    }
    getStorageNameByRequest(request) {
        if (request.params) {
            const paramKeys = Object.keys(request.params);
            if (!paramKeys.length)
                return request.url;
            let url = request.url + (request.url.search(/\?/) >= 0 ? "&" : "?");
            paramKeys.sort().forEach(name => url += name + "=" + request.params[name] + "&");
            return url.substring(0, url.length - 1); //remove last amp
        }
        return request.url;
    }
    requestOfflineModel(request) {
        let offlineModel = request.offlineModel;
        if (offlineModel && offlineModel.constructor == String) {
            request.offlineModel = offlineModel = { name: request.offlineModel };
        }
        if (request.method === "GET") {
            return this.getCacheByNamedRequest(request);
        }
        this.AckQue.paramHandler(offlineModel.name, config => this._fetch(config));
        //request is a PUT, POST, PATCH, or DELETE
        return this._fetch(request)
            .catch(e => this.postRequestFail(e, request)); //if fail, save config for later
    }
    processCacheGet(cache, cfg) {
        if (cache == null)
            return this._fetch(cfg);
        const offlineModel = cfg.offlineModel;
        return this.AckCache.cacheToReturn(offlineModel.name, cache, offlineModel)
            .then(rtn => {
            const willExpire = this.AckCache.optionsKillCache(offlineModel);
            if (rtn && !willExpire) {
                console.log("AckApi fetched cache that will never expire. Set offlineModel.expires=0 or offlineModel.maxAge=0 to avoid this message", rtn);
            }
            if (rtn != null) {
                return rtn;
            }
            return this._fetch(cfg);
        });
    }
    postRequestFail(e, request) {
        const saveWorthy = e.status == 0 || e.status == -1 || e.status == 503;
        if (!saveWorthy)
            return Promise.reject(e);
        request.sendFailMeta = request.sendFailMeta || {};
        request.sendFailMeta.offlineId = Date.now(); //this.getStorageNameByRequest(request)
        request.sendFailMeta.lastAttempt = new Date();
        request.sendFailMeta.attempts = request.sendFailMeta.attempts == null ? 1 : ++request.sendFailMeta.attempts;
        request.sendFailMeta.maxTry = request.sendFailMeta.maxTry || 50;
        const tryAgainLater = request.sendFailMeta.maxTry && request.sendFailMeta.attempts <= request.sendFailMeta.maxTry;
        e.sendFailMeta = request.sendFailMeta;
        if (tryAgainLater) {
            const requestSave = Object.assign({}, request);
            delete requestSave.offlineModel; //only used for GET method
            const offlineModel = request.offlineModel;
            return this.AckQue.set(offlineModel.name, requestSave)
                .then(() => Promise.reject(e));
        }
        return Promise.reject(e);
    }
    /** master method for sending requests and caching responses using $http requests
      @cfg{
        catch:"data"//typically only error data is returned, but if catch!="data" then entire response is returned for a caught error
        promise:"data"//typically only data is returned, but if promise!="data" then entire response is returned
        headers:{}//when sending a file "Content-Type":undefined so that no content-type header is sent
      }
    */
    _fetch(cfg) {
        upgradeConfig(cfg);
        const cfgPlus = Object.assign({}, cfg);
        if (cfg.params) {
            cfgPlus.params = new HttpParams({
                fromObject: cfg.params
            });
        }
        if (cfg.headers) {
            cfgPlus.headers = new HttpHeaders(cfg.headers);
        }
        const request = new HttpRequest(cfg.method, cfg.url, cfg.body, cfgPlus);
        const promise = (resolve, reject) => {
            let resolved = false;
            this.Request.emit(request);
            const req = this.HttpClient.request(request)
                .subscribe(event => {
                if (event.type === HttpEventType.Response) {
                    resolved = true;
                    resolve(event);
                }
            }, err => {
                resolved = true;
                reject(err);
            });
            if (cfg.timeout) {
                setTimeout(() => {
                    if (resolved)
                        return;
                    req.unsubscribe();
                    const timeoutError = new TimeOutError();
                    Object.assign(timeoutError, request);
                    timeoutError.timeout = cfg.timeout;
                    reject(timeoutError);
                }, cfg.timeout);
            }
        };
        return new Promise(promise)
            .then((response) => this.processFetchByConfig(response, cfg))
            .catch(e => this.httpFailByConfig(e, cfg));
    }
    /** Once a request is successful, this is the primary processor */
    processFetchByConfig(response, request) {
        this.response.emit(response); //let subscribers of all responses know we got one
        const data = response.body || response["_body"]; //Angular5.body or Angular4._body
        const isJson = data && response.headers.get("Content-Type") == "application/json";
        if (isJson && !response["data"]) {
            try {
                response["data"] = JSON.parse(data);
            }
            catch (e) { }
        }
        response["data"] = data; //Since angularJs backwords compat and leaves original body string alone
        const isDataMode = !request.promise || request.promise == "data";
        const output = isDataMode ? data : response;
        const isCacheReponse = request.method === "GET" && request.offlineModel;
        if (isCacheReponse) {
            return this.requestResponseToCache(request, output)
                .then(() => output);
        }
        return Promise.resolve(output);
    }
    httpFailByConfig(e, cfg) {
        const isReduceData = cfg.catch == null || cfg.catch == "data";
        const data = e["data"];
        const isCatchData = isReduceData && data && data.error;
        //find JSON error object and reduce to
        if (isCatchData) {
            const newError = new Error();
            Object.assign(newError, e["data"].error);
            e = newError;
        }
        e["method"] = e["method"] || cfg.method;
        if (e["status"] == 401) {
            this.AuthError.emit(e);
        }
        else {
            this.ApiError.emit(e);
        }
        return Promise.reject(e);
    }
    requestResponseToCache(request, output) {
        const cachename = request.offlineModel.name || request.offlineModel;
        return this.AckCache.get(cachename)
            .then(routes => {
            routes = routes || {};
            const cacheName = this.getStorageNameByRequest(request);
            routes[cacheName] = { cache: output };
            this.AckCache.dataOptionsCache(routes[request.url], request.offlineModel, output);
            return routes;
        })
            .then(routes => this.AckCache.set(cachename, routes));
    }
    get(path, config) {
        const cfg = Object.assign({}, config);
        cfg.method = "GET";
        cfg.url = path;
        return this.request(cfg);
    }
    post(path, data, config) {
        const cfg = Object.assign({}, config);
        cfg.method = "POST";
        //cfg.data = data
        cfg.body = data;
        cfg.url = path;
        return this.request(cfg);
    }
    delete(path, config) {
        const cfg = Object.assign({}, config);
        cfg.method = "DELETE";
        cfg.url = path;
        return this.request(cfg);
    }
    put(path, data, config) {
        const cfg = Object.assign({}, config);
        cfg.method = "PUT";
        //cfg.data = data
        cfg.body = data;
        cfg.url = path;
        return this.request(cfg);
    }
}
AckApi.decorators = [
    { type: Injectable }
];
AckApi.ctorParameters = () => [
    { type: HttpClient }
];
/** prevent angular1 from assuming the header to send is application/json */
function upgradeConfig(cfg) {
    cfg.method = cfg.method || "GET";
    cfg.reportProgress = cfg.reportProgress || false;
    //A trick from AngularJs to prevent header auto population
    /*const isFormData = cfg.body && FormData && cfg.body.constructor==FormData
    if(isFormData){
      const preventAutoContentType =  !cfg.headers || Object.keys(cfg.headers).filter(h=>h.search(/content-type/i)<0)
      
      if(preventAutoContentType){
        cfg.headers["Content-Type"] = undefined//"multipart/form-data;"
      }
    }*/
    //cast url variables nulls to empty-string
    if (cfg.params) {
        for (let key in cfg.params) {
            if (cfg.params[key] == null) {
                cfg.params[key] = "";
            }
        }
    }
    return cfg;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQWNrQXBpLmpzIiwic291cmNlUm9vdCI6Ii4uLy4uL3NyYy8iLCJzb3VyY2VzIjpbIm1vZHVsZXMvb2ZmbGluZS9BY2tBcGkudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxZQUFZLEVBQUUsTUFBTSxlQUFlLENBQUE7QUFFeEQsT0FBTyxFQUNMLFVBQVUsRUFDVixhQUFhLEVBQ2IsV0FBVyxFQUNYLFVBQVUsRUFDVixXQUFXLEVBR1osTUFBTSxzQkFBc0IsQ0FBQTtBQUU3QixPQUFPLEVBQUUsUUFBUSxFQUFjLE1BQU0sWUFBWSxDQUFBO0FBQ2pELE9BQU8sRUFBRSxNQUFNLEVBQUUsTUFBTSxVQUFVLENBQUE7QUFhakMsTUFBTSxVQUFVLFlBQVksQ0FBRSxPQUFlO0lBQzNDLEtBQUssQ0FBQyxtQkFBbUIsQ0FBQyxDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsV0FBVyxDQUFDLENBQUE7SUFDbEQsSUFBSSxDQUFDLElBQUksR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQTtJQUNqQyxJQUFJLENBQUMsTUFBTSxHQUFHLEdBQUcsQ0FBQTtJQUNqQixJQUFJLENBQUMsSUFBSSxHQUFHLGlCQUFpQixDQUFBO0lBQzdCLElBQUksQ0FBQyxPQUFPLEdBQUcsT0FBTyxJQUFJLGdJQUFnSSxDQUFBO0lBQzFKLHFJQUFxSTtBQUN2SSxDQUFDO0FBQ0QsWUFBWSxDQUFDLFNBQVMsR0FBRyxNQUFNLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxTQUFTLENBQUMsQ0FBQTtBQUV2RCx5REFBeUQ7QUFDM0MsTUFBTSxPQUFPLE1BQU07SUFxQi9CLFlBQW1CLFVBQXFCO1FBQXJCLGVBQVUsR0FBVixVQUFVLENBQVc7UUFwQnhDLFVBQVU7UUFDVixhQUFRLEdBQWdELElBQUksWUFBWSxFQUFFLENBQUE7UUFDMUUsVUFBVTtRQUNWLHNEQUFzRDtRQUV0RCxZQUFPLEdBQStDLElBQUksWUFBWSxFQUFFLENBQUE7UUFDeEUsY0FBUyxHQUF1QixJQUFJLFlBQVksRUFBRSxDQUFBO1FBQ2xELGFBQVEsR0FBdUIsSUFBSSxZQUFZLEVBQUUsQ0FBQTtRQUVqRCxhQUFRLEdBQUcsSUFBSSxRQUFRLEVBQUUsQ0FBQTtRQUN6QixXQUFNLEdBQUcsSUFBSSxNQUFNLEVBQUUsQ0FBQTtRQUNyQixXQUFNLEdBQXdCO1lBQzVCLE9BQU8sRUFBQyxFQUFFO1lBQ1YsS0FBSyxFQUFDO2dCQUNKLE1BQU0sRUFBQyxLQUFLO2dCQUNaLE9BQU8sRUFBQyxFQUFFO2dCQUNWLE9BQU8sRUFBRSxJQUFJLENBQUEsWUFBWTthQUMxQjtTQUNGLENBQUE7UUFHQyxJQUFJLENBQUMsV0FBVyxFQUFFLENBQUE7SUFDcEIsQ0FBQztJQUVELHFEQUFxRDtJQUNyRCxXQUFXLEtBQUcsQ0FBQztJQUVmOztNQUVFO0lBQ0YsZUFBZSxDQUNiLElBQVcsRUFDWCxPQUFrQyxFQUNsQyxPQUFxQjtRQUVyQixPQUFPLEdBQUcsT0FBTyxJQUFJLEVBQUMsTUFBTSxFQUFDLEVBQUUsRUFBQyxDQUFBO1FBQ2hDLE9BQU8sR0FBRyxPQUFPLElBQUksQ0FBQyxNQUFNLENBQUEsRUFBRSxDQUFBLElBQUksQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQTtRQUNuRCxJQUFJLENBQUMsTUFBTSxDQUFDLGVBQWUsQ0FBQyxJQUFJLEVBQUUsT0FBTyxDQUFDLENBQUE7UUFDMUMsT0FBTyxJQUFJLENBQUE7SUFDYixDQUFDO0lBRUQsTUFBTSxDQUFDLElBQVc7UUFDaEIsT0FBTyxJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQTtJQUM5QixDQUFDO0lBRUQsUUFBUSxDQUFDLElBQVc7UUFDbEIsT0FBTyxJQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQTtJQUNoQyxDQUFDO0lBRUQsMENBQTBDO0lBQzFDLFVBQVUsQ0FBQyxJQUFXO1FBQ3BCLElBQUksQ0FBQyxNQUFNLENBQUMsWUFBWSxDQUFDLElBQUksRUFBQyxNQUFNLENBQUEsRUFBRSxDQUFBLElBQUksQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQTtRQUMxRCxPQUFPLElBQUksQ0FBQyxNQUFNLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxDQUFBO0lBQ3JDLENBQUM7SUFFRCx1Q0FBdUM7SUFDdkMsUUFBUSxDQUFDLElBQVc7UUFDbEIsT0FBTyxJQUFJLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQTtRQUM5Qix3Q0FBd0M7SUFDMUMsQ0FBQztJQUVELHVCQUF1QjtJQUN2QixVQUFVLENBQUMsSUFBSTtRQUNiLE9BQU8sSUFBSSxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUE7SUFDbEMsQ0FBQztJQUVEOzs7O01BSUU7SUFDRixPQUFPLENBQ0wsTUFBa0I7UUFFbEIsTUFBTSxRQUFRLHFCQUFvQixJQUFJLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBRSxDQUFBO1FBRXJELFFBQVEsQ0FBQyxPQUFPLHFCQUFRLElBQUksQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBRSxDQUFBLENBQUEsZ0VBQWdFO1FBRW5ILE1BQU0sT0FBTyxHQUFHLE1BQU0sQ0FBQyxNQUFNLENBQUMsUUFBUSxFQUFFLENBQUMsTUFBTSxJQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUE7UUFDckQsT0FBTyxDQUFDLEdBQUcsR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDLE9BQU8sR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFBO1FBRS9DLG9CQUFvQjtRQUNwQixpSUFBaUk7UUFFakkseUJBQXlCO1FBQ3pCLElBQUksT0FBTyxDQUFDLFlBQVksRUFBRTtZQUN4QixPQUFPLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxPQUFPLENBQUMsQ0FBQTtTQUN6QztRQUVELE9BQU8sSUFBSSxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsQ0FBQTtJQUM3QixDQUFDO0lBRUQsc0JBQXNCLENBQ3BCLE9BQW1CO1FBRW5CLE1BQU0sWUFBWSxHQUFlLE9BQU8sQ0FBQyxZQUFZLENBQUE7UUFDckQsT0FBTyxJQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxZQUFZLENBQUMsSUFBSSxFQUFFLFlBQVksQ0FBQzthQUN4RCxJQUFJLENBQUMsTUFBTSxDQUFBLEVBQUU7WUFDWixNQUFNLEdBQUcsTUFBTSxJQUFJLEVBQUUsQ0FBQTtZQUNyQixNQUFNLFNBQVMsR0FBRyxJQUFJLENBQUMsdUJBQXVCLENBQUMsT0FBTyxDQUFDLENBQUE7WUFDdkQsT0FBTyxNQUFNLENBQUUsU0FBUyxDQUFFLENBQUEsQ0FBQSxrQkFBa0I7UUFDOUMsQ0FBQyxDQUFDO2FBQ0QsSUFBSSxDQUFDLEtBQUssQ0FBQSxFQUFFLENBQUEsSUFBSSxDQUFDLGVBQWUsQ0FBQyxLQUFLLEVBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQTtJQUNuRCxDQUFDO0lBRUQsdUJBQXVCLENBQ3JCLE9BQW1CO1FBRW5CLElBQUksT0FBTyxDQUFDLE1BQU0sRUFBRTtZQUNsQixNQUFNLFNBQVMsR0FBRyxNQUFNLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQTtZQUU3QyxJQUFHLENBQUMsU0FBUyxDQUFDLE1BQU07Z0JBQUMsT0FBTyxPQUFPLENBQUMsR0FBRyxDQUFBO1lBRXZDLElBQUksR0FBRyxHQUFHLE9BQU8sQ0FBQyxHQUFHLEdBQUcsQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsSUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUE7WUFDakUsU0FBUyxDQUFDLElBQUksRUFBRSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUEsRUFBRSxDQUFBLEdBQUcsSUFBRSxJQUFJLEdBQUMsR0FBRyxHQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLEdBQUMsR0FBRyxDQUFDLENBQUE7WUFFdEUsT0FBTyxHQUFHLENBQUMsU0FBUyxDQUFDLENBQUMsRUFBRSxHQUFHLENBQUMsTUFBTSxHQUFDLENBQUMsQ0FBQyxDQUFBLENBQUEsaUJBQWlCO1NBQ3ZEO1FBRUQsT0FBTyxPQUFPLENBQUMsR0FBRyxDQUFBO0lBQ3BCLENBQUM7SUFFRCxtQkFBbUIsQ0FDakIsT0FBbUI7UUFFbkIsSUFBSSxZQUFZLEdBQWUsT0FBTyxDQUFDLFlBQVksQ0FBQTtRQUVuRCxJQUFHLFlBQVksSUFBSSxZQUFZLENBQUMsV0FBVyxJQUFFLE1BQU0sRUFBQztZQUNsRCxPQUFPLENBQUMsWUFBWSxHQUFHLFlBQVksR0FBZSxFQUFFLElBQUksRUFBQyxPQUFPLENBQUMsWUFBWSxFQUFFLENBQUE7U0FDaEY7UUFFRCxJQUFJLE9BQU8sQ0FBQyxNQUFNLEtBQUssS0FBSyxFQUFFO1lBQzVCLE9BQU8sSUFBSSxDQUFDLHNCQUFzQixDQUFDLE9BQU8sQ0FBQyxDQUFBO1NBQzVDO1FBRUQsSUFBSSxDQUFDLE1BQU0sQ0FBQyxZQUFZLENBQUMsWUFBWSxDQUFDLElBQUksRUFBQyxNQUFNLENBQUEsRUFBRSxDQUFBLElBQUksQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQTtRQUV2RSwwQ0FBMEM7UUFDMUMsT0FBTyxJQUFJLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQzthQUMxQixLQUFLLENBQUUsQ0FBQyxDQUFBLEVBQUUsQ0FBQSxJQUFJLENBQUMsZUFBZSxDQUFDLENBQUMsRUFBQyxPQUFPLENBQUMsQ0FBRSxDQUFBLENBQUEsZ0NBQWdDO0lBQzlFLENBQUM7SUFFRCxlQUFlLENBQ2IsS0FBUyxFQUNULEdBQWU7UUFFZixJQUFHLEtBQUssSUFBRSxJQUFJO1lBQUMsT0FBTyxJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFBO1FBRXRDLE1BQU0sWUFBWSxHQUFlLEdBQUcsQ0FBQyxZQUFZLENBQUE7UUFFakQsT0FBTyxJQUFJLENBQUMsUUFBUSxDQUFDLGFBQWEsQ0FBQyxZQUFZLENBQUMsSUFBSSxFQUFFLEtBQUssRUFBRSxZQUFZLENBQUM7YUFDekUsSUFBSSxDQUFDLEdBQUcsQ0FBQSxFQUFFO1lBQ1QsTUFBTSxVQUFVLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxnQkFBZ0IsQ0FBRSxZQUFZLENBQUUsQ0FBQTtZQUVqRSxJQUFJLEdBQUcsSUFBSSxDQUFDLFVBQVUsRUFBRTtnQkFDdEIsT0FBTyxDQUFDLEdBQUcsQ0FBQyx3SEFBd0gsRUFBRSxHQUFHLENBQUMsQ0FBQTthQUMzSTtZQUVELElBQUksR0FBRyxJQUFFLElBQUksRUFBRTtnQkFDYixPQUFPLEdBQUcsQ0FBQTthQUNYO1lBRUQsT0FBTyxJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFBO1FBQ3pCLENBQUMsQ0FBQyxDQUFBO0lBQ0osQ0FBQztJQUVELGVBQWUsQ0FDYixDQUFDLEVBQUUsT0FBbUI7UUFFdEIsTUFBTSxVQUFVLEdBQUcsQ0FBQyxDQUFDLE1BQU0sSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLE1BQU0sSUFBSSxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsTUFBTSxJQUFJLEdBQUcsQ0FBQTtRQUVyRSxJQUFHLENBQUMsVUFBVTtZQUFDLE9BQU8sT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQTtRQUV2QyxPQUFPLENBQUMsWUFBWSxHQUFHLE9BQU8sQ0FBQyxZQUFZLElBQWtCLEVBQUUsQ0FBQTtRQUMvRCxPQUFPLENBQUMsWUFBWSxDQUFDLFNBQVMsR0FBRyxJQUFJLENBQUMsR0FBRyxFQUFFLENBQUEsQ0FBQSx1Q0FBdUM7UUFDbEYsT0FBTyxDQUFDLFlBQVksQ0FBQyxXQUFXLEdBQUcsSUFBSSxJQUFJLEVBQUUsQ0FBQTtRQUM3QyxPQUFPLENBQUMsWUFBWSxDQUFDLFFBQVEsR0FBRyxPQUFPLENBQUMsWUFBWSxDQUFDLFFBQVEsSUFBRSxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFBRSxPQUFPLENBQUMsWUFBWSxDQUFDLFFBQVEsQ0FBQTtRQUN6RyxPQUFPLENBQUMsWUFBWSxDQUFDLE1BQU0sR0FBRyxPQUFPLENBQUMsWUFBWSxDQUFDLE1BQU0sSUFBSSxFQUFFLENBQUE7UUFDL0QsTUFBTSxhQUFhLEdBQUcsT0FBTyxDQUFDLFlBQVksQ0FBQyxNQUFNLElBQUksT0FBTyxDQUFDLFlBQVksQ0FBQyxRQUFRLElBQUksT0FBTyxDQUFDLFlBQVksQ0FBQyxNQUFNLENBQUE7UUFFakgsQ0FBQyxDQUFDLFlBQVksR0FBRyxPQUFPLENBQUMsWUFBWSxDQUFBO1FBRXJDLElBQUcsYUFBYSxFQUFDO1lBQ2YsTUFBTSxXQUFXLEdBQUcsTUFBTSxDQUFDLE1BQU0sQ0FBQyxFQUFFLEVBQUUsT0FBTyxDQUFDLENBQUE7WUFDOUMsT0FBTyxXQUFXLENBQUMsWUFBWSxDQUFBLENBQUEsMEJBQTBCO1lBQ3pELE1BQU0sWUFBWSxHQUFlLE9BQU8sQ0FBQyxZQUFZLENBQUE7WUFDckQsT0FBTyxJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxZQUFZLENBQUMsSUFBSSxFQUFFLFdBQVcsQ0FBQztpQkFDckQsSUFBSSxDQUFFLEdBQUUsRUFBRSxDQUFBLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUUsQ0FBQTtTQUMvQjtRQUVELE9BQU8sT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQTtJQUMxQixDQUFDO0lBRUQ7Ozs7OztNQU1FO0lBQ0YsTUFBTSxDQUNKLEdBQWU7UUFFZixhQUFhLENBQUMsR0FBRyxDQUFDLENBQUE7UUFFbEIsTUFBTSxPQUFPLHFCQUFPLEdBQUcsQ0FBQyxDQUFBO1FBRXhCLElBQUksR0FBRyxDQUFDLE1BQU0sRUFBRTtZQUNkLE9BQU8sQ0FBQyxNQUFNLEdBQUcsSUFBSSxVQUFVLENBQUM7Z0JBQzlCLFVBQVUsRUFBQyxHQUFHLENBQUMsTUFBTTthQUN0QixDQUFDLENBQUE7U0FDSDtRQUVELElBQUksR0FBRyxDQUFDLE9BQU8sRUFBRTtZQUNmLE9BQU8sQ0FBQyxPQUFPLEdBQUcsSUFBSSxXQUFXLENBQUUsR0FBRyxDQUFDLE9BQU8sQ0FBRSxDQUFBO1NBQ2pEO1FBRUQsTUFBTSxPQUFPLEdBQUcsSUFBSSxXQUFXLENBQzdCLEdBQUcsQ0FBQyxNQUFNLEVBQ1YsR0FBRyxDQUFDLEdBQUcsRUFDUCxHQUFHLENBQUMsSUFBSSxFQUNSLE9BQU8sQ0FDUixDQUFBO1FBRUQsTUFBTSxPQUFPLEdBQUcsQ0FBQyxPQUFPLEVBQUMsTUFBTSxFQUFDLEVBQUU7WUFDaEMsSUFBSSxRQUFRLEdBQUcsS0FBSyxDQUFBO1lBQ3BCLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFFLE9BQU8sQ0FBRSxDQUFBO1lBRTVCLE1BQU0sR0FBRyxHQUFHLElBQUksQ0FBQyxVQUFVLENBQUMsT0FBTyxDQUFFLE9BQU8sQ0FBRTtpQkFDN0MsU0FBUyxDQUFDLEtBQUssQ0FBQSxFQUFFO2dCQUNoQixJQUFJLEtBQUssQ0FBQyxJQUFJLEtBQUssYUFBYSxDQUFDLFFBQVEsRUFBRTtvQkFDekMsUUFBUSxHQUFHLElBQUksQ0FBQTtvQkFDZixPQUFPLENBQUUsS0FBSyxDQUFFLENBQUE7aUJBQ2pCO1lBQ0gsQ0FBQyxFQUFDLEdBQUcsQ0FBQSxFQUFFO2dCQUNMLFFBQVEsR0FBQyxJQUFJLENBQUE7Z0JBQ2IsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFBO1lBQ2IsQ0FBQyxDQUFDLENBQUE7WUFFRixJQUFJLEdBQUcsQ0FBQyxPQUFPLEVBQUU7Z0JBQ2YsVUFBVSxDQUFDLEdBQUUsRUFBRTtvQkFDYixJQUFHLFFBQVE7d0JBQUMsT0FBTTtvQkFDbEIsR0FBRyxDQUFDLFdBQVcsRUFBRSxDQUFBO29CQUNqQixNQUFNLFlBQVksR0FBRyxJQUFJLFlBQVksRUFBRSxDQUFBO29CQUN2QyxNQUFNLENBQUMsTUFBTSxDQUFDLFlBQVksRUFBQyxPQUFPLENBQUMsQ0FBQTtvQkFDbkMsWUFBWSxDQUFDLE9BQU8sR0FBRyxHQUFHLENBQUMsT0FBTyxDQUFBO29CQUNsQyxNQUFNLENBQUUsWUFBWSxDQUFFLENBQUE7Z0JBQ3hCLENBQUMsRUFBRSxHQUFHLENBQUMsT0FBTyxDQUFDLENBQUE7YUFDaEI7UUFDSCxDQUFDLENBQUE7UUFFRCxPQUFPLElBQUksT0FBTyxDQUFDLE9BQU8sQ0FBQzthQUMxQixJQUFJLENBQUMsQ0FBQyxRQUF1QyxFQUFDLEVBQUUsQ0FDL0MsSUFBSSxDQUFDLG9CQUFvQixDQUFDLFFBQVEsRUFBQyxHQUFHLENBQUMsQ0FDdkM7YUFDRCxLQUFLLENBQUUsQ0FBQyxDQUFBLEVBQUUsQ0FBQSxJQUFJLENBQUMsZ0JBQWdCLENBQUMsQ0FBQyxFQUFDLEdBQUcsQ0FBQyxDQUFFLENBQUE7SUFDM0MsQ0FBQztJQUVELGtFQUFrRTtJQUNsRSxvQkFBb0IsQ0FDbEIsUUFBdUMsRUFDdkMsT0FBbUI7UUFFbkIsSUFBSSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUEsQ0FBQSxrREFBa0Q7UUFFOUUsTUFBTSxJQUFJLEdBQUcsUUFBUSxDQUFDLElBQUksSUFBSSxRQUFRLENBQUMsT0FBTyxDQUFDLENBQUEsQ0FBQSxpQ0FBaUM7UUFDaEYsTUFBTSxNQUFNLEdBQUcsSUFBSSxJQUFJLFFBQVEsQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLGNBQWMsQ0FBQyxJQUFFLGtCQUFrQixDQUFBO1FBRS9FLElBQUcsTUFBTSxJQUFJLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxFQUFDO1lBQzdCLElBQUc7Z0JBQ0QsUUFBUSxDQUFDLE1BQU0sQ0FBQyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUUsSUFBSSxDQUFFLENBQUE7YUFDdEM7WUFBQSxPQUFNLENBQUMsRUFBQyxHQUFFO1NBQ1o7UUFFRCxRQUFRLENBQUMsTUFBTSxDQUFDLEdBQUcsSUFBSSxDQUFBLENBQUEsd0VBQXdFO1FBQy9GLE1BQU0sVUFBVSxHQUFHLENBQUMsT0FBTyxDQUFDLE9BQU8sSUFBSSxPQUFPLENBQUMsT0FBTyxJQUFFLE1BQU0sQ0FBQTtRQUM5RCxNQUFNLE1BQU0sR0FBRyxVQUFVLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsUUFBUSxDQUFBO1FBQzNDLE1BQU0sY0FBYyxHQUFHLE9BQU8sQ0FBQyxNQUFNLEtBQUssS0FBSyxJQUFJLE9BQU8sQ0FBQyxZQUFZLENBQUE7UUFFdkUsSUFBSyxjQUFjLEVBQUc7WUFDcEIsT0FBTyxJQUFJLENBQUMsc0JBQXNCLENBQUMsT0FBTyxFQUFFLE1BQU0sQ0FBQztpQkFDbEQsSUFBSSxDQUFFLEdBQUUsRUFBRSxDQUFBLE1BQU0sQ0FBRSxDQUFBO1NBQ3BCO1FBRUQsT0FBTyxPQUFPLENBQUMsT0FBTyxDQUFFLE1BQU0sQ0FBRSxDQUFBO0lBQ2xDLENBQUM7SUFFRCxnQkFBZ0IsQ0FBQyxDQUFPLEVBQUUsR0FBZTtRQUN2QyxNQUFNLFlBQVksR0FBRyxHQUFHLENBQUMsS0FBSyxJQUFFLElBQUksSUFBSSxHQUFHLENBQUMsS0FBSyxJQUFFLE1BQU0sQ0FBQTtRQUN6RCxNQUFNLElBQUksR0FBRyxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUE7UUFDdEIsTUFBTSxXQUFXLEdBQUcsWUFBWSxJQUFJLElBQUksSUFBSSxJQUFJLENBQUMsS0FBSyxDQUFBO1FBRXRELHNDQUFzQztRQUN0QyxJQUFHLFdBQVcsRUFBQztZQUNiLE1BQU0sUUFBUSxHQUFHLElBQUksS0FBSyxFQUFFLENBQUE7WUFDNUIsTUFBTSxDQUFDLE1BQU0sQ0FBQyxRQUFRLEVBQUUsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFBO1lBQ3hDLENBQUMsR0FBRyxRQUFRLENBQUE7U0FDYjtRQUVELENBQUMsQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLENBQUMsUUFBUSxDQUFDLElBQUksR0FBRyxDQUFDLE1BQU0sQ0FBQTtRQUV2QyxJQUFJLENBQUMsQ0FBQyxRQUFRLENBQUMsSUFBRSxHQUFHLEVBQUU7WUFDcEIsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUE7U0FDdkI7YUFBSTtZQUNILElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFBO1NBQ3RCO1FBRUQsT0FBTyxPQUFPLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFBO0lBQzFCLENBQUM7SUFFRCxzQkFBc0IsQ0FDcEIsT0FBTyxFQUFFLE1BQU07UUFFZixNQUFNLFNBQVMsR0FBRyxPQUFPLENBQUMsWUFBWSxDQUFDLElBQUksSUFBSSxPQUFPLENBQUMsWUFBWSxDQUFBO1FBQ25FLE9BQU8sSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsU0FBUyxDQUFDO2FBQ2xDLElBQUksQ0FBQyxNQUFNLENBQUEsRUFBRTtZQUNaLE1BQU0sR0FBRyxNQUFNLElBQUksRUFBRSxDQUFBO1lBQ3JCLE1BQU0sU0FBUyxHQUFHLElBQUksQ0FBQyx1QkFBdUIsQ0FBQyxPQUFPLENBQUMsQ0FBQTtZQUN2RCxNQUFNLENBQUUsU0FBUyxDQUFFLEdBQWUsRUFBQyxLQUFLLEVBQUMsTUFBTSxFQUFDLENBQUE7WUFDaEQsSUFBSSxDQUFDLFFBQVEsQ0FBQyxnQkFBZ0IsQ0FBQyxNQUFNLENBQUUsT0FBTyxDQUFDLEdBQUcsQ0FBRSxFQUFFLE9BQU8sQ0FBQyxZQUFZLEVBQUUsTUFBTSxDQUFDLENBQUE7WUFDbkYsT0FBTyxNQUFNLENBQUE7UUFDZixDQUFDLENBQUM7YUFDRCxJQUFJLENBQUMsTUFBTSxDQUFBLEVBQUUsQ0FBQSxJQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxTQUFTLEVBQUUsTUFBTSxDQUFDLENBQUMsQ0FBQTtJQUNyRCxDQUFDO0lBRUQsR0FBRyxDQUNELElBQVcsRUFDWCxNQUFtQjtRQUVuQixNQUFNLEdBQUcsR0FBRyxNQUFNLENBQUMsTUFBTSxDQUFDLEVBQUUsRUFBRSxNQUFNLENBQUMsQ0FBQTtRQUNyQyxHQUFHLENBQUMsTUFBTSxHQUFHLEtBQUssQ0FBQTtRQUNsQixHQUFHLENBQUMsR0FBRyxHQUFHLElBQUksQ0FBQTtRQUNkLE9BQU8sSUFBSSxDQUFDLE9BQU8sQ0FBRSxHQUFHLENBQUUsQ0FBQTtJQUM1QixDQUFDO0lBRUQsSUFBSSxDQUNGLElBQVcsRUFDWCxJQUFRLEVBQ1IsTUFBbUI7UUFFbkIsTUFBTSxHQUFHLEdBQUcsTUFBTSxDQUFDLE1BQU0sQ0FBQyxFQUFFLEVBQUUsTUFBTSxDQUFDLENBQUE7UUFDckMsR0FBRyxDQUFDLE1BQU0sR0FBRyxNQUFNLENBQUE7UUFDbkIsaUJBQWlCO1FBQ2pCLEdBQUcsQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFBO1FBQ2YsR0FBRyxDQUFDLEdBQUcsR0FBRyxJQUFJLENBQUE7UUFDZCxPQUFPLElBQUksQ0FBQyxPQUFPLENBQUUsR0FBRyxDQUFFLENBQUE7SUFDNUIsQ0FBQztJQUVELE1BQU0sQ0FDSixJQUFXLEVBQUUsTUFBbUI7UUFFaEMsTUFBTSxHQUFHLEdBQUcsTUFBTSxDQUFDLE1BQU0sQ0FBQyxFQUFFLEVBQUUsTUFBTSxDQUFDLENBQUE7UUFDckMsR0FBRyxDQUFDLE1BQU0sR0FBRyxRQUFRLENBQUE7UUFDckIsR0FBRyxDQUFDLEdBQUcsR0FBRyxJQUFJLENBQUE7UUFDZCxPQUFPLElBQUksQ0FBQyxPQUFPLENBQUUsR0FBRyxDQUFFLENBQUE7SUFDNUIsQ0FBQztJQUVELEdBQUcsQ0FDRCxJQUFJLEVBQUUsSUFBSSxFQUFFLE1BQU87UUFFbkIsTUFBTSxHQUFHLEdBQUcsTUFBTSxDQUFDLE1BQU0sQ0FBQyxFQUFFLEVBQUUsTUFBTSxDQUFDLENBQUE7UUFDckMsR0FBRyxDQUFDLE1BQU0sR0FBRyxLQUFLLENBQUE7UUFDbEIsaUJBQWlCO1FBQ2pCLEdBQUcsQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFBO1FBQ2YsR0FBRyxDQUFDLEdBQUcsR0FBRyxJQUFJLENBQUE7UUFDZCxPQUFPLElBQUksQ0FBQyxPQUFPLENBQUUsR0FBRyxDQUFFLENBQUE7SUFDNUIsQ0FBQzs7O1lBL1dGLFVBQVU7OztZQS9CVCxVQUFVOztBQTBaWiw0RUFBNEU7QUFDNUUsU0FBUyxhQUFhLENBQ3BCLEdBQWU7SUFFZixHQUFHLENBQUMsTUFBTSxHQUFHLEdBQUcsQ0FBQyxNQUFNLElBQUksS0FBSyxDQUFBO0lBRWhDLEdBQUcsQ0FBQyxjQUFjLEdBQUcsR0FBRyxDQUFDLGNBQWMsSUFBSSxLQUFLLENBQUE7SUFFaEQsMERBQTBEO0lBQzFEOzs7Ozs7O09BT0c7SUFFSCwwQ0FBMEM7SUFDMUMsSUFBSSxHQUFHLENBQUMsTUFBTSxFQUFFO1FBQ2QsS0FBSSxJQUFJLEdBQUcsSUFBSSxHQUFHLENBQUMsTUFBTSxFQUFDO1lBQ3hCLElBQUksR0FBRyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsSUFBRSxJQUFJLEVBQUU7Z0JBQ3pCLEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLEdBQUMsRUFBRSxDQUFBO2FBQ25CO1NBQ0Y7S0FDRjtJQUVELE9BQU8sR0FBRyxDQUFBO0FBQ1osQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUsIEV2ZW50RW1pdHRlciB9IGZyb20gXCJAYW5ndWxhci9jb3JlXCJcblxuaW1wb3J0IHtcbiAgSHR0cFBhcmFtcyxcbiAgSHR0cEV2ZW50VHlwZSxcbiAgSHR0cEhlYWRlcnMsXG4gIEh0dHBDbGllbnQsXG4gIEh0dHBSZXF1ZXN0LFxuICBIdHRwUmVzcG9uc2UsXG4gIEh0dHBFdmVudFxufSBmcm9tIFwiQGFuZ3VsYXIvY29tbW9uL2h0dHBcIlxuXG5pbXBvcnQgeyBBY2tDYWNoZSwgY2FjaGVNb2RlbCB9IGZyb20gXCIuL0Fja0NhY2hlXCJcbmltcG9ydCB7IEFja1F1ZSB9IGZyb20gXCIuL0Fja1F1ZVwiXG5cbmltcG9ydCB7XG4gIHNlbmRGYWlsTWV0YSwgaHR0cE9wdGlvbnNcbn0gZnJvbSBcIi4uLy4uL2h0dHBPcHRpb25zXCJcblxuZXhwb3J0IGludGVyZmFjZSBhcGlDb25maWd7XG4gIC8vcHJvbWlzZT8gOiBcImFsbFwifFwiZGF0YVwiLy90eXBpY2FsbHkganVzdCB0aGUgYm9keSBkYXRhIGlzIHByb21pc2VkXG4gIGJhc2VVcmw/IDogc3RyaW5nXG4gIC8vcGFyYW1zPyAgOiBhbnkvL3F1ZXJ5IHZhcnNcbiAgJGh0dHA/ICAgOiBodHRwT3B0aW9uc1xufVxuXG5leHBvcnQgZnVuY3Rpb24gVGltZU91dEVycm9yKCBtZXNzYWdlPzpzdHJpbmcgKXtcbiAgRXJyb3JbXCJjYXB0dXJlU3RhY2tUcmFjZVwiXSh0aGlzLCB0aGlzLmNvbnN0cnVjdG9yKVxuICB0aGlzLm5hbWUgPSB0aGlzLmNvbnN0cnVjdG9yLm5hbWVcbiAgdGhpcy5zdGF0dXMgPSA1MDRcbiAgdGhpcy5jb2RlID0gXCJnYXRld2F5X3RpbWVvdXRcIlxuICB0aGlzLm1lc3NhZ2UgPSBtZXNzYWdlIHx8IFwiQ291bGQgbm90IGNvbm5lY3QgdG8gc2VydmVyIG9yIHNlcnZlciBkaWQgbm90IHJlc3BvbmQgaW4gYSB0aW1lbHkgbWFubmVyLiBQbGVhc2UgY2hlY2sgaW50ZXJuZXQgY29ubmVjdGlvbiBhbmQgdGhlbiB0cnkgYWdhaW4uXCJcbiAgLy8vL1wiUmVxdWVzdCB0aW1lIGV4cGlyZWQuIFBvc3NpYmxlIGludGVybmV0IGNvbm5lY3Rpb24gaGFzIGJlZW4gaW50ZXJydXB0ZWQgb3IgcmVxdWVzdGVkIHNlcnZlciBkaWQgbm90IHJlc3BvbmQgaW4gYSB0aW1lbHkgbWFubmVyLlwiXG59XG5UaW1lT3V0RXJyb3IucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShFcnJvci5wcm90b3R5cGUpXG5cbi8qKiBIdHRwIHV0aWwgd2l0aCBvZmZsaW5lIGNvbmZpZyBmb3IgcmVxdWVzdCBmYWlsdXJlcyAqL1xuQEluamVjdGFibGUoKSBleHBvcnQgY2xhc3MgQWNrQXBpe1xuICAvL0FuZ3VsYXI1XG4gIHJlc3BvbnNlOkV2ZW50RW1pdHRlcjxIdHRwUmVzcG9uc2U8SHR0cEV2ZW50PEV2ZW50Pj4+ID0gbmV3IEV2ZW50RW1pdHRlcigpXG4gIC8vQW5ndWxhcjRcbiAgLy9yZXNwb25zZTpFdmVudEVtaXR0ZXI8UmVzcG9uc2U+ID0gbmV3IEV2ZW50RW1pdHRlcigpXG4gIFxuICBSZXF1ZXN0OkV2ZW50RW1pdHRlcjxIdHRwUmVxdWVzdDxIdHRwRXZlbnQ8RXZlbnQ+Pj4gPSBuZXcgRXZlbnRFbWl0dGVyKClcbiAgQXV0aEVycm9yOkV2ZW50RW1pdHRlcjxFcnJvcj4gPSBuZXcgRXZlbnRFbWl0dGVyKClcbiAgQXBpRXJyb3I6RXZlbnRFbWl0dGVyPEVycm9yPiA9IG5ldyBFdmVudEVtaXR0ZXIoKVxuXG4gIEFja0NhY2hlID0gbmV3IEFja0NhY2hlKClcbiAgQWNrUXVlID0gbmV3IEFja1F1ZSgpXG4gIGNvbmZpZzphcGlDb25maWcgPSA8YXBpQ29uZmlnPntcbiAgICBiYXNlVXJsOlwiXCIsXG4gICAgJGh0dHA6e1xuICAgICAgbWV0aG9kOlwiR0VUXCIsXG4gICAgICBoZWFkZXJzOnt9LFxuICAgICAgdGltZW91dDogNjUwMC8vNDAwMC8vODAwMFxuICAgIH1cbiAgfVxuXG4gIGNvbnN0cnVjdG9yKHB1YmxpYyBIdHRwQ2xpZW50Okh0dHBDbGllbnQpe1xuICAgIHRoaXMucGFyYW1Db25maWcoKVxuICB9XG5cbiAgLyoqIGFuIGVtcHR5IGZ1bmN0aW9uIGZvciBpbmhlcml0YW5jZSB0byBob29rIGludG8gKi9cbiAgcGFyYW1Db25maWcoKXt9XG5cbiAgLyoqIFNUQVJUIEhFUkUuIEhhbmRsZXJzIG11c3QgYmUgcmVnaXN0ZXJlZCBiZWZvcmUgc2VuZGluZyByZXF1ZXN0c1xuICAgIEBvcHRpb25ze21heFRyeTo1MH1cbiAgKi9cbiAgcmVnaXN0ZXJIYW5kbGVyKFxuICAgIG5hbWU6c3RyaW5nLFxuICAgIGhhbmRsZXI/Oihjb25maWc6aHR0cE9wdGlvbnMpPT5hbnksXG4gICAgb3B0aW9ucz86c2VuZEZhaWxNZXRhXG4gICl7XG4gICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge21heFRyeTo1MH1cbiAgICBoYW5kbGVyID0gaGFuZGxlciB8fCAoY29uZmlnPT50aGlzLnJlcXVlc3QoY29uZmlnKSlcbiAgICB0aGlzLkFja1F1ZS5yZWdpc3RlckhhbmRsZXIobmFtZSwgaGFuZGxlcilcbiAgICByZXR1cm4gdGhpc1xuICB9XG5cbiAgZ2V0UXVlKG5hbWU6c3RyaW5nKXtcbiAgICByZXR1cm4gdGhpcy5BY2tRdWUuZ2V0KG5hbWUpXG4gIH1cblxuICBnZXRDYWNoZShuYW1lOnN0cmluZyl7XG4gICAgcmV0dXJuIHRoaXMuQWNrQ2FjaGUuZ2V0KG5hbWUpXG4gIH1cblxuICAvKiogd2hlbiBiYWNrIG9ubGluZSwgcnVuIHRoaXMgZnVuY3Rpb24gKi9cbiAgcHJvY2Vzc1F1ZShuYW1lOnN0cmluZyk6UHJvbWlzZTxhbnk+e1xuICAgIHRoaXMuQWNrUXVlLnBhcmFtSGFuZGxlcihuYW1lLGNvbmZpZz0+dGhpcy5fZmV0Y2goY29uZmlnKSlcbiAgICByZXR1cm4gdGhpcy5BY2tRdWUucHJvY2Vzc1F1ZShuYW1lKVxuICB9XG5cbiAgLyoqIGNsZWFycyBQT1NUL1BVVC9QQVRDSC9ERUxFVEUgcXVlICovXG4gIGNsZWFyUXVlKG5hbWU6c3RyaW5nKXtcbiAgICByZXR1cm4gdGhpcy5BY2tRdWUuY2xlYXIobmFtZSlcbiAgICAvLy50aGVuKCAoKT0+dGhpcy5BY2tDYWNoZS5jbGVhcihuYW1lKSApXG4gIH1cblxuICAvKiogY2xlYXJzIEdFVCBjYWNoZSAqL1xuICBjbGVhckNhY2hlKG5hbWUpe1xuICAgIHJldHVybiB0aGlzLkFja0NhY2hlLmNsZWFyKG5hbWUpXG4gIH1cblxuICAvKiogbWV0aG9kIGFsbCByZXF1ZXN0IHRyYW5zYWN0aW9ucyB0dW5uZWwgdGhydSB0byBpbnN0ZWFkIHRyeSBmb3IgY2FjaGUgZmlyc3RcbiAgICBISU5UOiBAY29uZmlnLm9mZmxpbmVNb2RlbCwgd2hlbiBkZWZpbmVkOlxuICAgICAgLSBQT1NUL1BVVC9QQVRDSCByZXF1ZXN0cyBnb3RvIHF1ZSBpZiB0aGV5IGZhaWwuXG4gICAgICAtIEdFVCByZXNwb25zZXMgYXJlIGNhY2hlZCB3aXRoIG9wdGlvbmFsIGV4cGlyZXMgb3IgbWF4QWdlIG9wdGlvblxuICAqL1xuICByZXF1ZXN0KFxuICAgIGNvbmZpZzpodHRwT3B0aW9uc1xuICApOlByb21pc2U8SHR0cFJlcXVlc3Q8SHR0cEV2ZW50PEV2ZW50Pj58YW55PntcbiAgICBjb25zdCBkZWZhdWx0czpodHRwT3B0aW9ucyA9IHsgLi4udGhpcy5jb25maWcuJGh0dHAgfVxuXG4gICAgZGVmYXVsdHMuaGVhZGVycyA9IHsgLi4udGhpcy5jb25maWcuJGh0dHAuaGVhZGVycyB9Ly9jYXVzZSBhIGRlZXBlciBjbG9uZSBhbmQgYnJlYWsgbWVtb3J5IHJlZiB3aXRoIGFwaUNvbmZpZy4kaHR0cFxuXG4gICAgY29uc3QgcmVxdWVzdCA9IE9iamVjdC5hc3NpZ24oZGVmYXVsdHMsIChjb25maWd8fHt9KSlcbiAgICByZXF1ZXN0LnVybCA9IHRoaXMuY29uZmlnLmJhc2VVcmwgKyByZXF1ZXN0LnVybFxuXG4gICAgLy9yZW1vdmVkIDExLzE2LzIwMTdcbiAgICAvL09iamVjdC5hc3NpZ24ocmVxdWVzdC5oZWFkZXJzLCB0aGlzLmNvbmZpZy4kaHR0cC5oZWFkZXJzKS8vZW5mb3JjZWQgY29uZmlnL2RlZmF1bHRzIC4gYXBpQ29uZmlnIGFjdCBhcyBhbiBvdmVyd3JpdGVyIG9mIGhlYWRlcnNcblxuICAgIC8vaGFzIGNhY2hlIGluc3RydWN0aW9ucz9cbiAgICBpZiggcmVxdWVzdC5vZmZsaW5lTW9kZWwgKXtcbiAgICAgIHJldHVybiB0aGlzLnJlcXVlc3RPZmZsaW5lTW9kZWwocmVxdWVzdClcbiAgICB9XG5cbiAgICByZXR1cm4gdGhpcy5fZmV0Y2gocmVxdWVzdClcbiAgfVxuXG4gIGdldENhY2hlQnlOYW1lZFJlcXVlc3QoXG4gICAgcmVxdWVzdDpodHRwT3B0aW9uc1xuICApOlByb21pc2U8YW55PntcbiAgICBjb25zdCBvZmZsaW5lTW9kZWwgPSA8Y2FjaGVNb2RlbD5yZXF1ZXN0Lm9mZmxpbmVNb2RlbFxuICAgIHJldHVybiB0aGlzLkFja0NhY2hlLmdldChvZmZsaW5lTW9kZWwubmFtZSwgb2ZmbGluZU1vZGVsKVxuICAgIC50aGVuKHJvdXRlcz0+e1xuICAgICAgcm91dGVzID0gcm91dGVzIHx8IHt9XG4gICAgICBjb25zdCBjYWNoZU5hbWUgPSB0aGlzLmdldFN0b3JhZ2VOYW1lQnlSZXF1ZXN0KHJlcXVlc3QpXG4gICAgICByZXR1cm4gcm91dGVzWyBjYWNoZU5hbWUgXS8vZ2V0IGNhY2hlIGJ5IHVybFxuICAgIH0pXG4gICAgLnRoZW4oY2FjaGU9PnRoaXMucHJvY2Vzc0NhY2hlR2V0KGNhY2hlLHJlcXVlc3QpKVxuICB9XG5cbiAgZ2V0U3RvcmFnZU5hbWVCeVJlcXVlc3QoXG4gICAgcmVxdWVzdDpodHRwT3B0aW9uc1xuICApOnN0cmluZ3tcbiAgICBpZiggcmVxdWVzdC5wYXJhbXMgKXtcbiAgICAgIGNvbnN0IHBhcmFtS2V5cyA9IE9iamVjdC5rZXlzKHJlcXVlc3QucGFyYW1zKVxuXG4gICAgICBpZighcGFyYW1LZXlzLmxlbmd0aClyZXR1cm4gcmVxdWVzdC51cmxcbiAgICAgIFxuICAgICAgbGV0IHVybCA9IHJlcXVlc3QudXJsICsgKHJlcXVlc3QudXJsLnNlYXJjaCgvXFw/Lyk+PTAgPyBcIiZcIiA6IFwiP1wiKVxuICAgICAgcGFyYW1LZXlzLnNvcnQoKS5mb3JFYWNoKG5hbWU9PnVybCs9bmFtZStcIj1cIityZXF1ZXN0LnBhcmFtc1tuYW1lXStcIiZcIilcblxuICAgICAgcmV0dXJuIHVybC5zdWJzdHJpbmcoMCwgdXJsLmxlbmd0aC0xKS8vcmVtb3ZlIGxhc3QgYW1wXG4gICAgfVxuXG4gICAgcmV0dXJuIHJlcXVlc3QudXJsXG4gIH1cblxuICByZXF1ZXN0T2ZmbGluZU1vZGVsKFxuICAgIHJlcXVlc3Q6aHR0cE9wdGlvbnNcbiAgKTpQcm9taXNlPEh0dHBSZXNwb25zZTxIdHRwRXZlbnQ8RXZlbnQ+Pj57XG4gICAgbGV0IG9mZmxpbmVNb2RlbCA9IDxjYWNoZU1vZGVsPnJlcXVlc3Qub2ZmbGluZU1vZGVsXG4gICAgXG4gICAgaWYob2ZmbGluZU1vZGVsICYmIG9mZmxpbmVNb2RlbC5jb25zdHJ1Y3Rvcj09U3RyaW5nKXtcbiAgICAgIHJlcXVlc3Qub2ZmbGluZU1vZGVsID0gb2ZmbGluZU1vZGVsID0gPGNhY2hlTW9kZWw+eyBuYW1lOnJlcXVlc3Qub2ZmbGluZU1vZGVsIH1cbiAgICB9XG5cbiAgICBpZiAocmVxdWVzdC5tZXRob2QgPT09IFwiR0VUXCIpIHtcbiAgICAgIHJldHVybiB0aGlzLmdldENhY2hlQnlOYW1lZFJlcXVlc3QocmVxdWVzdClcbiAgICB9XG5cbiAgICB0aGlzLkFja1F1ZS5wYXJhbUhhbmRsZXIob2ZmbGluZU1vZGVsLm5hbWUsY29uZmlnPT50aGlzLl9mZXRjaChjb25maWcpKVxuXG4gICAgLy9yZXF1ZXN0IGlzIGEgUFVULCBQT1NULCBQQVRDSCwgb3IgREVMRVRFXG4gICAgcmV0dXJuIHRoaXMuX2ZldGNoKHJlcXVlc3QpXG4gICAgLmNhdGNoKCBlPT50aGlzLnBvc3RSZXF1ZXN0RmFpbChlLHJlcXVlc3QpICkvL2lmIGZhaWwsIHNhdmUgY29uZmlnIGZvciBsYXRlclxuICB9XG5cbiAgcHJvY2Vzc0NhY2hlR2V0KFxuICAgIGNhY2hlOmFueSxcbiAgICBjZmc6aHR0cE9wdGlvbnNcbiAgKTpQcm9taXNlPEh0dHBSZXNwb25zZTxIdHRwRXZlbnQ8RXZlbnQ+Pj57XG4gICAgaWYoY2FjaGU9PW51bGwpcmV0dXJuIHRoaXMuX2ZldGNoKGNmZylcblxuICAgIGNvbnN0IG9mZmxpbmVNb2RlbCA9IDxjYWNoZU1vZGVsPmNmZy5vZmZsaW5lTW9kZWxcbiAgICBcbiAgICByZXR1cm4gdGhpcy5BY2tDYWNoZS5jYWNoZVRvUmV0dXJuKG9mZmxpbmVNb2RlbC5uYW1lLCBjYWNoZSwgb2ZmbGluZU1vZGVsKVxuICAgIC50aGVuKHJ0bj0+e1xuICAgICAgY29uc3Qgd2lsbEV4cGlyZSA9IHRoaXMuQWNrQ2FjaGUub3B0aW9uc0tpbGxDYWNoZSggb2ZmbGluZU1vZGVsIClcblxuICAgICAgaWYoIHJ0biAmJiAhd2lsbEV4cGlyZSApe1xuICAgICAgICBjb25zb2xlLmxvZyhcIkFja0FwaSBmZXRjaGVkIGNhY2hlIHRoYXQgd2lsbCBuZXZlciBleHBpcmUuIFNldCBvZmZsaW5lTW9kZWwuZXhwaXJlcz0wIG9yIG9mZmxpbmVNb2RlbC5tYXhBZ2U9MCB0byBhdm9pZCB0aGlzIG1lc3NhZ2VcIiwgcnRuKVxuICAgICAgfVxuXG4gICAgICBpZiggcnRuIT1udWxsICl7XG4gICAgICAgIHJldHVybiBydG5cbiAgICAgIH1cblxuICAgICAgcmV0dXJuIHRoaXMuX2ZldGNoKGNmZylcbiAgICB9KVxuICB9XG5cbiAgcG9zdFJlcXVlc3RGYWlsKFxuICAgIGUsIHJlcXVlc3Q6aHR0cE9wdGlvbnNcbiAgKTpQcm9taXNlPGFueT57XG4gICAgY29uc3Qgc2F2ZVdvcnRoeSA9IGUuc3RhdHVzID09IDAgfHwgZS5zdGF0dXMgPT0gLTEgfHwgZS5zdGF0dXMgPT0gNTAzXG5cbiAgICBpZighc2F2ZVdvcnRoeSlyZXR1cm4gUHJvbWlzZS5yZWplY3QoZSlcblxuICAgIHJlcXVlc3Quc2VuZEZhaWxNZXRhID0gcmVxdWVzdC5zZW5kRmFpbE1ldGEgfHwgPHNlbmRGYWlsTWV0YT57fVxuICAgIHJlcXVlc3Quc2VuZEZhaWxNZXRhLm9mZmxpbmVJZCA9IERhdGUubm93KCkvL3RoaXMuZ2V0U3RvcmFnZU5hbWVCeVJlcXVlc3QocmVxdWVzdClcbiAgICByZXF1ZXN0LnNlbmRGYWlsTWV0YS5sYXN0QXR0ZW1wdCA9IG5ldyBEYXRlKClcbiAgICByZXF1ZXN0LnNlbmRGYWlsTWV0YS5hdHRlbXB0cyA9IHJlcXVlc3Quc2VuZEZhaWxNZXRhLmF0dGVtcHRzPT1udWxsID8gMSA6ICsrcmVxdWVzdC5zZW5kRmFpbE1ldGEuYXR0ZW1wdHNcbiAgICByZXF1ZXN0LnNlbmRGYWlsTWV0YS5tYXhUcnkgPSByZXF1ZXN0LnNlbmRGYWlsTWV0YS5tYXhUcnkgfHwgNTBcbiAgICBjb25zdCB0cnlBZ2FpbkxhdGVyID0gcmVxdWVzdC5zZW5kRmFpbE1ldGEubWF4VHJ5ICYmIHJlcXVlc3Quc2VuZEZhaWxNZXRhLmF0dGVtcHRzIDw9IHJlcXVlc3Quc2VuZEZhaWxNZXRhLm1heFRyeVxuXG4gICAgZS5zZW5kRmFpbE1ldGEgPSByZXF1ZXN0LnNlbmRGYWlsTWV0YVxuXG4gICAgaWYodHJ5QWdhaW5MYXRlcil7XG4gICAgICBjb25zdCByZXF1ZXN0U2F2ZSA9IE9iamVjdC5hc3NpZ24oe30sIHJlcXVlc3QpXG4gICAgICBkZWxldGUgcmVxdWVzdFNhdmUub2ZmbGluZU1vZGVsLy9vbmx5IHVzZWQgZm9yIEdFVCBtZXRob2RcbiAgICAgIGNvbnN0IG9mZmxpbmVNb2RlbCA9IDxjYWNoZU1vZGVsPnJlcXVlc3Qub2ZmbGluZU1vZGVsXG4gICAgICByZXR1cm4gdGhpcy5BY2tRdWUuc2V0KG9mZmxpbmVNb2RlbC5uYW1lLCByZXF1ZXN0U2F2ZSlcbiAgICAgIC50aGVuKCAoKT0+UHJvbWlzZS5yZWplY3QoZSkgKVxuICAgIH1cblxuICAgIHJldHVybiBQcm9taXNlLnJlamVjdChlKVxuICB9XG5cbiAgLyoqIG1hc3RlciBtZXRob2QgZm9yIHNlbmRpbmcgcmVxdWVzdHMgYW5kIGNhY2hpbmcgcmVzcG9uc2VzIHVzaW5nICRodHRwIHJlcXVlc3RzXG4gICAgQGNmZ3tcbiAgICAgIGNhdGNoOlwiZGF0YVwiLy90eXBpY2FsbHkgb25seSBlcnJvciBkYXRhIGlzIHJldHVybmVkLCBidXQgaWYgY2F0Y2ghPVwiZGF0YVwiIHRoZW4gZW50aXJlIHJlc3BvbnNlIGlzIHJldHVybmVkIGZvciBhIGNhdWdodCBlcnJvclxuICAgICAgcHJvbWlzZTpcImRhdGFcIi8vdHlwaWNhbGx5IG9ubHkgZGF0YSBpcyByZXR1cm5lZCwgYnV0IGlmIHByb21pc2UhPVwiZGF0YVwiIHRoZW4gZW50aXJlIHJlc3BvbnNlIGlzIHJldHVybmVkXG4gICAgICBoZWFkZXJzOnt9Ly93aGVuIHNlbmRpbmcgYSBmaWxlIFwiQ29udGVudC1UeXBlXCI6dW5kZWZpbmVkIHNvIHRoYXQgbm8gY29udGVudC10eXBlIGhlYWRlciBpcyBzZW50XG4gICAgfVxuICAqL1xuICBfZmV0Y2goXG4gICAgY2ZnOmh0dHBPcHRpb25zXG4gICk6UHJvbWlzZTxIdHRwUmVzcG9uc2U8SHR0cEV2ZW50PEV2ZW50Pj4+IHtcbiAgICB1cGdyYWRlQ29uZmlnKGNmZylcblxuICAgIGNvbnN0IGNmZ1BsdXMgPSB7Li4uY2ZnfVxuXG4gICAgaWYoIGNmZy5wYXJhbXMgKXtcbiAgICAgIGNmZ1BsdXMucGFyYW1zID0gbmV3IEh0dHBQYXJhbXMoe1xuICAgICAgICBmcm9tT2JqZWN0OmNmZy5wYXJhbXNcbiAgICAgIH0pXG4gICAgfVxuXG4gICAgaWYoIGNmZy5oZWFkZXJzICl7XG4gICAgICBjZmdQbHVzLmhlYWRlcnMgPSBuZXcgSHR0cEhlYWRlcnMoIGNmZy5oZWFkZXJzIClcbiAgICB9XG5cbiAgICBjb25zdCByZXF1ZXN0ID0gbmV3IEh0dHBSZXF1ZXN0KFxuICAgICAgY2ZnLm1ldGhvZCxcbiAgICAgIGNmZy51cmwsXG4gICAgICBjZmcuYm9keSxcbiAgICAgIGNmZ1BsdXNcbiAgICApXG5cbiAgICBjb25zdCBwcm9taXNlID0gKHJlc29sdmUscmVqZWN0KT0+e1xuICAgICAgbGV0IHJlc29sdmVkID0gZmFsc2VcbiAgICAgIHRoaXMuUmVxdWVzdC5lbWl0KCByZXF1ZXN0IClcbiAgICAgIFxuICAgICAgY29uc3QgcmVxID0gdGhpcy5IdHRwQ2xpZW50LnJlcXVlc3QoIHJlcXVlc3QgKVxuICAgICAgLnN1YnNjcmliZShldmVudD0+e1xuICAgICAgICBpZiAoZXZlbnQudHlwZSA9PT0gSHR0cEV2ZW50VHlwZS5SZXNwb25zZSkge1xuICAgICAgICAgIHJlc29sdmVkID0gdHJ1ZVxuICAgICAgICAgIHJlc29sdmUoIGV2ZW50IClcbiAgICAgICAgfVxuICAgICAgfSxlcnI9PntcbiAgICAgICAgcmVzb2x2ZWQ9dHJ1ZVxuICAgICAgICByZWplY3QoZXJyKVxuICAgICAgfSlcblxuICAgICAgaWYoIGNmZy50aW1lb3V0ICl7XG4gICAgICAgIHNldFRpbWVvdXQoKCk9PntcbiAgICAgICAgICBpZihyZXNvbHZlZClyZXR1cm5cbiAgICAgICAgICByZXEudW5zdWJzY3JpYmUoKVxuICAgICAgICAgIGNvbnN0IHRpbWVvdXRFcnJvciA9IG5ldyBUaW1lT3V0RXJyb3IoKVxuICAgICAgICAgIE9iamVjdC5hc3NpZ24odGltZW91dEVycm9yLHJlcXVlc3QpXG4gICAgICAgICAgdGltZW91dEVycm9yLnRpbWVvdXQgPSBjZmcudGltZW91dFxuICAgICAgICAgIHJlamVjdCggdGltZW91dEVycm9yIClcbiAgICAgICAgfSwgY2ZnLnRpbWVvdXQpXG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKHByb21pc2UpXG4gICAgLnRoZW4oKHJlc3BvbnNlOkh0dHBSZXNwb25zZTxIdHRwRXZlbnQ8RXZlbnQ+Pik9PlxuICAgICAgdGhpcy5wcm9jZXNzRmV0Y2hCeUNvbmZpZyhyZXNwb25zZSxjZmcpXG4gICAgIClcbiAgICAuY2F0Y2goIGU9PnRoaXMuaHR0cEZhaWxCeUNvbmZpZyhlLGNmZykgKVxuICB9XG5cbiAgLyoqIE9uY2UgYSByZXF1ZXN0IGlzIHN1Y2Nlc3NmdWwsIHRoaXMgaXMgdGhlIHByaW1hcnkgcHJvY2Vzc29yICovXG4gIHByb2Nlc3NGZXRjaEJ5Q29uZmlnKFxuICAgIHJlc3BvbnNlOkh0dHBSZXNwb25zZTxIdHRwRXZlbnQ8RXZlbnQ+PixcbiAgICByZXF1ZXN0Omh0dHBPcHRpb25zXG4gICk6UHJvbWlzZTxIdHRwUmVzcG9uc2U8SHR0cEV2ZW50PEV2ZW50Pj4+e1xuICAgIHRoaXMucmVzcG9uc2UuZW1pdChyZXNwb25zZSkvL2xldCBzdWJzY3JpYmVycyBvZiBhbGwgcmVzcG9uc2VzIGtub3cgd2UgZ290IG9uZVxuICAgIFxuICAgIGNvbnN0IGRhdGEgPSByZXNwb25zZS5ib2R5IHx8IHJlc3BvbnNlW1wiX2JvZHlcIl0vL0FuZ3VsYXI1LmJvZHkgb3IgQW5ndWxhcjQuX2JvZHlcbiAgICBjb25zdCBpc0pzb24gPSBkYXRhICYmIHJlc3BvbnNlLmhlYWRlcnMuZ2V0KFwiQ29udGVudC1UeXBlXCIpPT1cImFwcGxpY2F0aW9uL2pzb25cIlxuXG4gICAgaWYoaXNKc29uICYmICFyZXNwb25zZVtcImRhdGFcIl0pe1xuICAgICAgdHJ5e1xuICAgICAgICByZXNwb25zZVtcImRhdGFcIl0gPSBKU09OLnBhcnNlKCBkYXRhIClcbiAgICAgIH1jYXRjaChlKXt9XG4gICAgfVxuXG4gICAgcmVzcG9uc2VbXCJkYXRhXCJdID0gZGF0YS8vU2luY2UgYW5ndWxhckpzIGJhY2t3b3JkcyBjb21wYXQgYW5kIGxlYXZlcyBvcmlnaW5hbCBib2R5IHN0cmluZyBhbG9uZVxuICAgIGNvbnN0IGlzRGF0YU1vZGUgPSAhcmVxdWVzdC5wcm9taXNlIHx8IHJlcXVlc3QucHJvbWlzZT09XCJkYXRhXCJcbiAgICBjb25zdCBvdXRwdXQgPSBpc0RhdGFNb2RlID8gZGF0YSA6IHJlc3BvbnNlXG4gICAgY29uc3QgaXNDYWNoZVJlcG9uc2UgPSByZXF1ZXN0Lm1ldGhvZCA9PT0gXCJHRVRcIiAmJiByZXF1ZXN0Lm9mZmxpbmVNb2RlbFxuXG4gICAgaWYgKCBpc0NhY2hlUmVwb25zZSApIHtcbiAgICAgIHJldHVybiB0aGlzLnJlcXVlc3RSZXNwb25zZVRvQ2FjaGUocmVxdWVzdCwgb3V0cHV0KVxuICAgICAgLnRoZW4oICgpPT5vdXRwdXQgKVxuICAgIH1cblxuICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoIG91dHB1dCApXG4gIH1cblxuICBodHRwRmFpbEJ5Q29uZmlnKGU6RXJyb3IsIGNmZzpodHRwT3B0aW9ucyl7XG4gICAgY29uc3QgaXNSZWR1Y2VEYXRhID0gY2ZnLmNhdGNoPT1udWxsIHx8IGNmZy5jYXRjaD09XCJkYXRhXCJcbiAgICBjb25zdCBkYXRhID0gZVtcImRhdGFcIl1cbiAgICBjb25zdCBpc0NhdGNoRGF0YSA9IGlzUmVkdWNlRGF0YSAmJiBkYXRhICYmIGRhdGEuZXJyb3JcblxuICAgIC8vZmluZCBKU09OIGVycm9yIG9iamVjdCBhbmQgcmVkdWNlIHRvXG4gICAgaWYoaXNDYXRjaERhdGEpe1xuICAgICAgY29uc3QgbmV3RXJyb3IgPSBuZXcgRXJyb3IoKVxuICAgICAgT2JqZWN0LmFzc2lnbihuZXdFcnJvciwgZVtcImRhdGFcIl0uZXJyb3IpXG4gICAgICBlID0gbmV3RXJyb3JcbiAgICB9XG5cbiAgICBlW1wibWV0aG9kXCJdID0gZVtcIm1ldGhvZFwiXSB8fCBjZmcubWV0aG9kXG5cbiAgICBpZiggZVtcInN0YXR1c1wiXT09NDAxICl7XG4gICAgICB0aGlzLkF1dGhFcnJvci5lbWl0KGUpXG4gICAgfWVsc2V7XG4gICAgICB0aGlzLkFwaUVycm9yLmVtaXQoZSlcbiAgICB9XG5cbiAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QoZSlcbiAgfVxuXG4gIHJlcXVlc3RSZXNwb25zZVRvQ2FjaGUoXG4gICAgcmVxdWVzdCwgb3V0cHV0XG4gICk6UHJvbWlzZTxhbnk+e1xuICAgIGNvbnN0IGNhY2hlbmFtZSA9IHJlcXVlc3Qub2ZmbGluZU1vZGVsLm5hbWUgfHwgcmVxdWVzdC5vZmZsaW5lTW9kZWxcbiAgICByZXR1cm4gdGhpcy5BY2tDYWNoZS5nZXQoY2FjaGVuYW1lKVxuICAgIC50aGVuKHJvdXRlcz0+e1xuICAgICAgcm91dGVzID0gcm91dGVzIHx8IHt9XG4gICAgICBjb25zdCBjYWNoZU5hbWUgPSB0aGlzLmdldFN0b3JhZ2VOYW1lQnlSZXF1ZXN0KHJlcXVlc3QpXG4gICAgICByb3V0ZXNbIGNhY2hlTmFtZSBdID0gPGNhY2hlTW9kZWw+e2NhY2hlOm91dHB1dH1cbiAgICAgIHRoaXMuQWNrQ2FjaGUuZGF0YU9wdGlvbnNDYWNoZShyb3V0ZXNbIHJlcXVlc3QudXJsIF0sIHJlcXVlc3Qub2ZmbGluZU1vZGVsLCBvdXRwdXQpXG4gICAgICByZXR1cm4gcm91dGVzXG4gICAgfSlcbiAgICAudGhlbihyb3V0ZXM9PnRoaXMuQWNrQ2FjaGUuc2V0KGNhY2hlbmFtZSwgcm91dGVzKSlcbiAgfVxuICBcbiAgZ2V0KFxuICAgIHBhdGg6c3RyaW5nLFxuICAgIGNvbmZpZz86aHR0cE9wdGlvbnNcbiAgKTpQcm9taXNlPEh0dHBSZXNwb25zZTxIdHRwRXZlbnQ8RXZlbnQ+Pnxhbnk+e1xuICAgIGNvbnN0IGNmZyA9IE9iamVjdC5hc3NpZ24oe30sIGNvbmZpZylcbiAgICBjZmcubWV0aG9kID0gXCJHRVRcIlxuICAgIGNmZy51cmwgPSBwYXRoXG4gICAgcmV0dXJuIHRoaXMucmVxdWVzdCggY2ZnIClcbiAgfVxuXG4gIHBvc3QoXG4gICAgcGF0aDpzdHJpbmcsXG4gICAgZGF0YTphbnksXG4gICAgY29uZmlnPzpodHRwT3B0aW9uc1xuICApOlByb21pc2U8SHR0cFJlc3BvbnNlPEh0dHBFdmVudDxFdmVudD4+fGFueT57XG4gICAgY29uc3QgY2ZnID0gT2JqZWN0LmFzc2lnbih7fSwgY29uZmlnKVxuICAgIGNmZy5tZXRob2QgPSBcIlBPU1RcIlxuICAgIC8vY2ZnLmRhdGEgPSBkYXRhXG4gICAgY2ZnLmJvZHkgPSBkYXRhXG4gICAgY2ZnLnVybCA9IHBhdGhcbiAgICByZXR1cm4gdGhpcy5yZXF1ZXN0KCBjZmcgKVxuICB9XG5cbiAgZGVsZXRlKFxuICAgIHBhdGg6c3RyaW5nLCBjb25maWc/Omh0dHBPcHRpb25zXG4gICk6UHJvbWlzZTxIdHRwUmVzcG9uc2U8SHR0cEV2ZW50PEV2ZW50Pj58YW55PntcbiAgICBjb25zdCBjZmcgPSBPYmplY3QuYXNzaWduKHt9LCBjb25maWcpXG4gICAgY2ZnLm1ldGhvZCA9IFwiREVMRVRFXCJcbiAgICBjZmcudXJsID0gcGF0aFxuICAgIHJldHVybiB0aGlzLnJlcXVlc3QoIGNmZyApXG4gIH1cblxuICBwdXQoXG4gICAgcGF0aCwgZGF0YSwgY29uZmlnP1xuICApOlByb21pc2U8SHR0cFJlc3BvbnNlPEh0dHBFdmVudDxFdmVudD4+fGFueT57XG4gICAgY29uc3QgY2ZnID0gT2JqZWN0LmFzc2lnbih7fSwgY29uZmlnKVxuICAgIGNmZy5tZXRob2QgPSBcIlBVVFwiXG4gICAgLy9jZmcuZGF0YSA9IGRhdGFcbiAgICBjZmcuYm9keSA9IGRhdGFcbiAgICBjZmcudXJsID0gcGF0aFxuICAgIHJldHVybiB0aGlzLnJlcXVlc3QoIGNmZyApXG4gIH1cblxuICAvKiogYWxsIHByb2Nlc3MgcXVlcyB3aXRoIGJlIHJ1biB3aXRoIG5hdmlnYXRvci5vbkxpbmUgKi9cbiAgLyptb25pdG9yT25saW5lU3RhdHVzKCl7XG4gICAgY29uc3Qgb25PbmxpbmUgPSAoKT0+e1xuICAgICAgdGhpcy5BY2tRdWUucHJvY2Vzc0FsbFF1ZXMoKVxuICAgIH1cblxuICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKFwib25saW5lXCIsIG9uT25saW5lKVxuICB9Ki9cbn1cblxuLyoqIHByZXZlbnQgYW5ndWxhcjEgZnJvbSBhc3N1bWluZyB0aGUgaGVhZGVyIHRvIHNlbmQgaXMgYXBwbGljYXRpb24vanNvbiAqL1xuZnVuY3Rpb24gdXBncmFkZUNvbmZpZyhcbiAgY2ZnOmh0dHBPcHRpb25zXG4pOmh0dHBPcHRpb25ze1xuICBjZmcubWV0aG9kID0gY2ZnLm1ldGhvZCB8fCBcIkdFVFwiXG5cbiAgY2ZnLnJlcG9ydFByb2dyZXNzID0gY2ZnLnJlcG9ydFByb2dyZXNzIHx8IGZhbHNlXG5cbiAgLy9BIHRyaWNrIGZyb20gQW5ndWxhckpzIHRvIHByZXZlbnQgaGVhZGVyIGF1dG8gcG9wdWxhdGlvblxuICAvKmNvbnN0IGlzRm9ybURhdGEgPSBjZmcuYm9keSAmJiBGb3JtRGF0YSAmJiBjZmcuYm9keS5jb25zdHJ1Y3Rvcj09Rm9ybURhdGFcbiAgaWYoaXNGb3JtRGF0YSl7XG4gICAgY29uc3QgcHJldmVudEF1dG9Db250ZW50VHlwZSA9ICAhY2ZnLmhlYWRlcnMgfHwgT2JqZWN0LmtleXMoY2ZnLmhlYWRlcnMpLmZpbHRlcihoPT5oLnNlYXJjaCgvY29udGVudC10eXBlL2kpPDApXG4gICAgXG4gICAgaWYocHJldmVudEF1dG9Db250ZW50VHlwZSl7XG4gICAgICBjZmcuaGVhZGVyc1tcIkNvbnRlbnQtVHlwZVwiXSA9IHVuZGVmaW5lZC8vXCJtdWx0aXBhcnQvZm9ybS1kYXRhO1wiXG4gICAgfVxuICB9Ki9cblxuICAvL2Nhc3QgdXJsIHZhcmlhYmxlcyBudWxscyB0byBlbXB0eS1zdHJpbmdcbiAgaWYoIGNmZy5wYXJhbXMgKXtcbiAgICBmb3IobGV0IGtleSBpbiBjZmcucGFyYW1zKXtcbiAgICAgIGlmKCBjZmcucGFyYW1zW2tleV09PW51bGwgKXtcbiAgICAgICAgY2ZnLnBhcmFtc1trZXldPVwiXCJcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICByZXR1cm4gY2ZnXG59Il19