//import { StateService,TransitionService,Transition } from "ui-router-ng2";
import { Router, NavigationEnd, ActivatedRoute } from '@angular/router';
import { Injectable } from '@angular/core';
/** A stateful connection to ui-router history
 - .stateChange() with arguments MUST be called at every state change
 - Has 99% accuracy of knowing if OS back or forward button has been used
   - Their is no web event for knowing if OS button is used.
*/
export class RouteWatchReporter {
    constructor(router, activatedRoute) {
        this.router = router;
        this.activatedRoute = activatedRoute;
        this.current = {};
        this.$history = [];
        //$window  : any
        this.historyPos = 0;
        this.isBackMode = false;
        this.isOsAction = false;
        this.isNextBackMode = false;
        this.isNextBackHistory = false;
        this.activatedRoute = activatedRoute;
        router.events.subscribe(event => {
            if (event.constructor == NavigationEnd) {
                //const params = {}//COMING REALLY SOON
                const current = this.getCurrent();
                this.recordStateChange(current.config, current.params);
            }
        });
        this.current = this.getCurrent();
    }
    $window() {
        return window;
    }
    getCurrent() {
        return getCurrentByActive(this.activatedRoute);
    }
    getCurrentConfig() {
        let target = this.activatedRoute;
        while (target.firstChild)
            target = target.firstChild;
        return (target.routeConfig || target["config"] || target);
    }
    getCurrentParams() {
        let target = this.activatedRoute;
        while (target.firstChild)
            target = target.firstChild;
        return target.snapshot.params;
    }
    isTrapHistory(toState, toParams) {
        return this.isBackHistory(toState, toParams) && this.isForwardHistory(toState, toParams);
    }
    isBackHistory(toState, toParams) {
        const $history = this.$history;
        const isEven = $history.length > this.historyPos + 1;
        const isNameMatch = isEven && toState && toState.name == $history[this.historyPos + 1].name;
        return isNameMatch && this.isParamsMatch(toParams, $history[this.historyPos + 1].params);
    }
    isForwardHistory(toState, toParams) {
        const $history = this.$history;
        const isEven = !this.isNextBackMode && this.historyPos && $history.length > this.historyPos;
        const isNameMatch = isEven && toState && toState.name == $history[this.historyPos - 1].name;
        return isNameMatch && this.isParamsMatch(toParams, $history[this.historyPos - 1].params);
    }
    isParamsMatch(toParams, otherParams) {
        if (!toParams || !otherParams) {
            return false;
        }
        for (let x in toParams) {
            if (toParams[x] != otherParams[x]) {
                return false;
            }
        }
        return true;
    }
    recordStateChange(toState, toParams) {
        this.current = { params: toParams, config: toState };
        let isForward = this.isForwardHistory(toState, toParams);
        let isBackHistory = this.isNextBackHistory || this.isBackHistory(toState, toParams);
        if (this.isOsAction && this.isTrapHistory(toState, toParams)) {
            if (this.isBackMode) {
                isForward = false;
            }
            else {
                isBackHistory = false;
            }
        }
        else {
            this.isBackMode = this.isNextBackMode || (this.isOsAction && isBackHistory);
        }
        const $history = this.$history;
        if (!toState)
            return;
        if (isForward) {
            --this.historyPos;
        }
        else if (this.isBackMode) {
            ++this.historyPos;
        }
        else {
            //const $state = this.$state()
            this.historyPos = 0;
            const hist = { name: toState.name, params: toParams };
            if (!Object.keys(toParams).length) {
                delete hist.params;
            }
            $history.unshift(hist);
        }
        this.isNextBackHistory = false;
    }
    goBackTo(name, params) {
        this.isNextBackMode = true;
        this.isNextBackHistory = true;
        this.$state().go(name, params);
    }
    tryBack(name, params) {
        if (this.$history.length) {
            this.isNextBackMode = true;
            this.isNextBackHistory = true;
            this.$window().history.back();
        }
        else {
            this.goBackTo(name, params);
        }
    }
    watchDocument($document) {
        this.watchDocByCallbacks($document, this.getDocumentCallbacks());
    }
    getDocumentCallbacks() {
        const isBackButton = () => {
            this.isOsAction = true;
        };
        const isNotBackButton = () => {
            this.isOsAction = false;
        };
        return {
            isBackButton: isBackButton,
            isNotBackButton: isNotBackButton
        };
    }
    watchDocByCallbacks($document, callbacks) {
        $document.addEventListener('mouseout', callbacks.isBackButton);
        //$document.addEventListener('mouseover', callbacks.mouseover)
        $document.addEventListener('mousedown', callbacks.isNotBackButton);
    }
    unwatchDocByCallbacks($document, callbacks) {
        $document.removeEventListener('mouseout', callbacks.isBackButton);
        $document.removeEventListener('mouseover', callbacks.isNotBackButton);
        $document.removeEventListener('mousedown', callbacks.isNotBackButton);
    }
}
RouteWatchReporter.decorators = [
    { type: Injectable }
];
RouteWatchReporter.ctorParameters = () => [
    { type: Router },
    { type: ActivatedRoute }
];
export function getCurrentByActive(ActivatedRoute) {
    let parent = ActivatedRoute;
    let target = ActivatedRoute;
    while (target.firstChild) {
        parent = target;
        target = target.firstChild;
    }
    const snapshot = target.snapshot || {};
    const parentSnap = parent.snapshot || {};
    return {
        ActivatedRoute: target,
        config: (target.routeConfig || target["config"] || target),
        params: snapshot.params,
        parent: {
            ActivatedRoute: parent,
            config: (parent.routeConfig || target["config"] || parent),
            params: parentSnap.params
        }
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiUm91dGVXYXRjaFJlcG9ydGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vc3JjL21vZHVsZXMvcm91dGVyL1JvdXRlV2F0Y2hSZXBvcnRlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSw0RUFBNEU7QUFDNUUsT0FBTyxFQUNFLE1BQU0sRUFBRSxhQUFhLEVBQzVCLGNBQWMsRUFDZixNQUFNLGlCQUFpQixDQUFDO0FBQ3pCLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFTM0M7Ozs7RUFJRTtBQUNZLE1BQU0sT0FBTyxrQkFBa0I7SUFZM0MsWUFDUyxNQUFhLEVBQ2IsY0FBNkI7UUFEN0IsV0FBTSxHQUFOLE1BQU0sQ0FBTztRQUNiLG1CQUFjLEdBQWQsY0FBYyxDQUFlO1FBYnRDLFlBQU8sR0FBVSxFQUFFLENBQUE7UUFDbkIsYUFBUSxHQUFTLEVBQUUsQ0FBQTtRQUVuQixnQkFBZ0I7UUFFaEIsZUFBVSxHQUFZLENBQUMsQ0FBQTtRQUN2QixlQUFVLEdBQWEsS0FBSyxDQUFBO1FBQzVCLGVBQVUsR0FBYSxLQUFLLENBQUE7UUFDNUIsbUJBQWMsR0FBYSxLQUFLLENBQUE7UUFDaEMsc0JBQWlCLEdBQWEsS0FBSyxDQUFBO1FBTWpDLElBQUksQ0FBQyxjQUFjLEdBQUcsY0FBYyxDQUFBO1FBRXBDLE1BQU0sQ0FBQyxNQUFNLENBQUMsU0FBUyxDQUFDLEtBQUssQ0FBQSxFQUFFO1lBQzdCLElBQUcsS0FBSyxDQUFDLFdBQVcsSUFBRSxhQUFhLEVBQUM7Z0JBQ2xDLHVDQUF1QztnQkFDdkMsTUFBTSxPQUFPLEdBQUcsSUFBSSxDQUFDLFVBQVUsRUFBRSxDQUFBO2dCQUNqQyxJQUFJLENBQUMsaUJBQWlCLENBQ3BCLE9BQU8sQ0FBQyxNQUFNLEVBQ2QsT0FBTyxDQUFDLE1BQU0sQ0FDZCxDQUFBO2FBQ0g7UUFDSCxDQUFDLENBQUMsQ0FBQTtRQUVGLElBQUksQ0FBQyxPQUFPLEdBQUcsSUFBSSxD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QixNQUFNLEVBQVEsQ0FBQyxNQUFNLENBQUMsV0FBVyxJQUFJLE1BQU0sQ0FBQyxRQUFRLENBQUMsSUFBSSxNQUFNLENBQUM7WUFDaEUsTUFBTSxFQUFDLFVBQVUsQ0FBQyxNQUFNO1NBQ3pCO0tBQ0YsQ0FBQTtBQUNILENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvL2ltcG9ydCB7IFN0YXRlU2VydmljZSxUcmFuc2l0aW9uU2VydmljZSxUcmFuc2l0aW9uIH0gZnJvbSBcInVpLXJvdXRlci1uZzJcIjtcbmltcG9ydCB7XG4gIFJvdXRlLCBSb3V0ZXIsIE5hdmlnYXRpb25FbmQsXG4gIEFjdGl2YXRlZFJvdXRlLCBBY3RpdmF0ZWRSb3V0ZVNuYXBzaG90XG59IGZyb20gJ0Bhbmd1bGFyL3JvdXRlcic7XG5pbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5cbmV4cG9ydCBpbnRlcmZhY2UgY3VycmVudFJvdXRle1xuICBBY3RpdmF0ZWRSb3V0ZSA6IEFjdGl2YXRlZFJvdXRlXG4gIGNvbmZpZyAgOiBSb3V0ZS8vfEFjdGl2YXRlZFJvdXRlXG4gIHBhcmFtcyAgOiBhbnlcbiAgcGFyZW50PyA6IGN1cnJlbnRSb3V0ZS8vfEFjdGl2YXRlZFJvdXRlXG59XG5cbi8qKiBBIHN0YXRlZnVsIGNvbm5lY3Rpb24gdG8gdWktcm91dGVyIGhpc3RvcnlcbiAtIC5zdGF0ZUNoYW5nZSgpIHdpdGggYXJndW1lbnRzIE1VU1QgYmUgY2FsbGVkIGF0IGV2ZXJ5IHN0YXRlIGNoYW5nZVxuIC0gSGFzIDk5JSBhY2N1cmFjeSBvZiBrbm93aW5nIGlmIE9TIGJhY2sgb3IgZm9yd2FyZCBidXR0b24gaGFzIGJlZW4gdXNlZFxuICAgLSBUaGVpciBpcyBubyB3ZWIgZXZlbnQgZm9yIGtub3dpbmcgaWYgT1MgYnV0dG9uIGlzIHVzZWQuIFxuKi9cbkBJbmplY3RhYmxlKCkgZXhwb3J0IGNsYXNzIFJvdXRlV2F0Y2hSZXBvcnRlcntcbiAgY3VycmVudCAgOiBhbnkgPSB7fVxuICAkaGlzdG9yeSA6IGFueSA9IFtdXG4gICRzdGF0ZSAgIDogYW55XG4gIC8vJHdpbmRvdyAgOiBhbnlcbiAgXG4gIGhpc3RvcnlQb3MgOiBudW1iZXIgPSAwXG4gIGlzQmFja01vZGUgOiBib29sZWFuID0gZmFsc2VcbiAgaXNPc0FjdGlvbiA6IGJvb2xlYW4gPSBmYWxzZVxuICBpc05leHRCYWNrTW9kZSA6IGJvb2xlYW4gPSBmYWxzZVxuICBpc05leHRCYWNrSGlzdG9yeSA6IGJvb2xlYW4gPSBmYWxzZVxuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHB1YmxpYyByb3V0ZXI6Um91dGVyLFxuICAgIHB1YmxpYyBhY3RpdmF0ZWRSb3V0ZTpBY3RpdmF0ZWRSb3V0ZVxuICApe1xuICAgIHRoaXMuYWN0aXZhdGVkUm91dGUgPSBhY3RpdmF0ZWRSb3V0ZVxuXG4gICAgcm91dGVyLmV2ZW50cy5zdWJzY3JpYmUoZXZlbnQ9PntcbiAgICAgIGlmKGV2ZW50LmNvbnN0cnVjdG9yPT1OYXZpZ2F0aW9uRW5kKXtcbiAgICAgICAgLy9jb25zdCBwYXJhbXMgPSB7fS8vQ09NSU5HIFJFQUxMWSBTT09OXG4gICAgICAgIGNvbnN0IGN1cnJlbnQgPSB0aGlzLmdldEN1cnJlbnQoKVxuICAgICAgICB0aGlzLnJlY29yZFN0YXRlQ2hhbmdlKFxuICAgICAgICAgIGN1cnJlbnQuY29uZmlnLFxuICAgICAgICAgIGN1cnJlbnQucGFyYW1zXG4gICAgICAgICApXG4gICAgICB9XG4gICAgfSlcblxuICAgIHRoaXMuY3VycmVudCA9IHRoaXMuZ2V0Q3VycmVudCgpXG4gIH1cblxuICAkd2luZG93KCl7XG4gICAgcmV0dXJuIHdpbmRvd1xuICB9XG5cbiAgZ2V0Q3VycmVudCgpOmN1cnJlbnRSb3V0ZXtcbiAgICByZXR1cm4gZ2V0Q3VycmVudEJ5QWN0aXZlKCB0aGlzLmFjdGl2YXRlZFJvdXRlIClcbiAgfVxuXG4gIGdldEN1cnJlbnRDb25maWcoKTpSb3V0ZXtcbiAgICBsZXQgdGFyZ2V0ID0gdGhpcy5hY3RpdmF0ZWRSb3V0ZVxuICAgIHdoaWxlKHRhcmdldC5maXJzdENoaWxkKXRhcmdldD10YXJnZXQuZmlyc3RDaGlsZFxuICAgIHJldHVybiA8Um91dGU+KHRhcmdldC5yb3V0ZUNvbmZpZyB8fCB0YXJnZXRbXCJjb25maWdcIl0gfHwgdGFyZ2V0KVxuICB9XG5cbiAgZ2V0Q3VycmVudFBhcmFtcygpOmFueXtcbiAgICBsZXQgdGFyZ2V0ID0gdGhpcy5hY3RpdmF0ZWRSb3V0ZVxuICAgIHdoaWxlKHRhcmdldC5maXJzdENoaWxkKXRhcmdldD10YXJnZXQuZmlyc3RDaGlsZFxuICAgIHJldHVybiB0YXJnZXQuc25hcHNob3QucGFyYW1zXG4gIH1cblxuICBpc1RyYXBIaXN0b3J5KHRvU3RhdGUsIHRvUGFyYW1zKTpib29sZWFue1xuICAgIHJldHVybiB0aGlzLmlzQmFja0hpc3RvcnkodG9TdGF0ZSwgdG9QYXJhbXMpICYmIHRoaXMuaXNGb3J3YXJkSGlzdG9yeSh0b1N0YXRlLCB0b1BhcmFtcylcbiAgfVxuXG4gIGlzQmFja0hpc3RvcnkodG9TdGF0ZSwgdG9QYXJhbXMpOmJvb2xlYW57XG4gICAgY29uc3QgJGhpc3RvcnkgPSB0aGlzLiRoaXN0b3J5XG4gICAgY29uc3QgaXNFdmVuID0gJGhpc3RvcnkubGVuZ3RoID4gdGhpcy5oaXN0b3J5UG9zKzFcbiAgICBjb25zdCBpc05hbWVNYXRjaCA9IGlzRXZlbiAmJiB0b1N0YXRlICYmIHRvU3RhdGUubmFtZT09JGhpc3RvcnlbdGhpcy5oaXN0b3J5UG9zKzFdLm5hbWVcbiAgICByZXR1cm4gaXNOYW1lTWF0Y2ggJiYgdGhpcy5pc1BhcmFtc01hdGNoKHRvUGFyYW1zLCAkaGlzdG9yeVt0aGlzLmhpc3RvcnlQb3MrMV0ucGFyYW1zKVxuICB9XG5cbiAgaXNGb3J3YXJkSGlzdG9yeSh0b1N0YXRlLCB0b1BhcmFtcyk6Ym9vbGVhbntcbiAgICBjb25zdCAkaGlzdG9yeSA9IHRoaXMuJGhpc3RvcnlcbiAgICBjb25zdCBpc0V2ZW4gPSAhdGhpcy5pc05leHRCYWNrTW9kZSAmJiB0aGlzLmhpc3RvcnlQb3MgJiYgJGhpc3RvcnkubGVuZ3RoPnRoaXMuaGlzdG9yeVBvc1xuICAgIGNvbnN0IGlzTmFtZU1hdGNoID0gaXNFdmVuICYmIHRvU3RhdGUgJiYgdG9TdGF0ZS5uYW1lPT0kaGlzdG9yeVt0aGlzLmhpc3RvcnlQb3MtMV0ubmFtZVxuICAgIHJldHVybiBpc05hbWVNYXRjaCAmJiB0aGlzLmlzUGFyYW1zTWF0Y2godG9QYXJhbXMsICRoaXN0b3J5W3RoaXMuaGlzdG9yeVBvcy0xXS5wYXJhbXMpXG4gIH1cblxuICBpc1BhcmFtc01hdGNoKHRvUGFyYW1zLCBvdGhlclBhcmFtcyk6Ym9vbGVhbntcbiAgICBpZiggIXRvUGFyYW1zIHx8ICFvdGhlclBhcmFtcyApeyAgICBcbiAgICAgIHJldHVybiBmYWxzZVxuICAgIH1cblxuICAgIGZvcihsZXQgeCBpbiB0b1BhcmFtcyl7XG4gICAgICBpZih0b1BhcmFtc1t4XSE9b3RoZXJQYXJhbXNbeF0pe1xuICAgICAgICByZXR1cm4gZmFsc2VcbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4gdHJ1ZVxuICB9XG5cbiAgcmVjb3JkU3RhdGVDaGFuZ2UodG9TdGF0ZSwgdG9QYXJhbXMpe1xuICAgIHRoaXMuY3VycmVudCA9IHsgcGFyYW1zOnRvUGFyYW1zLCBjb25maWc6dG9TdGF0ZSB9XG4gICAgbGV0IGlzRm9yd2FyZCA9IHRoaXMuaXNGb3J3YXJkSGlzdG9yeSh0b1N0YXRlLCB0b1BhcmFtcylcbiAgICBsZXQgaXNCYWNrSGlzdG9yeSA9IHRoaXMuaXNOZXh0QmFja0hpc3RvcnkgfHwgdGhpcy5pc0JhY2tIaXN0b3J5KHRvU3RhdGUsIHRvUGFyYW1zKVxuXG4gICAgaWYodGhpcy5pc09zQWN0aW9uICYmIHRoaXMuaXNUcmFwSGlzdG9yeSh0b1N0YXRlLCB0b1BhcmFtcykpe1xuICAgICAgaWYodGhpcy5pc0JhY2tNb2RlKXtcbiAgICAgICAgaXNGb3J3YXJkID0gZmFsc2VcbiAgICAgIH1lbHNle1xuICAgICAgICBpc0JhY2tIaXN0b3J5ID0gZmFsc2VcbiAgICAgIH1cbiAgICB9ZWxzZXtcbiAgICAgIHRoaXMuaXNCYWNrTW9kZSA9IHRoaXMuaXNOZXh0QmFja01vZGUgfHwgKHRoaXMuaXNPc0FjdGlvbiAmJiBpc0JhY2tIaXN0b3J5KVxuICAgIH1cblxuICAgIGNvbnN0ICRoaXN0b3J5ID0gdGhpcy4kaGlzdG9yeVxuXG4gICAgaWYoIXRvU3RhdGUpcmV0dXJuXG5cbiAgICBpZihpc0ZvcndhcmQpe1xuICAgICAgLS10aGlzLmhpc3RvcnlQb3NcbiAgICB9ZWxzZSBpZih0aGlzLmlzQmFja01vZGUpe1xuICAgICAgKyt0aGlzLmhpc3RvcnlQb3NcbiAgICB9ZWxzZXtcbiAgICAgIC8vY29uc3QgJHN0YXRlID0gdGhpcy4kc3RhdGUoKVxuICAgICAgdGhpcy5oaXN0b3J5UG9zID0gMFxuICAgICAgY29uc3QgaGlzdCA9IHtuYW1lOnRvU3RhdGUubmFtZSwgcGFyYW1zOnRvUGFyYW1zfVxuXG4gICAgICBpZiggIU9iamVjdC5rZXlzKHRvUGFyYW1zKS5sZW5ndGggKXtcbiAgICAgICAgZGVsZXRlIGhpc3QucGFyYW1zXG4gICAgICB9XG5cbiAgICAgICRoaXN0b3J5LnVuc2hpZnQoaGlzdClcbiAgICB9XG5cbiAgICB0aGlzLmlzTmV4dEJhY2tIaXN0b3J5ID0gZmFsc2VcbiAgfVxuXG4gIGdvQmFja1RvKG5hbWUsIHBhcmFtcyl7XG4gICAgdGhpcy5pc05leHRCYWNrTW9kZSA9IHRydWVcbiAgICB0aGlzLmlzTmV4dEJhY2tIaXN0b3J5ID0gdHJ1ZVxuICAgIHRoaXMuJHN0YXRlKCkuZ28obmFtZSwgcGFyYW1zKVxuICB9XG5cbiAgdHJ5QmFjayhuYW1lLCBwYXJhbXMpe1xuICAgIGlmKHRoaXMuJGhpc3RvcnkubGVuZ3RoKXtcbiAgICAgIHRoaXMuaXNOZXh0QmFja01vZGUgPSB0cnVlXG4gICAgICB0aGlzLmlzTmV4dEJhY2tIaXN0b3J5ID0gdHJ1ZVxuICAgICAgdGhpcy4kd2luZG93KCkuaGlzdG9yeS5iYWNrKClcbiAgICB9ZWxzZXtcbiAgICAgIHRoaXMuZ29CYWNrVG8obmFtZSwgcGFyYW1zKVxuICAgIH1cbiAgfVxuXG4gIHdhdGNoRG9jdW1lbnQoJGRvY3VtZW50KXtcbiAgICB0aGlzLndhdGNoRG9jQnlDYWxsYmFja3MoJGRvY3VtZW50LCB0aGlzLmdldERvY3VtZW50Q2FsbGJhY2tzKCkpXG4gIH1cblxuICBnZXREb2N1bWVudENhbGxiYWNrcygpe1xuICAgIGNvbnN0IGlzQmFja0J1dHRvbiA9ICgpPT57XG4gICAgICB0aGlzLmlzT3NBY3Rpb24gPSB0cnVlXG4gICAgfVxuICAgIFxuICAgIGNvbnN0IGlzTm90QmFja0J1dHRvbiA9ICgpPT57XG4gICAgICB0aGlzLmlzT3NBY3Rpb24gPSBmYWxzZVxuICAgIH1cblxuICAgIHJldHVybiB7XG4gICAgICBpc0JhY2tCdXR0b24gICAgOiBpc0JhY2tCdXR0b24sXG4gICAgICBpc05vdEJhY2tCdXR0b24gOiBpc05vdEJhY2tCdXR0b25cbiAgICB9XG4gIH1cblxuICB3YXRjaERvY0J5Q2FsbGJhY2tzKCRkb2N1bWVudCwgY2FsbGJhY2tzKXtcbiAgICAkZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignbW91c2VvdXQnLCBjYWxsYmFja3MuaXNCYWNrQnV0dG9uKVxuICAgIC8vJGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNlb3ZlcicsIGNhbGxiYWNrcy5tb3VzZW92ZXIpXG4gICAgJGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNlZG93bicsIGNhbGxiYWNrcy5pc05vdEJhY2tCdXR0b24pXG4gIH1cblxuICB1bndhdGNoRG9jQnlDYWxsYmFja3MoJGRvY3VtZW50LCBjYWxsYmFja3Mpe1xuICAgICRkb2N1bWVudC5yZW1vdmVFdmVudExpc3RlbmVyKCdtb3VzZW91dCcsIGNhbGxiYWNrcy5pc0JhY2tCdXR0b24pXG4gICAgJGRvY3VtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ21vdXNlb3ZlcicsIGNhbGxiYWNrcy5pc05vdEJhY2tCdXR0b24pXG4gICAgJGRvY3VtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ21vdXNlZG93bicsIGNhbGxiYWNrcy5pc05vdEJhY2tCdXR0b24pICAgIFxuICB9XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXRDdXJyZW50QnlBY3RpdmUoIEFjdGl2YXRlZFJvdXRlOkFjdGl2YXRlZFJvdXRlICl7XG4gIGxldCBwYXJlbnQgPSBBY3RpdmF0ZWRSb3V0ZVxuICBsZXQgdGFyZ2V0ID0gQWN0aXZhdGVkUm91dGVcbiAgd2hpbGUodGFyZ2V0LmZpcnN0Q2hpbGQpe1xuICAgIHBhcmVudCA9IHRhcmdldFxuICAgIHRhcmdldCA9IHRhcmdldC5maXJzdENoaWxkXG4gIH1cblxuICBjb25zdCBzbmFwc2hvdCA9IHRhcmdldC5zbmFwc2hvdCB8fCA8QWN0aXZhdGVkUm91dGVTbmFwc2hvdD57fVxuICBjb25zdCBwYXJlbnRTbmFwID0gcGFyZW50LnNuYXBzaG90IHx8IDxBY3RpdmF0ZWRSb3V0ZVNuYXBzaG90Pnt9XG5cbiAgcmV0dXJuIHtcbiAgICBBY3RpdmF0ZWRSb3V0ZTp0YXJnZXQsXG4gICAgY29uZmlnOjxSb3V0ZT4odGFyZ2V0LnJvdXRlQ29uZmlnIHx8IHRhcmdldFtcImNvbmZpZ1wiXSB8fCB0YXJnZXQpLFxuICAgIHBhcmFtczpzbmFwc2hvdC5wYXJhbXMsXG4gICAgcGFyZW50OntcbiAgICAgIEFjdGl2YXRlZFJvdXRlOnBhcmVudCxcbiAgICAgIGNvbmZpZzo8Um91dGU+KHBhcmVudC5yb3V0ZUNvbmZpZyB8fCB0YXJnZXRbXCJjb25maWdcIl0gfHwgcGFyZW50KSxcbiAgICAgIHBhcmFtczpwYXJlbnRTbmFwLnBhcmFtc1xuICAgIH1cbiAgfVxufSJdfQ==