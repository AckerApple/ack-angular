{"version":3,"sources":["../src/AckCache.ts"],"names":[],"mappings":"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","file":"AckCache.js","sourceRoot":"","sourcesContent":["import { Injectable } from '@angular/core';\nimport { AckOffline } from './AckOffline';\n\n/** Cache logic that provides timestamping and timingout using AckOffline as storage */\n export class AckCache extends AckOffline{\n  public prefix:string=\"offline-cache\"\n  \n  validate(data, config) {\n    const exists = data !== null && typeof data.cache !== \"undefined\"\n    return exists && !this.hasExpired(data._timestamp, data.expires||config.expires)\n  }\n\n  optionsKillCache(options){\n    return options.maxAge==null && options.expires==null ? false : true\n  }\n\n  hasMaxAged(stamp, maxAge){\n    const diff = Date.now() - maxAge\n    const expired = stamp<=diff\n    return maxAge && expired ? true : false\n  }\n\n  hasExpired(stamp, expires){\n    const expired = Date.now() >= new Date(expires).getTime()\n    return expires && expired ? true : false\n  }\n\n  param(name, options){\n    options = options || {}\n    options.param = options.param || []\n    return this.getCache(name, options)\n  }\n\n  /** aka param */\n  paramCache(name, options){\n    return this.param(name, options)    \n  }\n\n  paramSave(name, options){\n    return this.paramCache(name, options)\n    .then(items=>this.setCache(name,items))\n  }\n\n  /** aka paramSave */\n  paramSaveCache(name, options){\n    return this.paramSave(name, options)\n  }\n\n  /**\n    @options{\n      expires:Date||number - Exact date of expiration\n      maxAge:number - \n    }\n  */\n  cacheToReturn(name, data, options){\n    if(data['cache']==null && data['_timestamp']==null){\n      return Promise.resolve( data )//bad data catch\n    }\n\n    const expires = data['expires'] || options.expires\n    const maxAge = data['maxAge'] || options.maxAge\n    \n    if(options.allowExpired || (!expires && !maxAge)){\n      return Promise.resolve( data['cache'] )\n    }\n\n    const expired = expires && this.hasExpired(data['_timestamp'], expires)\n    const isMaxed = maxAge && this.hasMaxAged(data['_timestamp'], maxAge)\n\n    if(expired || isMaxed){\n      return this.selfDestructData(name,data)\n      .then(()=>{\n        if(options.param)return Promise.resolve( options.param )\n\n        /*const err = new Error('Cache expired for '+name)\n        err['code'] = 401\n        return Promise.reject( err )*/\n      })\n    }\n\n    return Promise.resolve( data['cache'] )\n  }\n\n  selfDestructData(name,data){\n    if( this.dataDestructReady(data) )return this.clear(name)\n    return Promise.resolve()\n  }\n\n  dataDestructReady(data){\n    const isMemMaxed = data['maxAge'] && this.hasMaxAged(data['_timestamp'], data['maxAge'])\n    const isMemExpired = data['expires'] && this.hasExpired(data['_timestamp'], data['expires'])\n    return isMemMaxed || isMemExpired\n  }\n\n  get(name, options?){\n    options = options || {expires:null}\n    \n    return super.get(name)\n    .then(data=>{\n      if(data){\n        return this.cacheToReturn(name, data, options)\n      }\n\n      if(options.param)return options.param\n\n      return\n    })\n  }\n\n  /** aka get */\n  getCache(name, options){\n    return this.get(name, options)\n  }\n\n  /** paste cache over cache, leave all else alone */\n  dataOptionsCache(allCache, options, cache){\n    options = options || {}\n    const newOptions = {}\n    \n    newOptions['_timestamp'] = Date.now()\n    if(options.expires)newOptions['expires'] = options.expires\n    if(options.maxAge)newOptions['maxAge'] = options.maxAge\n    \n    allCache = allCache && allCache.constructor!=String ? allCache : {}\n\n    Object.assign(allCache, newOptions)\n    if(cache && cache.constructor==String){\n      allCache['cache'] = cache\n    }else if(allCache['cache'] && allCache['cache'].constructor!=String){\n      Object.assign(allCache['cache'], cache)      \n    }else{\n      allCache['cache'] = cache\n    }\n\n    return allCache\n  }\n\n  set(name, cache, options?) {\n    options = options || {}\n    return super.get(name)\n    .then( allCache=>this.dataOptionsCache(allCache, options, cache) )\n    .then( data=>super.set(name, data) )\n  }\n\n  /** aka set */\n  setCache(name, cache, options?){\n    return this.set(name, options)\n  }\nstatic decorators: DecoratorInvocation[] = [\n{ type: Injectable },\n];\n/** @nocollapse */\nstatic ctorParameters: () => ({type: any, decorators?: DecoratorInvocation[]}|null)[] = () => [\n];\n}\ninterface DecoratorInvocation {\n  type: Function;\n  args?: any[];\n}\n"]}