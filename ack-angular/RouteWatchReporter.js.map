{"version":3,"sources":["../src/RouteWatchReporter.ts"],"names":[],"mappings":"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","file":"RouteWatchReporter.js","sourceRoot":"","sourcesContent":["//import { StateService,TransitionService,Transition } from \"ui-router-ng2\";\nimport { Router, NavigationEnd, ActivatedRoute } from '@angular/router';\nimport { Injectable } from '@angular/core';\n\n\n/** A stateful connection to ui-router history\n - .stateChange() with arguments MUST be called at every state change\n - Has 99% accuracy of knowing if OS back or forward button has been used\n   - Their is no web event for knowing if OS button is used. \n*/\n export class RouteWatchReporter{\n  public current : any = {}\n  public $history : any\n  public $state : any\n  public $window : any\n  \n  public historyPos : number = 0\n  public isNextBackMode : boolean = false\n  public isNextBackHistory : boolean = false\n  public isBackMode : boolean = false\n  public isOsAction : boolean = false\n  //public stateService : StateService\n  //public activatedRoute : ActivatedRoute\n  //static parameters = [[Router, ActivatedRoute]]\n\n  constructor(public router:Router, public activatedRoute:ActivatedRoute){\n    this.activatedRoute = activatedRoute\n    this.$window = ()=>window\n    this.$history = []\n\n    router.events.subscribe(event=>{\n      if(event.constructor==NavigationEnd){\n        const params = {}//COMING REALLY SOON\n        const current = this.getCurrent()\n        this.recordStateChange(current.config, current.params)\n      }\n    })\n\n    this.current = this.getCurrent()\n  }\n\n  getCurrent():any{\n    let target = this.activatedRoute\n    while(target.firstChild)target=target.firstChild\n    return {\n      config:target.routeConfig,\n      params:target.snapshot.params\n      //...target.routeConfig//may want to do away with this\n    }\n  }\n\n  getCurrentConfig():any{\n    let target = this.activatedRoute\n    while(target.firstChild)target=target.firstChild\n    return target.routeConfig\n  }\n\n  getCurrentParams():any{\n    let target = this.activatedRoute\n    while(target.firstChild)target=target.firstChild\n    return target.snapshot.params\n  }\n\n  isTrapHistory(toState, toParams){\n    return this.isBackHistory(toState, toParams) && this.isForwardHistory(toState, toParams)\n  }\n\n  isBackHistory(toState, toParams){\n    const $history = this.$history\n    const isEven = $history.length > this.historyPos+1\n    const isNameMatch = isEven && toState && toState.name==$history[this.historyPos+1].name\n    return isNameMatch && this.isParamsMatch(toParams, $history[this.historyPos+1].params)\n  }\n\n  isForwardHistory(toState, toParams){\n    const $history = this.$history\n    const isEven = !this.isNextBackMode && this.historyPos && $history.length>this.historyPos\n    const isNameMatch = isEven && toState && toState.name==$history[this.historyPos-1].name\n    return isNameMatch && this.isParamsMatch(toParams, $history[this.historyPos-1].params)\n  }\n\n  isParamsMatch(toParams, otherParams){\n    for(let x in toParams){\n      if(toParams[x]!=otherParams[x]){\n        return false\n      }\n    }\n    return true\n  }\n\n  recordStateChange(toState, toParams){\n    this.current = { params:toParams, config:toState }\n    let isForward = this.isForwardHistory(toState, toParams)\n    let isBackHistory = this.isNextBackHistory || this.isBackHistory(toState, toParams)\n\n    if(this.isOsAction && this.isTrapHistory(toState, toParams)){\n      if(this.isBackMode){\n        isForward = false\n      }else{\n        isBackHistory = false\n      }\n    }else{\n      this.isBackMode = this.isNextBackMode || (this.isOsAction && isBackHistory)\n    }\n\n    const $history = this.$history\n\n    if(isForward){\n      --this.historyPos\n    }else if(this.isBackMode){\n      ++this.historyPos\n    }else{\n      //const $state = this.$state()\n      this.historyPos = 0\n      const hist = {name:toState.name, params:toParams}\n\n      if( !Object.keys(toParams).length ){\n        delete hist.params\n      }\n\n      $history.unshift(hist)\n    }\n\n    this.isNextBackHistory = false\n  }\n\n  goBackTo(name, params){\n    this.isNextBackMode = true\n    this.isNextBackHistory = true\n    this.$state().go(name, params)\n  }\n\n  tryBack(name, params){\n    if(this.$history.length){\n      this.isNextBackMode = true\n      this.isNextBackHistory = true\n      this.$window().history.back()\n    }else{\n      this.goBackTo(name, params)\n    }\n  }\n\n  watchDocument($document){\n    this.watchDocByCallbacks($document, this.getDocumentCallbacks())\n  }\n\n  getDocumentCallbacks(){\n    const isBackButton = ()=>{\n      this.isOsAction = true\n    }\n    \n    const isNotBackButton = ()=>{\n      this.isOsAction = false\n    }\n\n    return {isBackButton:isBackButton, isNotBackButton:isNotBackButton}\n  }\n\n  watchDocByCallbacks($document, callbacks){\n    $document.addEventListener('mouseout', callbacks.isBackButton)\n    //$document.addEventListener('mouseover', callbacks.mouseover)\n    $document.addEventListener('mousedown', callbacks.isNotBackButton)\n  }\n\n  unwatchDocByCallbacks($document, callbacks){\n    $document.removeEventListener('mouseout', callbacks.isBackButton)\n    $document.removeEventListener('mouseover', callbacks.isNotBackButton)\n    $document.removeEventListener('mousedown', callbacks.isNotBackButton)    \n  }\nstatic decorators: DecoratorInvocation[] = [\n{ type: Injectable },\n];\n/** @nocollapse */\nstatic ctorParameters: () => ({type: any, decorators?: DecoratorInvocation[]}|null)[] = () => [\n{type: Router, },\n{type: ActivatedRoute, },\n];\n}\ninterface DecoratorInvocation {\n  type: Function;\n  args?: any[];\n}\n"]}