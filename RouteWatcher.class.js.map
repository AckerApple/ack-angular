{"version":3,"file":"RouteWatcher.class.js","sourceRoot":"","sources":["src/RouteWatcher.class.ts"],"names":[],"mappings":"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","sourcesContent":["import { StateService,TransitionService,Transition } from \"ui-router-ng2\";\n\n/** A stateful connection to ui-router history\n - .stateChange() with arguments MUST be called at every state change\n - Has 99% accuracy of knowing if OS back or forward button has been used\n   - Their is no web event for knowing if OS button is used. \n*/\nexport class RouteWatcher{\n  public $history : any\n  public $state : any\n  public $window : any\n  \n  public historyPos : number = 0\n  public isNextBackMode : boolean = false\n  public isNextBackHistory : boolean = false\n  public isBackMode : boolean = false\n  public isOsAction : boolean = false\n  public stateService : StateService\n\n  static parameters = [[StateService],[TransitionService]]\n\n  constructor(public StateService:StateService, public TransitionService:TransitionService){\n    const stateHistory = []\n    this.$state = ()=>StateService\n    this.$window = ()=>window\n    //this.$history = ()=>stateHistory\n    this.$history = stateHistory\n\n    TransitionService.onStart({to:'*'}, (transition:Transition)=>{\n      this.recordStateChange(transition.targetState().$state(), transition.targetState().params())\n      //this.recordStateChange(transition._targetState._definition, transition._targetState._params)\n    })\n  }\n\n  isTrapHistory(toState, toParams){\n    return this.isBackHistory(toState, toParams) && this.isForwardHistory(toState, toParams)\n  }\n\n  isBackHistory(toState, toParams){\n    //const $history = this.$history()\n    const $history = this.$history\n    const isEven = $history.length > this.historyPos+1\n    const isNameMatch = isEven && toState && toState.name==$history[this.historyPos+1].name\n    return isNameMatch && this.isParamsMatch(toParams, $history[this.historyPos+1].params)\n  }\n\n  isForwardHistory(toState, toParams){\n    //const $history = this.$history()\n    const $history = this.$history\n    const isEven = !this.isNextBackMode && this.historyPos && $history.length>this.historyPos\n    const isNameMatch = isEven && toState && toState.name==$history[this.historyPos-1].name\n    return isNameMatch && this.isParamsMatch(toParams, $history[this.historyPos-1].params)\n  }\n\n  isParamsMatch(toParams, otherParams){\n    for(let x in toParams){\n      if(toParams[x]!=otherParams[x]){\n        return false\n      }\n    }\n    return true\n  }\n\n  /**\n    @event Object - not used\n    @toState Object{name} - required\n    @toParams Object{} - only recorded to history, not used otherwise\n    @fromState Object{name} - not used\n    @fromParams Object{} - not used\n  */\n  /*\n  stateChange(event, toState, toParams, fromState, fromParams){\n    this.recordStateChange(toState, toParams)\n  }*/\n\n  recordStateChange(toState, toParams){\n    let isForward = this.isForwardHistory(toState, toParams)\n    let isBackHistory = this.isNextBackHistory || this.isBackHistory(toState, toParams)\n\n    if(this.isOsAction && this.isTrapHistory(toState, toParams)){\n      if(this.isBackMode){\n        isForward = false\n      }else{\n        isBackHistory = false\n      }\n    }else{\n      this.isBackMode = this.isNextBackMode || (this.isOsAction && isBackHistory)\n    }\n\n\n//console.log('this.isOsAction',this.isNextBackMode,isBackHistory,this.isOsAction,this.isBackMode)\n\n    //const $history = this.$history()\n    const $history = this.$history\n    //if($history.length)this.last = $history[this.historyPos]\n\n    if(isForward){\n      --this.historyPos\n    }else if(this.isBackMode){\n      ++this.historyPos\n    }else{\n      const $state = this.$state()\n      this.historyPos = 0\n      \n      const hist = {name:toState.name, params:toParams}\n\n      if( !Object.keys(toParams).length ){\n        delete hist.params\n      }\n\n      $history.unshift(hist)\n    }\n\n    /*if($history.length > this.historyPos+1){\n      this.back = $history[this.historyPos+1]\n    }*/\n\n    this.isNextBackHistory = false\n//console.log('this.isOsAction',isBackHistory,this.isOsAction,this.isBackMode)\n  }\n\n  goBackTo(name, params){\n    this.isNextBackMode = true\n    this.isNextBackHistory = true\n    this.$state().go(name, params)\n  }\n\n  tryBack(name, params){\n    if(this.$history.length){\n      this.isNextBackMode = true\n      this.isNextBackHistory = true\n      this.$window().history.back()\n      /*\n      console.log('go back', this.historyPos, this.stateHistory.length, this.stateHistory)\n      this.$state.go(this.stateHistory[this.historyPos].name, this.stateHistory[this.historyPos].params)\n      */\n    }else{\n      this.goBackTo(name, params)\n    }\n  }\n\n  watchDocument($document){\n    this.watchDocByCallbacks($document, this.getDocumentCallbacks())\n  }\n\n  getDocumentCallbacks(){\n    const isBackButton = ()=>{\n      this.isOsAction = true\n    }\n    \n    const isNotBackButton = ()=>{\n      this.isOsAction = false\n    }\n\n    return {isBackButton:isBackButton, isNotBackButton:isNotBackButton}\n  }\n\n  watchDocByCallbacks($document, callbacks){\n    $document.addEventListener('mouseout', callbacks.isBackButton)\n    //$document.addEventListener('mouseover', callbacks.mouseover)\n    $document.addEventListener('mousedown', callbacks.isNotBackButton)\n  }\n\n  unwatchDocByCallbacks($document, callbacks){\n    $document.removeEventListener('mouseout', callbacks.isBackButton)\n    $document.removeEventListener('mouseover', callbacks.isNotBackButton)\n    $document.removeEventListener('mousedown', callbacks.isNotBackButton)    \n  }\n}"]}